@isTest
private class ANG_ISSP_MailIEPStatInProgressToOpenTest {

	@testSetup static void createData() {
	
	    IATA_ISO_Country__c ctry = new IATA_ISO_Country__c (Name='France',ISO_Code__c='FR', Region__c = 'Europe')  ;
        insert ctry ;
		
		Account acc = ISSP_ObjectFactory.createNewAccount();  
		acc.Location_Type__c = 'HO';
		acc.Location_Class__c = 'P';
        acc.IATA_ISO_Country__c = ctry.Id;

		insert acc;

		Account acc2 = ISSP_ObjectFactory.createNewAccount();
		acc2.Location_Type__c = 'BR';
		acc2.Location_Class__c = 'P';
		acc2.ParentId = acc.id;
		acc2.Top_Parent__c = acc.id;
		acc2.Name = 'Test1';		
		acc2.IATA_ISO_Country__c = ctry.Id;

		insert acc2;

		Contact contact = ISSP_ObjectFactory.createNewContact();
		contact.AccountId = acc2.Id;	
		insert contact;

		Connected_App_Roles__c car = new Connected_App_Roles__c(
			Name = 'ANG Test2',
			Connected_App__c = 'IATA EasyPay (EDENRED)',
			Permission_set_SSO__c = 'IATA EasyPay (EDENRED)',
			Role__c = 'IEP Admin',
			Default_User_Role__c = true,
			Min_Users_With_Role__c = 2
		);
		insert car;

		Portal_Applications__c app = new Portal_Applications__c(Name = 'IATA EasyPay');
		insert app;
		
		Portal_Application_Right__c par = new Portal_Application_Right__c(
			Contact__c = contact.Id, 
			Portal_Application__c = app.Id,
			Right__c = 'Access Granted',
			ANG_Portal_Service_Role__c = 'IEP Admin'
		);
		insert par;

		System.runAs([SELECT Id FROM User WHERE Id = :UserInfo.getUserId()][0]){

			insert new PermissionSet(
				Name = 'ANG_App'
				, Label = 'ANG_App'
			);
			
			insert new User(
				Alias = 'dsfsdfds', 
				Email = contact.email, 
				Emailencodingkey = 'UTF-8', 
				Firstname = contact.firstName, 
				Lastname = contact.lastname, 
				Languagelocalekey = 'en_US', 
				Localesidkey = 'en_US', 
				ContactId = contact.Id,
				Timezonesidkey = 'Asia/Dubai',
				Username = contact.email+'dfgdf',
				PortalRole = 'Manager',
				CommunityNickname = contact.email.substring(0, contact.email.indexOf('@'))+Datetime.now().formatLong().substring(10,15),
				ProfileId = ISSP_Constant.TEST_User_ProfileID,
				IsActive = true
			);

		}
	}

	static testMethod void test1() {

		Integer emailbefore = Limits.getEmailInvocations();

		Account a = [Select id From Account Where Name = 'Test1' Limit 1];

		ANG_ISSP_MailIEPStatusInProgressToOpen.SendMailInProgressToOpenRequest request = new ANG_ISSP_MailIEPStatusInProgressToOpen.SendMailInProgressToOpenRequest();

		request.accountId = a.id;

		List<ANG_ISSP_MailIEPStatusInProgressToOpen.SendMailInProgressToOpenRequest> l = new List<ANG_ISSP_MailIEPStatusInProgressToOpen.SendMailInProgressToOpenRequest>();
		l.add(request);

		ANG_ISSP_MailIEPStatusInProgressToOpen.SendMailInProgressToOpen(l);

		System.assertNotEquals(emailbefore, Limits.getEmailInvocations());
	}
}