public class AMS_AgencyAChangeCodeHandler {
    public static boolean firstRun{
        get{
            if(firstRun == null) firstRun = true;
            return firstRun;
        }
        set;
    }
     
    public static void handleAfterInsert(List<Agency_Applied_Change_code__c> aacc) {
        verifyActiveAACCuniqueness(aacc);
        Id irregRtId = AMS_Utils.getId('Agency_Applied_Change_code__c', 'Irregularities');
        List<Agency_Applied_Change_code__c> aaccToBeProcessed = new List<Agency_Applied_Change_code__c>();
        for(Agency_Applied_Change_Code__c aaccRecord : aacc)
        {
            if(aaccRecord.RecordTypeId == irregRtId)
            {
                aaccToBeProcessed.add(aaccRecord);
            }
        }
        AMS_Irregularities_Utils.CalculateAccumulatedIrregularitiesFromChangeCode(aaccToBeProcessed);
    }

    public static void handleAfterUpdate(List<Agency_Applied_Change_code__c> aacc) {
        verifyActiveAACCuniqueness(aacc);
        Id irregRtId = AMS_Utils.getId('Agency_Applied_Change_code__c', 'Irregularities');
        List<Agency_Applied_Change_code__c> aaccToBeProcessed = new List<Agency_Applied_Change_code__c>();
        for(Agency_Applied_Change_Code__c aaccRecord : aacc)
        {
            if(aaccRecord.RecordTypeId == irregRtId)
            {
                aaccToBeProcessed.add(aaccRecord);
            }
        }
        AMS_Irregularities_Utils.CalculateAccumulatedIrregularitiesFromChangeCode(aaccToBeProcessed);
    }

    public static void handleBeforeInsert(List<Agency_Applied_Change_code__c> aacc){
        migrateFieldsFromStagingToAccount(aacc);
    }
    
    
    //DTULLO: NEED to bulkify it. Now change codes are bring via dataloader from aims. batch size = 50.
    //because of a requirement, they are coming as active. so, if more than 1 is coming, we should check inside the trigger to set them to false
    //Use of field "Created_Date_To_Show__c" to set only the last one as active.
    public static void verifyActiveAACCuniqueness(List<Agency_Applied_Change_code__c> aaccodes){
        map<id, list<Agency_Applied_Change_code__c>> mapLastAACC = new map<id, list<Agency_Applied_Change_code__c>>();
        
        List<Agency_Applied_Change_code__c> aACCtoUpdate = new List<Agency_Applied_Change_code__c>();

        Set<Id> agencyIds = new Set<Id>();

        for(Agency_Applied_Change_code__c aacc : aaccodes){
            //DTULLO: get ALL agencies involved
            //if(aacc.Active__c){
                agencyIds.add(aacc.Account__c);
            //}
        }

        if(agencyIds.size() > 0){
            List<Agency_Applied_Change_code__c> allCCPerAgency = [select id, Created_Date_To_Show__c, Active__c , Account__c 
                                                                  from Agency_Applied_Change_code__c
                                                                  where Account__c IN :agencyIds
                                                                  order by Account__c, Created_Date_To_Show__c desc];
            for(Agency_Applied_Change_code__c aac: allCCPerAgency){
                if(mapLastAACC.containsKey(aac.Account__c)){
                    list<Agency_Applied_Change_code__c> ls = mapLastAACC.get(aac.Account__c);
                    if(aac.active__c == true){
                        aac.Active__c = false;
                        ls.add(aac);
                        mapLastAACC.put(aac.Account__c, ls);
                    }
                }else{
                    system.debug('DTULLO: setting the last as active');
                    aac.Active__c = true;
                    mapLastAACC.put(aac.Account__c, new list<Agency_Applied_Change_code__c>{aac});
                }
            }
            
            //do the update
            if(!mapLastAACC.isEmpty()){
                system.debug('DTULLO map is not empty');
                for(id acc:mapLastAACC.keyset())
                    aACCtoUpdate.addAll(mapLastAACC.get(acc));
                
                
                if(!aACCtoUpdate.isEmpty()){
                    system.debug('DTULLO acctoUpdate not empty');
                    for(Agency_Applied_Change_code__c c:aACCtoUpdate){
                        system.debug('DTULLO --> ' + c);
                    }
                    update aACCtoUpdate;
                }
            }
            /*
            DTULLO: FULLY COMMENTED. Need to set only the latest one as active
            List<Agency_Applied_Change_code__c> elementsToUpdate = new List<Agency_Applied_Change_code__c>();
            
            for(Agency_Applied_Change_code__c aacc : [select id, Active__c , Account__c from Agency_Applied_Change_code__c where Active__c = true AND Account__c IN :agencyIds]){
        
                if(Trigger.newMap.containsKey(aacc.id) == false) {
                    
                    aacc.Active__c = false;
                    elementsToUpdate.add(aacc);
                }   
            }
        
            if(elementsToUpdate.size() > 0){
                
                update elementsToUpdate;
            }*/
        }

    }


    public static void migrateFieldsFromStagingToAccount(List<Agency_Applied_Change_code__c> aacc){

        // this method aaplies only to change codes that have an OSCAR filled. That OSCAR must be of record type NEW and have process of type NEW.HO.1.0, NEW.BR OR NEW.BR.ABROAD
        // when creating a change code of type FIN or DIS, it should copy the information from staging Area (AMS_Pax_Accreditation_Form__c) into Master Data (Account)

        Id rtNew = Schema.SObjectType.AMS_OSCAR__c.getRecordTypeInfosByName().get('NEW').getRecordTypeId();
        Id rtCorr = Schema.SObjectType.AMS_OSCAR__c.getRecordTypeInfosByName().get('CORRECTION').getRecordTypeId();

        Set<Id> oscarIds = new Set<Id>();

        for(Agency_Applied_Change_code__c code: aacc){
            if(code.OSCAR__c != null && ( code.change_code__c == 'FIN' || code.change_code__c == 'DIS' || code.change_code__c == 'COR')){
                oscarIds.add(code.OSCAR__c);
            }
        }

        //let's first find the OSCAR that need to be migrated
        List<AMS_OSCAR__c> oscarsToCopyData = new List<AMS_OSCAR__c>();

        //aacclist = [SELECT ID, OSCAR__c, OSCAR__r.Account__c , OSCAR__r.AMS_Online_Accreditation__c from Agency_Applied_Change_code__c where id in :aaccIds and OSCAR__r.RecordTypeId = :rtNew and OSCAR__r.Process__c in ('NEW.HO.1.0','NEW.BR','NEW.BR.ABROAD') ];

        oscarsToCopyData = [SELECT ID, Account__c, AMS_Online_Accreditation__c, RecordTypeId 
                            FROM AMS_OSCAR__C 
                            WHERE Id in :oscarIds and (RecordTypeId = :rtNew OR RecordTypeId =:rtCorr) 
                                    and Process__c in ('NEW.HO.1.0','NEW.BR','NEW.BR.ABROAD', 'CORRECTION.1.0')  ];

        if(!oscarsToCopyData.isEmpty()){
            AMS_Utils.copyDataToAccount(oscarsToCopyData);
        }else{
            System.debug('Nothing to migrate here.');
        }

        
    }

}