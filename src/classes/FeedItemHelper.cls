public with sharing class FeedItemHelper {
	
	/*
	 *  This method checks that hashtags exist in the feed items attached to Accounts, to ensure that topics have
	 *  been used. Otherwise, an error is thrown.
	 *  Validation put in place for the Account Management project.
	 */
	public static void CheckPostTopics(list<FeedItem> lstTriggerNew) {
		String strAcceptedValues = '';

		for (AMP_Account_Topics__c at : AMP_Account_Topics__c.getAll().Values()) {
			strAcceptedValues += (strAcceptedValues == '' ? '' : ', ') + at.Name;
		}

		// get the accounts of interest to which the feed items are linked - we only apply the logic to Airline HQ accounts that are IATA Members
		set<Id> setRelatedAccountIds = new set<Id>();
		for (FeedItem fi : lstTriggerNew) {

		Pattern p = Pattern.compile('#\\w+(?s).*');
		Matcher regexMatcher = p.matcher(fi.body.toUpperCase());

 	   		if (String.valueOf(fi.ParentId).startsWith('001') 
 	   			&& !regexMatcher.matches() 
 	   		 	&& fi.Type == 'TextPost') {
	 	   			setRelatedAccountIds.add(fi.ParentId);
 	   		}
 	   	}
		if (!setRelatedAccountIds.isEmpty()) {

			map<Id, Account> mapAccountsPerId = new map<Id, Account>([SELECT Id FROM Account
																		WHERE Id IN :setRelatedAccountIds
																		AND RecordType.DeveloperName = 'IATA_Airline'
																		AND Membership_status__c = 'IATA member']);

			// if there are IATA member Airline HQ accounts that have invalid feeditems posted to them, raise the error
			if (!mapAccountsPerId.values().isEmpty()) {


				for (FeedItem fi : lstTriggerNew) {
 	   				fi.addError ('Please use hashtags (#) to define the topic(s) of your post.\r\nYou can choose one or more of the following topics:\r\n' + strAcceptedValues);
					// if (String.valueOf(fi.ParentId).startsWith('001') && !fi.Body.contains('#') && fi.Type == 'TextPost') {
					// }
				}
 	   		}
 	   	}
	}
}