<apex:page controller="MITA_PortalAgreementsCtrl" standardStylesheets="true" showHeader="false" sidebar="false"  applyBodyTag="false" applyHtmlTag="false">
<html>
 <c:ISSP_Header_sansJQuery />    
 <body>
    <div class="container">
       	
		
        <c:ISSP_CustomNavigation />
        <c:Loading />
		<apex:includescript value="//cdn.datatables.net/1.10.4/js/jquery.dataTables.min.js" />
		<apex:stylesheet value="//cdn.datatables.net/1.10.4/css/jquery.dataTables.css" />
		
		<apex:form >
		<apex:outputPanel id="messages" >
			<apex:pageMessages />
		</apex:outputPanel>
		</apex:form>
		
		<style>
			li.topmenu{margin-left:0;}
			.firstColumn{width:30%; vertical-align:top;}
			.secondColumn{width:70%; vertical-align:top;}
		</style>
		
		
		<apex:panelGrid columns="2" columnClasses="firstColumn, secondColumn">
	       
	       <!-- BLOCK IN THE LEFT FOR THE LIST OF ALL THE AIRLINES -->
	       <apex:pageBlock title="Choose an airline" id="chooseAirlineBlock" >
				<apex:form >
					Display only MITA Members 
					<input type="checkbox" id="OnlyMITAAirlines" checked="checked"/><br/>
					Search on 
					<select id="filterOn" size="1">
						<option value="code">Code</option>
						<option value="name">Name</option>
						<option value="all">All</option>
					</select>
					<table id="airlinesTable" class="display">
						<thead>
							<tr>
								<th>DCode</th>
								<th>NCode</th>
								<th>Airline Name</th>
								<th>MITA member</th>
							</tr>
						</thead>
						<tbody>
							<apex:outputText value="{!AccountTable}" escape="false" />
						</tbody>
					</table>
					<apex:inputHidden value="{!accountid}" id="accountid"/>
					<apex:actionFunction id="selectAccount" name="selectAccount" action="{!selectAccount}" rerender="column2" status="Loading"/> 
				</apex:form>
			</apex:pageBlock>
	        
	        
	    
	
	
			<!-- PANEL IN THE RIGHT WITH THE DETAILS OF THE CHOSEN AIRLINE -->
			<apex:outputPanel id="column2" style="width:40%">
				<script>$('#canChangeTab').val('true')</script>
				
				<apex:outputPanel id="accountInfoPanel">
					<apex:form >
					
					<apex:pageBlock rendered="{!chosenAccount}" >
						<h2>{!acc.Name} / {!acc.Airline_designator__c} / {!acc.IATACode__c}</h2><br/><br/>
						<!-- CUSTOM TAB HEADER -->
						<div class="mytabheadercontainer" >
							<div class="mytabheader active" id="hdAirline" onclick="showTab('Airline')">Airline</div>
							<div class="mytabheader" id="hdMITA" onclick="showTab('MITA')">MITA</div>
							<div class="mytabheader" id="hdBIETA" onclick="showTab('BIETA')">BIETA</div>
							<div class="mytabheader" id="hdContacts" onclick="showTab('Contacts')">Contacts</div>
						</div>
						
						<!-- TAB CONTAINER -->
						 <div class="mytabcontainer">
						 
						 	<!-- FIRST TAB: AIRLINE -->
							<div class="mytab active" id="tabAirline">
								<apex:pageBlockSection title="Airline information">
									<apex:outputField value="{!acc.Airline_designator__c}" />
									<apex:outputField value="{!acc.IATACode__c}" />
									<apex:outputField value="{!acc.Membership_status__c}" />
									<apex:outputField value="{!acc.ICH_Member__c}" />
									<apex:outputField value="{!acc.Due_Diligence_Status__c}" />
									<apex:outputField value="{!acc.ACH_Member__c}" />
								</apex:pageBlockSection>
								<apex:pageBlockSection id="viewAccountMITAInfo" title="Participant dates of MITA agreement">
									<apex:outputField value="{!acc.MITA_Member__c}" styleclass="outMITAMember"/>
									<apex:outputField value="{!acc.MITA_Currency__c}" />
									
									<apex:outputField value="{!acc.MITA_IATA_Interline_Cargo__c}" />
									<apex:outputField value="{!acc.MITA_IATA_Interline_Passenger__c}" />
									
									<apex:outputField value="{!acc.MITA_IATA_Interline_Cargo_Charges__c}" />
									<apex:outputField value="{!acc.MITA_IATA_Interline_Passenger_Charges__c}" />
									
									<apex:outputField value="{!acc.MITA_IATA_Interline_Cargo_Claims__c}" />
									<apex:pageBlockSectionItem />
									
									<apex:outputField value="{!acc.MITA_IATA_Interline_Pass_Art3_Joined__c}" />
									<apex:outputField value="{!acc.MITA_IATA_Interline_Art3_Excepted_Status__c}" />
	
	 
									<apex:outputField value="{!acc.MITA_One_way_Pass_Issuing_Airline__c}" />
									<apex:outputField value="{!acc.MITA_One_way_Pass_Participating__c}" />
									
								</apex:pageBlockSection>
								
								<apex:pageBlockSection id="viewAccountBIETAInfo" title="Participant dates of BIETA agreement">
									<apex:outputField value="{!acc.BIETA_Member__c}"/>
									<apex:outputField value="{!acc.BIETA_Bilateral_Date__c}" />
										
									<apex:outputField value="{!acc.BIETA_One_way_Electronic_Issuing_Airline__c}" />
									<apex:outputField value="{!acc.BIETA_One_way_Electronic_Participating__c}" />
									
									<apex:outputField value="{!acc.BIETA_One_way_Intermodal_Issuing_Airline__c}" />
									<apex:outputField value="{!acc.BIETA_One_way_Intermodal_Participating__c}" />
									
								</apex:pageBlockSection>
							
							
							</div>
						 
						 	<!-- SECOND TAB: MITA -->
							<div class="mytab" id="tabMITA">
							
								<!-- SECTION FOR MITA AGREEMENT INFO -->
								<apex:outputPanel id="MITAagreementInfoPanel">
									<apex:pageBlockSection title="Agreement details" columns="1" rendered="{!NOT(chosenMITAAgreement)}">
										<apex:pageBlockSectionItem />
										<apex:pageBlockSectionItem />
										<apex:pageBlockSectionItem />
									</apex:pageBlockSection>
								
									<apex:pageBlockSection id="viewMITAAgreementInfo" rendered="{!chosenMITAAgreement}" title="Agreement details">
										<apex:pageBlockSectionItem >
											<apex:outputLabel for="theLink" value="Airline" />
											<apex:commandLink id="theLink" 
															  value="{!IF(agr.Airline_1__c = acc.Id,agr.Airline_2__r.Name, agr.Airline_1__r.Name)}" 
															  onclick="$('[id$=accountid]').val('{!IF(agr.Airline_1__c = acc.Id,agr.Airline_2__c, agr.Airline_1__c)}'); selectAccount();" 
															  rerender="messages"/>	
										</apex:pageBlockSectionItem>
										<apex:pageBlockSectionItem />
										<apex:outputField value="{!agr.Agreement_type__c}" />
										
										<apex:outputField value="{!agr.Effective_date__c}" />
										<apex:outputField value="{!agr.Withdrawal_Request_Reception_Date__c}" />
										<apex:outputField value="{!agr.Cancellation_date__c}" />
										
									</apex:pageBlockSection>
									
								</apex:outputPanel>
								
								<!-- SECTION FOR MITA AGREEMENTS -->
								<apex:inputHidden value="{!MITAagreementid}" id="MITAagreementid"/>
								<apex:actionFunction id="selectMITAAgreement" name="selectMITAAgreement" action="{!selectMITAAgreement}" rerender="MITAagreementInfoPanel,messages" status="Loading"/> 
			
								<apex:pageBlockSection title="Agreements" columns="1" id="MITAagreementSearchPanel">
									<apex:outputPanel >
										<div style="float:left" >
											<apex:outputText value="{!MITAagreementTypes}" escape="false" />
										</div>
										<div style="float:right" >
											<input type="radio" name="MITAagreementactive" class="agreementactivefilter" data-type="MITA" data-value=" " />Show all the agreements<br/>
											<input type="radio" name="MITAagreementactive" class="agreementactivefilter" data-type="MITA" data-value="true" checked="checked"/>Active agreemnents<br/>
											<input type="radio" name="MITAagreementactive" class="agreementactivefilter" data-type="MITA" data-value="false" />Inactive agreemnents<br/>
										</div>
											
										
										<br style="clear:both"/>
										
										<table id="MITAagreementsTable" class="agreementsTable" >
											<thead>
												<tr>
													<th>Code</th>
													<th>Airline</th>
													<th>Agreement type</th>
													<th>Effective date</th>
													<th>Active</th>
												</tr>
											</thead>
											<tbody>
												<apex:outputText value="{!MITAAgreementTable}" escape="false" />
											</tbody>
										</table>
										<script>
											initAgreementTable(true);
										</script>
										<br/><br/>
									</apex:outputPanel>
								</apex:pageBlockSection>
								
							</div>
	
	        
							<!-- THIRD TAB: BIETA -->
							 <div class="mytab" id="tabBIETA">
								
								<!-- SECTION FOR BIETA AGREEMENT INFO -->
								<apex:outputPanel id="BIETAagreementInfoPanel">
									<apex:pageBlockSection title="Agreement details" columns="1" rendered="{!NOT(chosenBIETAAgreement)}">
										<apex:pageBlockSectionItem />
										<apex:pageBlockSectionItem />
										<apex:pageBlockSectionItem />
									</apex:pageBlockSection>
									
									<apex:pageBlockSection id="viewBIETAAgreementInfo" rendered="{!chosenBIETAAgreement}" title="Agreement details">
										<apex:pageBlockSectionItem >
											<apex:outputLabel for="theLink" value="Airline" />
											<apex:commandLink id="theLink" 
															  value="{!IF(agr.Airline_1__c = acc.Id,agr.Airline_2__r.Name, agr.Airline_1__r.Name)}" 
															  onclick="$('[id$=accountid]').val('{!IF(agr.Airline_1__c = acc.Id,agr.Airline_2__c, agr.Airline_1__c)}'); selectAccount();" 
															  rerender="messages"/>	
										</apex:pageBlockSectionItem>
										<apex:pageBlockSectionItem />
	
										<apex:outputField value="{!agr.Agreement_type__c}" />
										<apex:outputField value="{!agr.Withdrawal_Request_Reception_Date__c}" />
	
										<apex:outputField value="{!agr.Effective_date__c}" />
										<apex:outputField value="{!agr.Cancellation_date__c}" />
										
									</apex:pageBlockSection>
									
								</apex:outputPanel>
								
								
								<!-- SECTION FOR BIETA AGREEMENTS -->
								<apex:inputHidden value="{!BIETAagreementid}" id="BIETAagreementid"/>
								<apex:actionFunction id="selectBIETAAgreement" name="selectBIETAAgreement" action="{!selectBIETAAgreement}" rerender="BIETAagreementInfoPanel,messages" status="Loading"/> 
			
								<apex:pageBlockSection title="Agreements" columns="1" id="BIETAagreementSearchPanel">
									<apex:outputPanel >
										<div style="float:left" >
											<apex:outputText value="{!BIETAagreementTypes}" escape="false" />
										</div>
										<div style="float:right" >
											<input type="radio" name="BIETAagreementactive" class="agreementactivefilter" data-type="BIETA" data-value=" " />Show all the agreements<br/>
											<input type="radio" name="BIETAagreementactive" class="agreementactivefilter" data-type="BIETA" data-value="true" checked="checked"/>Active agreemnents<br/>
											<input type="radio" name="BIETAagreementactive" class="agreementactivefilter" data-type="BIETA" data-value="false" />Inactive agreemnents<br/>
										</div>
											
										
										<br style="clear:both"/>
										
										
										<table id="BIETAagreementsTable" class="agreementsTable" >
											<thead>
												<tr>
													<th>Code</th>
													<th>Airline</th>
													<th>Agreement type</th>
													<th>Effective date</th>
													<th>Active</th>
												</tr>
											</thead>
											<tbody>
												<apex:outputText value="{!BIETAAgreementTable}" escape="false" />
											</tbody>
										</table>
										<script>
											initAgreementTable(false);
										</script>
										<br/><br/>
									</apex:outputPanel>
								</apex:pageBlockSection>
							
							</div>
							
							<!-- FOURTH TAB: CONTACTS -->
							<div class="mytab "  id="tabContacts">
								<apex:pageBlockSection id="contactList" title="Airline Contacts" columns="1" >
									<apex:pageBlockTable value="{!contacts}" var="c" onRowClick="clickOnContact('{!c.Id}')">
										<apex:column headerValue="Name">
											<apex:outputField value="{!c.Name}" />
										</apex:column>
										<apex:column headerValue="Title">
											<apex:outputField value="{!c.Title}" />
										</apex:column>
										<apex:column headerValue="Email">
											<apex:outputField value="{!c.Email}" />
										</apex:column>
										<apex:column headerValue="Contact Type">
											<apex:outputField value="{!c.MITA_Contact_Type__c}" />
										</apex:column>
										<apex:column headerValue="Teletype">
											<apex:outputField value="{!c.MITA_Teletype__c}" />
										</apex:column>
									</apex:pageBlockTable>
								</apex:pageBlockSection>
								
								<br/><br/>
								
								<!-- SECTION WITH CONTACT DETAILS -->
								<apex:outputPanel id="contactDetailPanel">
									<apex:pageBlockSection title="Contact detail" rendered="{!chosenContact}">
										<apex:outputField value="{!c.Salutation}" />
										<apex:pageBlockSectionItem />
										
										<apex:outputField value="{!c.Name}" />
										<apex:outputField value="{!c.Status__c}" />
										
										<apex:outputField value="{!c.Title}" />
										<apex:outputField value="{!c.Email}" />
		
										<apex:outputField value="{!c.Phone}" />
										<apex:outputField value="{!c.Fax}" />
										
										<apex:outputField value="{!c.MITA_Contact_Type__c}" />
										<apex:outputField value="{!c.MITA_Teletype__c}" />
	
										<apex:outputField value="{!c.OtherStreet}" />
										<apex:outputField value="{!c.OtherCity}" />
										<apex:outputField value="{!c.OtherPostalcode}" />
										<apex:outputField value="{!c.OtherState}" />
										<apex:outputField value="{!c.OtherCountry}" />
										
									</apex:pageBlockSection>
									
									
									
									<apex:inputHidden value="{!contactid}" id="contactid"/>
									<apex:actionFunction id="selectContact" name="selectContact" action="{!selectContact}" rerender="contactDetailPanel, messages" status="Loading"/> 
									
								</apex:outputPanel>							
							</div>
						
							<script>showTab()</script>
						</div>
						
						
						
						<br/><br/>
						
						
						
					</apex:pageBlock>
					</apex:form>
				</apex:outputPanel>
			</apex:outputPanel>
		</apex:panelGrid>
		
	    <script>
			
			var airlinesTable;
			var MITAagreementsTable;
			var BIETAagreementsTable;
			var activeTab = 'Airline';
			
			/****** METHODS TO SET UP AIRLINE DATA TABLE *****/		
	        $(document).ready( function () {
	           
	           initAirlineTable();
	           
	    		// FILTER management
	    		
	    		$('#OnlyMITAAirlines').on( 'change', function(){ initAirlineTable();});
				$('#filterOn').on( 'change', function(){ initAirlineTable(); } );
				
				function initAirlineTable(){
					var searchstring = $("#airlinesTable_wrapper input[type='search']").size()==0 ? "" : $("#airlinesTable_wrapper input[type='search']").val();
					var member = $('#OnlyMITAAirlines').prop('checked') ? "true" : "";
					var code = $("#filterOn").val() == "code" || $("#filterOn").val() == "all";
					var name = $("#filterOn").val() == "name" || $("#filterOn").val() == "all";
				
					airlinesTable = $('#airlinesTable').DataTable({
						"lengthChange": false,
						"dom": '<"searchwrapper"f>rt<"bottom"ip><"clear">',
						"pageLength": 15,
						"columnDefs": [
							{ "name": "dcode", "targets": 0, "searchable": code},
							{ "name": "ncode", "targets": 1, "searchable": code},
							{ "name": "name", "targets": 2, "searchable": name},
							{ "name": "member", "targets": 3, "visible":false }
						],
						"oSearch": {"sSearch": searchstring},
						"bDestroy": true
					});
					airlinesTable.column('member:name').search(member).draw();
				}
				
				
	    		// ONCLICK for all the rows
	            $(airlinesTable.rows().nodes()).click(function () {
	            	
	            	$(airlinesTable.rows().nodes()).removeClass('selected');
	            	$(this).addClass('selected');
					$('[id$=accountid]').val($(this).attr('id'));
					localStorage.setItem("accountId", $(this).attr('id'));
	              	
	              	selectAccount();
	           });
	
				// INIT the page with the last account this user viewed.
				if(typeof(Storage) !== "undefined"){
					var accID = localStorage.getItem("accountId");
					if(accID != null)
						$('[id$=accountid]').val(accID);
					selectAccount();
				}
	    		
	    		
				
	        });
	        
	        
	        // AFTER AIRLINE IS SAVED this function is called to keep up to date the table on the left
	        function updateAirlineList(){
	        	var member = $("[class$='MITAMember'] img").attr('src').indexOf('unchecked') == -1;
	        	var aid = $('[id$=accountid]').val();
	        	airlinesTable.rows().search();
	        	
	        	var olddata = airlinesTable.row("#"+aid).data();
	        	olddata[3] = member;
	        	airlinesTable.row("#"+aid).data(olddata);
	        	airlinesTable.draw();
	        	
	        }
	        
	        
	        /****** METHODS FOR AGREEMENTS ******/
	        
	        function initAgreementTable(isMITA){
	        	var MITAagreementsTable;
				var BIETAagreementsTable;
				var agreementsTable = $('#'+(isMITA ? 'MITA' : 'BIETA')+'agreementsTable').DataTable({
					"dom": '<"top" lf>rt<"bottom"ip><"clear">',
					"pageLength": 50,
					"columnDefs": [
						{ "name": "code", "targets": 0 },
						{ "name": "name", "targets": 1 },
						{ "name": "type", "targets": 2 },
						{ "name": "startdate", "targets": 3 },
						{ "name": "active", "targets": 4 }
					]
				});
				
				if(isMITA)
					MITAagreementsTable = agreementsTable;
				else
					BIETAagreementsTable = agreementsTable;
				
				filterAgreements(isMITA);
				
				$(agreementsTable.rows().nodes()).click(function () {
	            	$('[id$='+(isMITA ? 'MITA' : 'BIETA')+'agreementid]').val($(this).attr('id'));
	            	
	            	if(isMITA){
	            		$(MITAagreementsTable.rows().nodes()).removeClass('selected');
	            		selectMITAAgreement();
	            	}else{
	            		$(BIETAagreementsTable.rows().nodes()).removeClass('selected');
	            		selectBIETAAgreement();
	            	}
	            	$(this).addClass('selected');
					
					selectAgreement();
					
	              	
	            });
	            
	            
	            $(".agreementtypefilter, .agreementactivefilter").on( 'change', function(){
	            	var isMITA = $(this).attr('data-type') == "MITA";
	            	filterAgreements(isMITA);
	            });
	            
	            
	            function filterAgreements(isMITA){
	            	var MB = isMITA ? "MITA" : "BIETA";
	            	var typefilter = $('.agreementtypefilter[data-type="'+MB+'"]:checked').attr("data-value");
	            	var activefilter = $('.agreementactivefilter[data-type="'+MB+'"]:checked').attr("data-value");
	            	
	            	if(isMITA)
	            		MITAagreementsTable
	            			.column('type:name').search('"'+typefilter+'"')
	            			.column('active:name').search('"'+activefilter+'"')
	            			.draw();
	            	else
	            		BIETAagreementsTable
							.column('type:name').search('"'+typefilter+'"')
	            			.column('active:name').search('"'+activefilter+'"')
	            			.draw();
	            }
	        }
	        
	        /****** METHODS TO MANAGE THE CONTACT TAB ******/
	        function clickOnContact(contactId){
	        	$('[id$=contactid]').val(contactId);
	           	selectContact();
	        }
	                
	                
	        function showTab(name){
	        	// this will happen if I just refresh the page or a the right column 
	        	if(name==null)
	        		name = activeTab;
	        	// this happens when user explicitly cliks on a tab
	        	else{
	        		activeTab = name;
	        	}
	        	$(".mytab, .mytabheader").removeClass("active");
	        	$("#tab"+name+", #hd"+name).addClass("active");
	        	
	        }
	    </script>
		<style>
			.mytabheadercontainer{}
			.mytabheader{display:inline-block; border:1px solid lightgrey; border-top-left-radius:0.5em; border-top-right-radius:0.5em; padding:0.5em; margin-left:0.1em; font-weight:bold; cursor:pointer;}
			.mytabheader.active{background:#337AB7; border:none; color:white; border:1px solid #337AB7;}
			
			.mytabcontainer{ border:1px solid lightgrey; border-top:5px solid #337AB7; border-radius:5px; border-top-left-radius:0; padding:1em;}
			.mytab{display:none; }
			.mytab.active{display:block;}
			.searchwrapper{display:inline-block;}
			.pbSubheader {background:#337AB7}
			.bPageBlock {border-top:4px solid #337AB7}
		</style>
        
        
        <c:ISSP_CustomFooter />
    </div>
     </body>
    </html>
</apex:page>