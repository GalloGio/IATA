<apex:page showHeader="false" sidebar="false" standardController="AMS_OSCAR__c" extensions="AMS_AccountHierarchySelectionController">

	<apex:includeScript value="{!$Resource.jquery2_1_4}"/>
	<apex:includeScript value="/support/console/20.0/integration.js"/>
    <script type="text/javascript">
    	function logCLose(closetab) {
    		console.info(closetab);
    	}
        function testSetTabTitle() {
            //Set the current tab's title
            sforce.console.setTabTitle('Account Hierarchy Selection');
        }
        var pageLoad = window.onload;
		window.onload = function() {
			if (pageLoad) {
				pageLoad();
            }
			testSetTabTitle();
		}

		function closeTab(){
			sforce.console.getEnclosingTabId(closeSubtab);
		}
		
		var closeSubtab = function closeSubtab(result){
		    var tabId = result.id;
		    sforce.console.closeTab(tabId);
		};
	</script>
	
	<apex:form>
		<apex:sectionHeader title="Account Hierarchy Selection" subtitle="{!oscar.Account__r.Name}"/>
		<apex:pageBlock>

			<apex:pageMessages id="pageMessages"/>

			<apex:panelGrid id="fields" columns="2">
				<apex:pageBlockSection id="controlField" columns="1">
					<apex:inputField value="{!oscar.Type_of_Change__c}">
						<apex:actionSupport event="onchange" reRender="dependentFields, notes"/>
					</apex:inputField>
				</apex:pageBlockSection>
				<apex:pageBlockSection id="dependentFields">
					<apex:inputField value="{!oscar.AMS_Target_Agency__c}" rendered="{!showTargetAgency}"/>
					<apex:inputField value="{!oscar.Change_of_location_type_behavior__c}" rendered="{!showLocationTypeBehavior}"/>
				</apex:pageBlockSection>
			</apex:panelGrid>

			<apex:pageBlockSection id="notes" columns="1" title="Notes" collapsible="true">
				<apex:dataList value="{!noteList}" var="note" rendered="{!noteList.size > 0}">
					<apex:outputText value="{!note}"/>
				</apex:dataList>
			</apex:pageBlockSection>

			<apex:pageBlockSection id="table" columns="1" title="Select Accounts" rendered="{!hierarchy.size > 0}">
				<apex:outputPanel layout="block" styleClass="pos-relative">
					<apex:pageBlockTable value="{!hierarchy}" var="hi"> 
						
						<apex:column headerValue="Main">
							<apex:inputCheckbox html-data-group="main" value="{!hi.main}">
								<apex:actionSupport event="onchange" action="{!hi.selectMain}" status="blockTable" reRender="table"/>
							</apex:inputCheckbox>
						</apex:column>

						<apex:column>
							<apex:facet name="header">
								<apex:inputCheckbox value="{!selectAll}">
									<apex:actionSupport event="onchange" action="{!doSelectAll}" status="blockTable" reRender="table"/>
								</apex:inputCheckbox>
							</apex:facet>

							<apex:inputCheckbox value="{!hi.selected}"/>
						</apex:column>

						<apex:repeat value="{!accountFieldList}" var="field">
							<apex:column value="{!hi.acc[field]}"/>
						</apex:repeat>
					</apex:pageBlockTable>

					<style>
						.pos-relative{ position: relative; }
						.loading-backdrop{ 
							position: absolute; 
							top: 0; 
							bottom: 0; 
							right: 0; 
							left: 0; 
							background: #FFF; 
							opacity: 0.5; 
						}
						.loading-img{
							position: absolute;
							top: 50%;
							left: 50%;
							margin-top: -16px;
							margin-left: -16px;
		 				}
					</style>
					<apex:actionStatus id="blockTable">
						<apex:facet name="start">								
							<apex:outputPanel layout="block" styleClass="loading-backdrop">
								<apex:image value="/../img/loading32.gif" styleClass="loading-img"/>
							</apex:outputPanel>
						</apex:facet>
					</apex:actionStatus>
				</apex:outputPanel>
			</apex:pageBlockSection>

			<apex:pageBlockButtons location="bottom">
				<apex:actionStatus id="blockButtons">
					<apex:facet name="start">
						<apex:outputPanel layout="none">
							<apex:commandButton disabled="true" value="{!$Label.Site.Save}"/>
							<apex:commandButton disabled="true" value="{!$Label.Site.Cancel}"/>
						</apex:outputPanel>
					</apex:facet>
					
					<apex:facet name="stop">
						<apex:outputPanel layout="none">
							<apex:commandButton action="{!save}" oncomplete="logCLose({!closeTab}); {!IF(closeTab, 'closeTab();', '')}" status="blockButtons" value="{!$Label.Site.Save}" reRender="pageMessages"/>
							<apex:commandButton action="{!cancel}" oncomplete="closeTab();" status="blocButtons" value="{!$Label.Site.Cancel}" immediate="true"/>
						</apex:outputPanel>
					</apex:facet>
				</apex:actionStatus>
						
			</apex:pageBlockButtons>
		</apex:pageBlock>	

		<apex:actionFunction name="reRenderTable" reRender="table"/>
	</apex:form>
</apex:page>