<apex:page controller="ISSP_AvailableServices" action="{!initialization}" standardStylesheets="false" showHeader="false" sidebar="false"  applyBodyTag="false" applyHtmlTag="false">
<html>
 <c:ISSP_Header ></c:ISSP_Header>    
 <body>
     <!-- elliot 19 juin -->
     <apex:variable var="AdminOrNot" value="{!if($Profile.Name == 'ISS Portal Agency Delegated Admin User' || $Profile.Name == 'ISS Portal Airline Delegated Admin User' || $Profile.Name == 'ISS Portal Delegated Admin User'  || $Profile.Name == 'ISS Portal GSA Delegated Admin User','','none')}" />
    <!-- end elliot 19 juin -->
 <div class="container">
 <c:ISSP_CustomNavigation />

    <!---------------------------------------------------------------------->
       <script type="text/javascript">

    function newAppReq2(appId,appName, flagUseDefaultRole, isEasyPayService){
      var appPortalRole = $('[id$="portalRoles"]').val();
      newAppReq(appId,appName, appPortalRole, flagUseDefaultRole, isEasyPayService);
    }
       
    function newAppReq(appId,appName, appPortalRole, flagUseDefaultRole, isEasyPayService){

        var doInsert;
        if (isEasyPayService == 'false') {
          doInsert = 2;
        } else {
          if (appPortalRole == '' && flagUseDefaultRole == "true") {
            doInsert = 1;  
          } else {
            if (appPortalRole == '' && flagUseDefaultRole == "false") {
              doInsert = 0;  
            } else {
              doInsert = 1;  
            }
          }
        }

        if (doInsert == 0) {
            document.querySelector("[Id$='portalRoleErrorMessage']").style.display = '';       
        } else {
            if (appPortalRole != 'SKIP') {
                closeDialog();
            }
            $('#ModalNewServiceRequest').modal('toggle');
            if (doInsert == 1) {
              if(appPortalRole == null  || appPortalRole == undefined) {
                appPortalRole = '';
              }              
              ISSP_AvailableServices.newAppsRequest2(appId,appName,'{!conId}', appPortalRole, flagUseDefaultRole, '{!defaultPortalUserRole}', newAppReqCallback);
            } else {
              ISSP_AvailableServices.newAppsRequest(appId,appName,'{!conId}', newAppReqCallback);
            }            
        }

        //closeDialog();
        //location.reload(true);
        //refresh(); 
      }

    function newAppReqCallback(res){
      
    }
    

    function doRequest(servId) {

         paraFunction(servId);
    }
    
    function dopopup(){
         $('#Hiddenbtn').trigger( "click" );
    }

    function closeDialog(){
      //alert(' closeDialog : ');
      $('#myModal').modal('toggle');
    }
    </script>

    <style type="text/css">
    a.alpha-link {
       font-weight: normal;
       font-size: 91%;
       padding: 0 4px;
       color: #015BA7 !important;
    }
     
    a.alpha-link+a.alpha-link { 
       border-left: 1px solid #CFCECE;
    }
     
    a.alpha-link:hover {
       background-color: #e0f5fc !important;
    }
     
    a.alpha-select {
       font-weight: bold;
       text-decoration: none;
       background-color: #C6E1FF;
       color: #000000 !important;
    }

    .tos_label {
       font-size: 11px;
       color: #015BA7 !important;
    }
    </style>
    <h4>{!$Label.ISSP_services}  <span class="glyphicon glyphicon-chevron-right small " aria-hidden="true"></span>
         {!$Label.ISSP_Available_services} <span class="glyphicon glyphicon-chevron-right small " aria-hidden="true"></span>
        <small>{!$Label.ISSP_PageDescription_ISSP_AvailableServices} </small></h4>
    <apex:form id="contactListForm">

    <apex:actionFunction name="next" action="{!setCon.next}" rerender="Services" />
    <apex:actionFunction name="previous" action="{!setCon.previous}" rerender="Services" />
    <apex:actionFunction name="first" action="{!setCon.first}" rerender="Services" />
    <apex:actionFunction name="last" action="{!setCon.last}" rerender="Services" />
    <apex:actionFunction name="refresh" action="{!refresh}" rerender="ServiceListForm" />

    <apex:actionFunction name="paraFunction" action="{!doRequest}"  reRender="contactListForm,Services,myModalContent,ModalNewServiceRequest" oncomplete="javascript:dopopup();" immediate="true">      
      <apex:param id="servId" name="servId"  value="" />
    </apex:actionFunction>

    <apex:inputHidden value="{!selectedList}" id="selectedItemHidden"/> 
    <!-- <apex:pageMessages /> -->
    
    
    <img src="/s.gif" alt="Service" class="pageTitleIcon" title="Service"/>
    <!--
    <select id="testSelect" class="form-control selector" onchange="$('[id$=selectedItemHidden]').val($(this).val());refresh();">
        <apex:repeat value="{!ListViewNameList}" var="csName" id="theRepea1">
            <option value="{!csName}">{!$Label[ServiceListViewMap[csName].Label_API_name__c]}</option>
        </apex:repeat>
    </select>
    -->
    
    <script>
        $('#testSelect').val( '{!selectedList}' );
    </script>
    
    <apex:pageBlock id="Services" >
   
        <hr />
        <apex:pageMessages escape="false"/>
        <apex:pageBlockTable value="{!ServiceList}" var="item" styleClass="table-hover  table table-condensed table-responsive" id="pbt_Services">
          
       
            <apex:repeat value="{!fields}" var="f">
                  <apex:column >
                    <apex:facet name="header">
                       <apex:commandLink action="{!refresh}" reRender="pbt_Services">{!f.label}
                         <apex:outputPanel layout="none" rendered="{!AND(OR(sortExpression==f.FieldPath,AND(sortExpression=='Name',f.FieldPath=='Name')), sortDirection='ASC')}">&#9650;</apex:outputPanel>
                         <apex:outputPanel layout="none" rendered="{!AND(OR(sortExpression==f.FieldPath,AND(sortExpression=='Name',f.FieldPath=='Name')), sortDirection='DESC')}">&#9660;</apex:outputPanel>
                         <apex:param value="{!f.FieldPath}" name="column" assignTo="{!sortExpression}" ></apex:param>
                       </apex:commandLink>
                    </apex:facet>
                     
                   
                     <apex:outputpanel rendered="{!IF(f.label!='Service' && f.label!='Servicio'&& f.label!='???' && f.label!='??' && f.label!='Servi�o' && f.label!='????' && f.label!='Servizio' && f.label!='??????'&&f.label!='Layanan'&&f.label!='D?ch v?'&&f.label!='??????',true,false)}"> <!-- && f.label!='Account Name' -->
                        <apex:outputText value="{!item.recordService[f.fieldPath]}" escape="false" />
                    </apex:outputpanel>
                    
         
                   <apex:outputpanel rendered="{!IF(f.label=='Service'||f.label=='Servicio'||f.label=='???' ||f.label=='??' ||f.label=='Servi�o' ||f.label=='????' ||f.label=='Servizio' ||f.label=='??????' ||f.label=='Layanan' ||f.label=='D?ch v?' ||f.label=='??????',true,false)}"> 
                        
                     <apex:outputLink value="{!item.recordService.Application_URL__c}" target="{!IF(item.recordService.New_Window__c,'_blank','_self')}" rendered="{!IF(item.Status=='Access Granted',true,false)}" >{!item.recordService.ServiceName__c}</apex:outputLink>
                     <apex:outputText value="{!item.recordService.ServiceName__c}" rendered="{!IF(item.Status=='Access Granted',false,true)}" />
                    </apex:outputpanel>
                    
                    
                  </apex:column>
            </apex:repeat>
            <apex:column headerValue="{!$Label.ISSP_Status}">
                  <apex:outputtext value="{!CASE(item.Status, 'Access Granted', $Label.ISSP_Access_Granted, 'Access Denied', $Label.ISSP_Access_Denied, $Label.ISSP_Access_Requested)}" rendered="{!IF(item.Status != null , true,false)}"/>

                  <a onclick="doRequest('{!item.recordService.Id}')"   class="pull-right btn_iata_success btn btn-block"  
                  style="display:{!IF(item.Status == null || item.Status =='' , '','none')}">
                  <!--{!$label.ISSP_New_Service_Request}-->
                  {!item.btnLabel}
                  </a>

                  <a id="Hiddenbtn" data-toggle="modal" href="#myModal"
                  style="display:none">
                  </a>
            </apex:column>
          <!--elliot 19 juin-->  
           
            <apex:column style="text-align: center; display: {!AdminOrNot}">
                <apex:outputPanel rendered="{!!item.recordService.Cannot_be_managed_by_portal_admin__c}">
                
                
                <apex:outputLink styleClass="btn btn_iata_primary" value="/ISSP_EditPortalServiceAccess?Id={!item.recordService.Id}&op=Edit&PSId={!item.recordService.Id}&PSname={!item.recordService.name}" target="_self">{!$Label.ISSP_Add_User_to_this_service}</apex:outputLink>
           
                    </apex:outputPanel>
                </apex:column>
             <!-- end elliot 19 juin -->
        </apex:pageBlockTable>
         
        <div class="bottomNav" id="j_id0:YourListViewId_bottomNav">
           <div class="paginator">
              <span class="left">
                 <span class="selectorTarget" >
                    {!((setCon.PageNumber-1) * setCon.PageSize)+1} - {!IF(setCon.HasNext,((setCon.PageNumber-1) * setCon.PageSize)+11,noOfRecords)}  {!$Label.ISSP_of} {!noOfRecords }
             </span>
          </span>
          <span class="prevNextLinks">
          
           <span class="prevNext"  style="display:{!IF(setCon.HasPrevious,'none','')}">
            <img src="/s.gif" class="firstoff" alt="First Page"/>
           </span>
           <span class="prevNext"  style="display:{!IF(setCon.HasPrevious,'','none')}">
               <a href="javascript:first()"><img src="/s.gif" title="First Page" alt="First Page" class="first"/></a>
           </span>
           
           <span class="prevNext" style="display:{!IF(setCon.HasPrevious,'none','')}">
                <img src="/s.gif" class="prevoff" alt="Previous"/>{!$Label.ISSP_Previous}
            </span>
            <span class="prevNext" style="display:{!IF(setCon.HasPrevious,'','none')}">
                <a href="javascript:previous()"><img src="/s.gif" title="Previous" alt="Previous" class="prev"/>Previous</a>
            </span>
            
           <span class="prevNext" style="display:{!IF(setCon.HasNext,'none','')}">{!$Label.ISSP_Next}
                <img src="/s.gif" class="nextoff" alt="Next"/>
            </span>
            <span class="prevNext" style="display:{!IF(setCon.HasNext,'','none')}">
                <a href="javascript:next()">Next<img src="/s.gif" title="Next" alt="Next" class="next"/></a>
            </span>
            
           <span class="prevNext" style="display:{!IF(setCon.HasNext,'none','')}">
                <img src="/s.gif" class="lastoff" alt="Last Page"/>
           </span>
           <span class="prevNext" style="display:{!IF(setCon.HasNext,'','none')}">
               <a href="javascript:last()"><img src="/s.gif" title="Last Page" alt="Last Page" class="last"/></a>
           </span>
           </span>
           <span class="right">{!$Label.ISSP_Page}
               {!setCon.PageNumber}
               {!$Label.ISSP_of} {!CEILING(noOfRecords/size)}
        
            </span>
           </div>
           <div class="clearingBox"></div>
        </div>
        </apex:pageBlock> 
     
    <!---------------------------------------------------------------------->
    <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <apex:outputPanel layout="block" styleClass="modal-dialog" id="myModalContent"> 
        <div class="modal-content"> 
          <div class="modal-header"> 
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title">{!$Label.ISSP_New_Service_Request}</h4>
          </div>
          <div class="modal-body" style="display:{!if(true,'','none')}">
            <!-- <h5>Services list:</h5><br/> -->
            <apex:outputPanel id="display_messages"> 
                <div class="alert alert-danger" style="display:{!if(errorMessage.size==0,'none','')}">
                  <strong>{!$Label.ISSP_Error} </strong>
                  <apex:repeat value="{!errorMessage}" var="er" id="theRepeat">
                      <p><apex:outputText value="{!er}" escape="false" /></p>
                  </apex:repeat>
                </div>
                
                <div class="alert alert-danger" id="portalRoleErrorMessage" style ="display: none">
                  <strong> {!$Label.ANG_ISSP_PortalRoleErrorMessage} </strong>
                </div>
                
              </apex:outputPanel>
            <ul class="external_links clearfix nav">

                <li> 
                  <span class="appfocus">
                    <a  id="appReq{!Serv.recordService.Id}"  title="">
                      <apex:outputText escape="false" value="{!Serv.recordService.Application_icon__c}" />
                    </a>
                  </span>
                  <!--span>
                      <apex:outputLabel value="{!$Label.ISSP_ServiceRequestConfirm} {!Serv.recordService.Name}" rendered="{!!Serv.recordService.Confirm_Box__c}" />
                      <apex:outputLabel value="{!Serv.recordService.Confirm_Text__c}" rendered="{!Serv.recordService.Confirm_Box__c}" escape="false" />
                  </span-->

                  <apex:outputPanel>
                      <apex:outputLabel value="{!$Label.ISSP_ServiceRequestConfirm} {!IF(Serv.isEasyPayService, $Label.ANG_ISSP_IATA_EasyPay, Serv.recordService.Name)}?" rendered="{!!Serv.recordService.Confirm_Box__c}" />
                      <apex:outputLabel value="{!Serv.recordService.Confirm_Text__c}" rendered="{!Serv.recordService.Confirm_Box__c}" escape="false" />
                  </apex:outputPanel>
                
                </li>

                <li> 
                  <span class="appfocus" rendered="{! (Serv.isEasyPayService && !Serv.useDefaultRole)}">
                    <a  id="appReq{!Serv.recordService.Id}"  title="">
                      <apex:outputText escape="false" value="{!Serv.recordService.Application_icon__c}" style="visibility: hidden"/>
                    </a>
                  </span>
                  <apex:outputPanel rendered="{! (Serv.isEasyPayService && !Serv.useDefaultRole)}">
                    <apex:outputLabel value="{!$Label.ANG_ISSP_PORTAL_SERVICE_ROLE} : " title="{!$Label.ANG_ISSP_PORTAL_SERVICE_ROLE_HINT}" />
                                        
                    <apex:selectList id="portalRoles" value="{!Serv.portalServiceRole}" size="1" required="true">
                      <apex:selectOptions value="{!availablePortalServiceRoles}"/>
                    </apex:selectList>                  
                  </apex:outputPanel>
                </li>

                <script> 
                  if('{!JSENCODE(Serv.recordService.Description__c)}'!=''){ 
                    var htmlCont = '<div class="sfdc_richtext">'+'{!JSENCODE(Serv.recordService.Description__c)}'+'</div>';
                    $('#appReq{!Serv.recordService.Id}').popover({trigger:'hover' ,html:true,content:htmlCont});
                  }
                </script>
            </ul>
            
              <apex:outputPanel rendered="{!Serv.recordService.Name=='Standards Setting Workspace'}"> 
                <div class="checkbox">
                  <label class="tos_label">
                    {!$Label.ISSP_KAVI_Terms_Conditions_Part1}
                  </label>
                  <br/><br/>
                  <label class="tos_label">
                    {!$Label.ISSP_KAVI_Terms_Conditions_Part3}
                  </label>
                  <br/><br/>
                  <label class="tos_label">
                    {!$Label.ISSP_KAVI_Terms_Conditions_Part2}
                  </label>
                  <br/><br/>
                  <label class="tos_label">
                    <apex:inputCheckbox style="margin-top:-0.1px" value="{!accept}"  selected="false"/>
                    <a>{!$Label.ISSP_AcceptTermsAndConditions}</a>
                  </label>
                </div> 
                
              </apex:outputPanel> 
          </div>

          <div class="modal-footer">
              <div class="row">
                  
              <div class="col-md-6">
            
              <apex:commandButton rendered="{!Serv.recordService.Name=='Standards Setting Workspace'}" value="{!$Label.ISSP_Confirm}" styleClass="btn_iata_success btn-block btn" action="{!submitRequest}" oncomplete="if ({!accept}) {closeDialog();newAppReq('{!Serv.recordService.Id}','{!Serv.recordService.Name}', 'SKIP', '', 'false');}" rerender="display_messages"/>

              <apex:outputPanel rendered="{!Serv.recordService.Name!='Standards Setting Workspace'}" id="serviceSubmitButton"> 
                <a onclick=" newAppReq2('{!Serv.recordService.Id}','{!Serv.recordService.Name}', '{!Serv.useDefaultRole}', '{!Serv.isEasyPayService}');"    class="btn_iata_success btn-block btn">
                   {!$Label.ISSP_Confirm}
                </a>
              </apex:outputPanel> 

 </div>
                  <div class="col-md-6">
              <a onclick="closeDialog()"   class="btn_iata_cancel btn-block btn">
                  {!$label.ISSP_Cancel}
              </a>
                  </div>
            </div>
          </div>
        </div>
        <!-- /.modal-content -->
      </apex:outputPanel>
      <!-- /.modal-dialog -->
    </div>


    <!-- Modal New Service Request-->
    <div class="modal fade" id="ModalNewServiceRequest" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" onblur="location.reload(true);">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="btn_iata" class="close" data-dismiss="modal" aria-hidden="true" onclick="location.reload(true);" >&times;</button>
            <h4 class="modal-title"> {!$Label.ISSP_New_Service_Request}</h4>
          </div>
          <div class="modal-body">
            <p>
              {!$Label.ISSP_Thanks_for_request}
            </p>
          </div>
        </div>
      </div>
    </div>
</apex:form>
    <c:ISSP_CustomFooter />
</div><!-- end container-->
    </body>
    </html>
</apex:page>