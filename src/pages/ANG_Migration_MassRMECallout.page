<apex:page controller="ANG_Migration_MassRMECallout" id="thePage">
    <apex:includeScript value="{!$Resource.jquery2_1_4}"/>

    <script type="text/javascript">
        var __sfdcSessionId = '{!GETSESSIONID()}';
    </script>

    <script src="/soap/ajax/31.0/connection.js" type="text/javascript"></script>

    <script>
        var nProcessed = 0;
        var nToProcess = 0;
        var lsRMEResponseWrapper = [];

        function startLoading(){ $('[id*="loading"]').show(); }
        function stopLoading(){ $('[id*="loading"]').hide(); }

        function CountProcessed(){
            $('[id*="theCurrentStatus"]').text("Processed " + nProcessed + " Agencies out of " + nToProcess);
        }

        function RMEResponseWrapper(isSuccess, description, iataCode, RHCId, AccntId, sCurrency, ProvAmnt, ConsumedRHC, ConsumedRHCPerc, sLastUpd, sType){
            this.isSuccess = isSuccess;
            this.description = description;
            this.iataCode = iataCode;
            this.RHCId = RHCId;
            this.AccntId = AccntId;
            this.sCurrency = sCurrency;
            this.ProvAmnt = ProvAmnt;
            this.ConsumedRHC = ConsumedRHC;
            this.ConsumedRHCPerc = ConsumedRHCPerc; 
            this.sLastUpd = sLastUpd;
            this.sType = sType;
        }

        function UserAction(sType) {
            var cnt = document.getElementById('{!$Component.theForm.pbt01.pbs02.theCountry}').value;
            var accnt = sforce.connection.query("select Id, ANG_AccountId__c, ANG_AccountId__r.IATACode__c from ANG_RHC_Information__c where ANG_AccountId__r.IATA_Iso_country__r.ISO_Code__c = '" + cnt + "' and ANG_AccountId__r.IATACode__c != ''");

            var records = accnt.getArray("records");

            nToProcess = records.length;
            nProcessed = 1;
            if (confirm(nToProcess + ' request will be done. This may hang your browser. DO NOT CLOSE THE WINDOW. Would you like to proceed?') == true) {
                for (var i=0; i< records.length; i++) {            
                    var record = records[i];
                    RequestToRME(record.ANG_AccountId__r.IATACode__c, record.Id, record.ANG_AccountId__c, sType);
                }
            }else{
                return false;
            }
        }

        function RequestToRME(IATACode, RHCId, IDAccnt, sType){
            startLoading();
            Visualforce.remoting.Manager.invokeAction(
                '{!$RemoteAction.ANG_Migration_MassRMECallout.SendRequestToRME}',
                IDAccnt,
                sType,
                function(result, event){
                    var tmpWrap = new RMEResponseWrapper(false, '', IATACode, RHCId, IDAccnt, null, null, null, null, null, sType);
                    if(event.type == 'exception'){ 
                        tmpWrap.isSuccess = false;
                        tmpWrap.description = event.message;
                    }else{
                        if(result!=null){
                            tmpWrap.isSuccess = result.isSuccess;
                            tmpWrap.description = result.description;
                        }
                    }
                    
                    nProcessed++;
                    lsRMEResponseWrapper.push(tmpWrap);

                    if(nProcessed>nToProcess){
                        afterCallout(JSON.stringify(lsRMEResponseWrapper));
						stopLoading();
					}
                },{buffer: false, escape: false, timeout: 120000}
            );
        }
    </script>

    <apex:form id="theForm">
        <div id="loading" style="display: none">
            <div style="height:100%;width:100%;z-index:100; position:fixed;background:black;opacity:0.5; top:0; left:0;"></div>
            <div style="border:1px solid black; background:white; text-align:center;
                        display: inline-block; padding: 1em; padding-left: 3em; padding-right: 3em;
                        position: absolute; top:40%; left:45%; z-index:101;">
                <!--<apex:image url="{!URLFOR($Resource.loadinggif)}"/><br />-->
                <p id="theCurrentStatus">Work in progress...</p>
            </div>
        </div>

        <apex:actionFunction action="{!afterCallout}" name="afterCallout" reRender="resultKO,resultOK,theResultPanel,pnlBtn,btnNewSearch,thePBT,theForm" oncomplete="SearchPerformed()">
            <apex:param name="myParam" assignTo="{!theSerializedResultFromRME}" value=""/>
        </apex:actionFunction>

        <apex:actionFunction action="{!SearchPerformed}" name="SearchPerformed" reRender="resultKO,resultOK,theResultPanel,pnlBtn,btnNewSearch,thePBT"/>

        <apex:pageBlock title="Mass Request to RME" tabStyle="Account" id="pbt01">
            <apex:pageBlockSection title="Select a country" columns="1" collapsible="false" id="pbs02">
                <apex:selectList label="Select a country" id="theCountry" value="{!selectedCnt}" size="1">
                    <apex:selectOptions value="{!lsCountry}" />
                </apex:selectList>
            </apex:pageBlockSection>

            <apex:pageBlockButtons location="bottom" id="pbb">
                <apex:outputPanel id="pnlBtn">
                    <apex:commandButton action="{!doNothing}" id="bntConsumedRHC" value="Mass Request Consumed RHC" reRender="resultKO,resultOK,theResultPanel,pnlBtn,theForm,btnNewSearch,thePBT" onclick="UserAction('ConsumedRHC');return false;" rendered="{!!bQueryExecuted}"/>
                    <apex:commandButton action="{!doNothing}" id="btnProvisionalRHC" value="Mass Request Provisional RHC" reRender="resultKO,resultOK,theResultPanel,pnlBtn,theForm,btnNewSearch,thePBT" onclick="UserAction('ProvisionalRHC');return false;" rendered="{!!bQueryExecuted}"/>
                    <apex:commandButton action="{!NewSearch}" id="btnNewCountry" value="Process other country" rendered="{!bQueryExecuted}"/>
                </apex:outputPanel>
            </apex:pageBlockButtons>
        </apex:pageBlock>


        <br/><br/>

        <apex:outputPanel id="theResultPanel" >
            <apex:pageBlock id="resultOK" title="{!sType}: Successful Results" rendered="{!AND(bQueryExecuted, bHasSuccess)}" tabStyle="Account">
                <apex:pageBlockTable value="{!lsRMEWrapperWSOK}" var="item" id="thePBTOK">
                    <apex:column title="IATA Code" headerValue="IATA Code">
                    	<a href="/{!item.RHCId}" target="_blank">{!item.IataCode}</a>
                    </apex:column>
                    <apex:column title="Provisional Amount" value="{!item.ProvAmnt}" headerValue="Provisional Amount" rendered="{!sType=='ProvisionalRHC'}"/>
                    <apex:column title="Consumed RHC" value="{!item.ConsumedRHC}" headerValue="Consumed RHC" rendered="{!sType=='ConsumedRHC'}"/>
                    <apex:column title="Consumed RHC %" value="{!item.ConsumedRHCPerc}" headerValue="Consumed RHC %" rendered="{!sType=='ConsumedRHC'}"/>
                    <apex:column title="Currency" value="{!item.sCurrency}" headerValue="Provisional Currency"/>
                    <apex:column title="Last Update" value="{!item.sLastUpd}" headerValue="Last Update"/>
                </apex:pageBlockTable>
            </apex:pageBlock>
            <br/> <br/>
            <apex:pageBlock id="resultKO" title="{!sType}: Error Results" rendered="{!AND(bQueryExecuted, bHasError)}" tabStyle="Account">
                <apex:pageBlockTable value="{!lsRMEWrapperWSErr}" var="item" id="thePBTKO">
                    <apex:column title="IATA Code" value="{!item.IataCode}" headerValue="IATA Code"/>
                    <apex:column title="Provisional Amount" value="{!item.ProvAmnt}" headerValue="Provisional Amount" rendered="{!sType=='ProvisionalRHC'}"/>
                    <apex:column title="Consumed RHC" value="{!item.ConsumedRHC}" headerValue="Consumed RHC" rendered="{!sType=='ConsumedRHC'}"/>
                    <apex:column title="Consumed RHC %" value="{!item.ConsumedRHCPerc}" headerValue="Consumed RHC %" rendered="{!sType=='ConsumedRHC'}"/>
                    <apex:column title="Currency" value="{!item.sCurrency}" headerValue="Provisional Currency"/>
                    <apex:column title="Last Update" value="{!item.sLastUpd}" headerValue="Last Update"/>
                    <apex:column title="Error Message" value="{!item.description}" headerValue="Error Message"/>
                </apex:pageBlockTable>
            </apex:pageBlock>
        </apex:outputPanel>
    </apex:form>
</apex:page>