<apex:page controller="IEC_ShippingController" action="{!onLoadAction}" language="{!language}" 
    docType="html-5.0"  applyBodyTag="false" applyHtmlTag="false" showHeader="false" sidebar="false" standardStylesheets="false" cache="true">
    
    <!--[if lte IE 8]>
    <html lang="en" class="ie lte-ie8 no-svg">
    <![endif]-->
    <!--[if IE 9]>
        <html lang="en" class="ie ie9">
    <![endif]-->
    <!--[if !IE]><!-->
    
    <html lang="{!language}">
    <!--<![endif]-->

        <head>
            <meta charset="UTF-8"/>
            <meta name="viewport" content="width=device-width, initial-scale=1"/>
            <apex:stylesheet value="{!URLFOR($Resource.EcommerceAssets, 'css/styles.min.css')}" />
            <apex:stylesheet value="{!URLFOR($Resource.ValidationEngine, 'css/validationEngine.jquery.css')}" />
            <apex:stylesheet value="{!URLFOR($Resource.jQueryUI, 'jquery-ui.min.css')}" />
            <title>{!$Label.PageTitleShippingPayment} - {!$Label.SiteTitle}</title>

            <apex:includeScript value="{!$Resource.postmessage_js}" />

        </head>

        <body data-media-size="" class="page-checkout" id="page-top">

            <div id="js-breakpoint-finder">
                <span class="device-xs screen-xsmall"/>
                <span class="device-sm screen-small"/>
                <span class="device-md screen-medium"/>
                <span class="device-lg screen-large"/>
                <span class="device-xl screen-xlarge"/>
            </div>

            <div id="js-app-container" class="app-container">
                <!-- Page Header -->
                <c:IEC_PageHeader is_checkout="true"/>

                <div id="js-page-container" class="page-container">
                    <main class="main-content">
                        <apex:outputPanel layout="block" styleClass="inner-wrapper" id="inner_wrapper">
                            <!-- Quote Confirm Message -->

                            <apex:outputPanel styleClass="table-container" rendered="{!quoteGenerated}">
                                <!-- Success Message -->
                                <apex:outputPanel styleClass="alert success" rendered="{!hasConfirm}" layout="block">
                                    <apex:pageMessages escape="false"/>
                                </apex:outputPanel>

                                <div class="quote-details-container">
                                    <div class="caption">{!$Label.Quote} &nbsp;<apex:outputText value="{!quote.OrderNumber}" /></div>
                                    <div class="dates">
                                        <div class="box">
                                            <strong>{!labels['lblFrDate']}: </strong>
                                            <apex:outputText value="{0, date, medium}" >
                                                <apex:param value="{!quote.EffectiveDate}" />
                                            </apex:outputText>
                                        </div>
                                        <div class="box">
                                            <strong>{!labels['lblToDate']}: </strong>
                                            <apex:outputText value="{0, date, medium}" >
                                                <apex:param value="{!quote.EndDate}" />
                                            </apex:outputText>                                            
                                        </div>
                                    </div>

                                    <div class="section-container">
                                        <div class="group-container group-billing-shipping row">
                                            <div class="columns small-12 medium-6">
                                                
                                                <!-- Start billing address -->
                                                <section class="group-container billing-address">
                                                    <h2 class="group-title">{!$Label.Billing_address}</h2>

                                                    <div class="field-group output inline">
                                                        <span class="input-label">{!$Label.Address_Line_1}</span>
                                                        <span class="output-value">{!quote.BillingStreet}</span>
                                                    </div>

                                                    <div class="field-group output inline">
                                                        <span class="input-label">{!$Label.Postal_code}</span>
                                                        <span class="output-value">{!quote.BillingPostalCode}</span>
                                                    </div>

                                                    <div class="field-group output inline">
                                                        <span class="input-label">{!$Label.City}</span>
                                                        <span class="output-value">{!quote.BillingCity}</span>
                                                    </div>

                                                    <div class="field-group output inline">
                                                        <span class="input-label">{!$Label.Country}</span>
                                                        <span class="output-value">{!quote.BillingCountry}</span>
                                                    </div>

                                                    <div class="field-group output inline">
                                                        <span class="input-label">{!$Label.State_Province}</span>
                                                        <span class="output-value">{!quote.BillingState}</span>
                                                    </div>
                                                    <div class="field-group output inline">
                                                        <span class="input-label">{!$Label.PO_number}</span>
                                                        <span class="output-value">{!quote.PoNumber}</span>
                                                    </div>

                                                    <div class="field-group output inline">
                                                        <span class="input-label">{!$Label.Invoice_text}</span>
                                                        <span class="output-value">{!quote.Invoice_Text__c}</span>
                                                    </div>

                                                    <div class="field-group output inline">
                                                        <span class="input-label">{!$Label.VAT_number}</span>
                                                        <span class="output-value">{!quote.BillToContact_VAT_Number__c}</span>
                                                    </div>
                                                </section>
                                                <!-- end billing address section -->
                                            </div>
                                            <div class="columns small-12 medium-6">                                             
                                                <!-- Start shipping address section -->
                                                <section class="group-container shipping-address">
                                                    <h2 class="group-title">{!$Label.Shipping_address}</h2>

                                                    <div class="shipping-address-container">
                                                        <div class="field-group output inline">
                                                            <span class="input-label">{!$Label.Address_Line_1}</span>
                                                            <span class="output-value">{!quote.ShippingStreet}</span>
                                                        </div>

                                                        <div class="field-group output inline">
                                                            <span class="input-label">{!$Label.Postal_code}</span>
                                                            <span class="output-value">{!quote.ShippingPostalCode}</span>
                                                        </div>

                                                        <div class="field-group output inline">
                                                            <span class="input-label">{!$Label.City}</span>
                                                            <span class="output-value">{!quote.ShippingCity}</span>
                                                        </div>

                                                        <div class="field-group output inline">
                                                            <span class="input-label">{!$Label.Country}</span>
                                                            <span class="output-value">{!quote.ShippingCountry}</span>
                                                        </div>

                                                        <div class="field-group output inline">
                                                            <span class="input-label">{!$Label.State_Province}</span>
                                                            <span class="output-value">{!quote.ShippingState}</span>
                                                        </div>

                                                        <div class="field-group output inline">
                                                            <span class="input-label">{!$Label.VAT_number}</span>
                                                            <span class="output-value">{!quote.ShipToContact_VAT_Number__c}</span>
                                                        </div>

                                                        <!-- <div class="field-group output inline">
                                                            <span class="input-label">{!$Label.Phone}</span>
                                                            <span class="output-value">{!quote.ShipToContact_Phone__c}</span>
                                                        </div>

                                                        <div class="field-group output inline">
                                                            <span class="input-label">{!$Label.Email_address}</span>
                                                            <span class="output-value">{!quote.ShipToContact_Email__c}</span>
                                                        </div> -->

                                                        <div class="group-container shipping-instructions" id="shippingInstructions">
                                                            <h3 class="group-title">{!$Label.Shipping_instructions}</h3>

                                                            <div class="field-group output inline">
                                                                <span class="input-label">{!$Label.Attention}</span>
                                                                <!-- <span class="output-value">{!quote.IEC_Shipping_Instruction_attention__c}</span> -->
                                                                <span class="output-value">{!quote.ShipToContact_Name__c}</span>
                                                            </div>
                                                            <div class="field-group output inline">
                                                                <span class="input-label">{!$Label.Phone}</span>
                                                                <!-- <span class="output-value">{!quote.IEC_Shipping_Instruction_phone__c}</span> -->
                                                                <span class="output-value">{!quote.ShipToContact_Phone__c}</span>
                                                            </div>
                                                            <div class="field-group output inline">
                                                                <span class="input-label">{!$Label.Email}</span>
                                                                <!-- <span class="output-value">{!quote.IEC_Shipping_Instruction_email__c}</span> -->
                                                                <span class="output-value">{!quote.ShipToContact_Email__c}</span>
                                                            </div>
                                                            <div class="field-group output inline">
                                                                <span class="input-label">{!$Label.Message}</span>
                                                                <span class="output-value">{!quote.Shipping_Instruction__c}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </section>
                                                <!-- End shipping address section -->
                                            </div>
                                        </div>

                                        <div class="group-container group-shopping-cart">
                                            <div class="table-container your-order">
                                                <table class="data-table table-shopping-cart js-adjust-tooltip-placement">
                                                    
                                                    <!-- Start cart section -->
                                                    <tr class="heading">
                                                        <th class="product-name">{!$Label.Product_Name}</th>
                                                        <th class="product-number">{!$Label.Product_Number}</th>
                                                        <th class="quantity">{!$Label.Quantity}</th>
                                                        <th class="item-price">{!$Label.Item_Price}</th>
                                                        <th class="total-price">{!$Label.Total_Price}</th>
                                                    </tr>
                                                    
                                                    <apex:repeat value="{!quote.Orderitems}" var="item">
                                                    <tr class="item">
                                                        <td class="product-name">
                                                            <h2 class="item-name">{!item.Product_Name__c}</h2>
                                                            <div class="product-number">{!$Label.Product_Number}: {!item.Product_Number__c}</div>
                                                            
                                                            <apex:outputPanel rendered="{!item.Carrier_Tracking_Number__c != null}">
                                                            <div class="tracking-number">
                                                            {!$Label.Tracking_Number}: <br />  <apex:outputText value="{!item.Carrier_Tracking_URL__c}" escape="false" />
                                                            </div>
                                                            <div class="download-invoice">
                                                                <apex:outputPanel rendered="{!quote.Payment_Type__c != 'ICH'}">
                                                                <apex:outputLink value="/apex/IECInvoice?invoice={!item.Invoice_Number__c}" id="invoiceLink" target="_blank">{!$Label.Download_Invoice}</apex:outputLink>
                                                                </apex:outputPanel>
                                                                <apex:outputPanel rendered="{!quote.Payment_Type__c == 'ICH'}">
                                                                <a class="js-open-modal" data-target-modal="#js-modal-ICH-Customer" href="#">{!$Label.Download_Invoice}</a>
                                                                </apex:outputPanel>
                                                            </div>
                                                            </apex:outputPanel>
                                                            

                                                        </td>
                                                        <td class="product-number"><apex:outputText value="{!item.Product_Number__c}" /></td>

                                                        <td class="quantity">
                                                            <span class="input-label quantity">{!$Label.Quantity}: </span>
                                                            {!item.quantity}
                                                        </td>
                                                        <td class="price item-price">{!item.UnitPrice}</td>
                                                        <td class="price total-price">
                                                            <apex:outputText value="{0, Number, Currency}" >
                                                                <apex:param value="{!item.quantity * item.UnitPrice}" />
                                                            </apex:outputText>
                                                        </td>
                                                    </tr>
                                                    <apex:outputPanel rendered="{!item.Discount__c != null && item.Discount__c > 0}">
                                                    <tr class="promotion">
                                                        <td class="product-name">
                                                            <strong>{!$Label.Promotion}</strong>
                                                        </td>
                                                        <td class="product-number"></td>
                                                        <td class="quantity"></td>
                                                        <td class="price item-price"></td>
                                                        <td class="price total-price">
                                                            <apex:outputText value="{0, Number, Currency}" >
                                                                <apex:param value="{!item.Discount__c}" />
                                                            </apex:outputText>
                                                        </td>
                                                    </tr>
                                                    </apex:outputPanel>
                                                    
                                                    </apex:repeat>
                                                    
                                                    <tr class="total sub-total">
                                                        <td class="sub-total" colspan="4">{!$Label.Subtotal}</td>
                                                        <td class="price total-price">
                                                            <apex:outputText value="{0, Number, Currency}" >
                                                                <apex:param value="{!quote.SubTotal_Amount__c - quote.Discount_Amount__c}" />
                                                            </apex:outputText>
                                                        </td>
                                                    </tr>
                                                    <tr class="tax">
                                                        <td class="product-name" colspan="2">
                                                            {!$Label.Taxes}
                                                        </td>
                                                        <td class="quantity">
                                                        </td>
                                                        <td class="price item-price">
                                                        </td>
                                                        <td class="price total-price">
                                                            <apex:outputText value="{0, Number, Currency}" >
                                                                <apex:param value="{!quote.Taxes__c}" />
                                                            </apex:outputText>
                                                        </td>
                                                    </tr>
                                                    <tr class="shipping">
                                                        <td class="product-name" colspan="2">{!$Label.Shipping}</td>
                                                        <td class="quantity"></td>
                                                        <td class="price item-price"></td>
                                                        <td class="price total-price">
                                                            <apex:outputText value="{0, Number, currency}">
                                                                <apex:param value="{!quote.Total_Freight_Charge__c}" />
                                                            </apex:outputText>
                                                            <apex:outputPanel rendered="{!quote.Total_Freight_Charge__c == null}" >$0.00
                                                            </apex:outputPanel>
                                                        </td>
                                                    </tr>
                                                    <tr class="handling">
                                                        <td class="product-name" colspan="2">
                                                            {!$Label.Handling}
                                                        </td>
                                                        <td class="quantity">
                                                        </td>
                                                        <td class="price item-price">
                                                        </td>
                                                        <td class="price total-price">
                                                            <apex:outputText value="{0, Number, currency}">
                                                                <apex:param value="{!quote.Total_handling_charges__c}" />
                                                            </apex:outputText>
                                                            <apex:outputPanel rendered="{!quote.Total_handling_charges__c == null}" >$0.00
                                                            </apex:outputPanel>
                                                        </td>
                                                    </tr>
                                                    <tr class="total">
                                                        <td class="total" colspan="5">
                                                            {!$Label.IDCard_Total}
                                                        </td>
                                                        <td class="price total-price">
                                                            <apex:outputText value="{0, Number, Currency}" >
                                                                <apex:param value="{!quote.Total_Amount__c}" />
                                                            </apex:outputText>
                                                        </td>
                                                    </tr>
                                                    <!-- End cart section -->
                                                </table>                                                        
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="footer-actions">
                                    <ul class="list actions">
                                        <li><a href="{!$Site.BaseUrl}/IEC_ProductList" class="button secondary">{!$Label.Button_Continue_Shopping}</a></li>
                                    </ul>
                                </div>

                            </apex:outputPanel>
                            
                            <apex:outputPanel layout="none" rendered="{!NOT(quoteGenerated)}">                          
                                <div class="process">
                                    <ol class="list steps">
                                        <li class="step step-1"><a href="{!$Site.BaseUrl}/IEC_CustomerInformation">{!$Label.PageTitleCustomerInformation}</a></li>
                                        <li class="step step-2 active"><a href="javascript:void(0);">{!$Label.PageTitleShippingPayment}</a></li>
                                        <li class="step step-3 disabled"><a href="javascript:void(0);">{!$Label.PageTitleConfirmOrder}</a></li>
                                    </ol>
                                </div>

                                <apex:outputPanel layout="block" id="errorBloc">
                                    <!-- Error Messages -->
                                    <apex:outputPanel styleClass="alert error" rendered="{!hasError}" layout="block">
                                        <apex:pageMessages escape="false"/>
                                    </apex:outputPanel>

                                    <!-- Success Message -->
                                    <apex:outputPanel styleClass="alert success" rendered="{!hasConfirm}" layout="block">
                                        <apex:pageMessages escape="false"/>
                                    </apex:outputPanel>
                                </apex:outputPanel>
                               
                                <apex:form id="frmShipToAddress" rendered="{!AND(vfOrder.orderItems != null, vfOrder.orderItems.size > 0)}">

                                    <apex:inputHidden value="{!orderPaymentType}" id="orderPaymentType" />              
                                    <apex:inputHidden id="shipToSameAsBilTo" value="{!vfOrder.shipToSameAsBilTo}" />
                                    <apex:inputHidden value="{!newCreditCardPaymentId}" id="hiddenNewCreditCardPaymentId" />
                                    <apex:inputHidden value="{!defaultPaymentMethodId}" id="hiddenDefaultPaymentMethodId" />

                                    <input type="hidden" id="total_items" value="{!vfOrder.orderItems.size}" />

                                    <apex:actionFunction name="changeShipToAddressOption" action="{!changeShipToAddressOption}" oncomplete="sendShipToCustomerToSAP();" reRender="shipToLocation,shippingInstructionSection" status="runningShipToStatus" />
                                    <apex:actionFunction name="sendShipToCustomerToSAP" action="{!sendShipToCustomerToSAP}" oncomplete="calculateTax();" status="runningShipToStatus" />
                                    <apex:actionFunction name="calculateTax" action="{!calculateFreightTaxDTO}" status="runningShipToStatus" reRender="orderTotalTaxes,orderTotalFreight,orderTotalHandling,orderTotalAmount" />

                                    <apex:actionFunction name="generateQuote" action="{!generateQuote}" status="quoteStatus" oncomplete="javascript:closeModal('#quote-modal')" reRender="inner_wrapper" />
                                    

                                    <apex:actionFunction name="refreshShipToProvinces" oncomplete="selectDefaultState()" reRender="errorBloc,displayButton,billToStateBloc,postalCodeBlock" 
                                        action="{!refreshShipToProvinces}" status="btStatus">
                                        <apex:param name="countryCode" value="" />
                                    </apex:actionFunction>

                                    <apex:actionFunction action="{!addCreditCard}" name="proceedToAddNewBackend" status="loadingStatus" rerender="card_list,errorBloc,displayButton,cardIframe" />
                                    
                                    <apex:actionFunction action="{!displayCallBackfailure}" status="loadingStatus" name="displayCallBackfailureJS" rerender="card_list,errorBloc,displayButton,cardIframe">
                                         <apex:param name="errMsg" value="" assignTo="{!sErrorMsgFromHPM}"/>
                                     </apex:actionFunction>

                                    <div class="is-hidden" id="loader"><img src="{!$Resource.IEC_progress}" alt="x" /></div>
                                    <apex:actionStatus id="loadingStatus">
                                        <apex:facet name="start">&nbsp;<img src="{!$Resource.IEC_progress}" alt="x" /></apex:facet>
                                    </apex:actionStatus>

                                    <apex:actionFunction action="{!removeCreditCard}" name="removeCreditCard" status="deleteCCStatus" rerender="card_list" oncomplete="closeModal('#modal-delete-credit-card');document.location.reload(true);" />

                                    <apex:actionFunction action="{!setSelectedCreditCard}" name="startDeleteCreditCard" rerender="delete_block" oncomplete="openModal('#modal-delete-credit-card')">
                                        <apex:param name="zId" value="" assignTo="{!selectedCreditCardId}"/>
                                    </apex:actionFunction>


                                    <section class="checkout-container">
                                        <h1 class="page-title">{!$Label.PageTitleShippingPayment}</h1>

                                        <!-- Personal Information -->
                                        <section class="group-container personal-info">
                                            <h2 class="group-title">Personal information</h2>
                                            <div class="row">
                                                <div class="columns small-12 medium-6">
                                                    <div class="field-group output inline">
                                                        <span class="input-label">{!$Label.Company_name}</span>
                                                        <span class="output-value">{!vfOrder.billToContact.accountName}</span>
                                                    </div>
                                                    <div class="field-group output inline">
                                                        <span class="input-label">{!$Label.Salutation}</span>
                                                        <span class="output-value">{!vfOrder.billToContact.contactSalutation}</span>
                                                    </div>
                                                    <div class="field-group output inline">
                                                        <span class="input-label">{!$Label.First_name}</span>
                                                        <span class="output-value">{!vfOrder.billToContact.contactFirstName}</span>
                                                    </div>
                                                    <div class="field-group output inline">
                                                        <span class="input-label">{!$Label.Last_name}</span>
                                                        <span class="output-value">{!vfOrder.billToContact.contactLastName}</span>
                                                    </div>
                                                </div>
                                                <div class="columns small-12 medium-6">
                                                    <div class="field-group output inline">
                                                        <span class="input-label">{!$Label.Phone}</span>
                                                        <span class="output-value">{!vfOrder.billToAddress.phone}</span>
                                                    </div>                                              
                                                    <div class="field-group output inline">
                                                        <span class="input-label">{!$Label.Email_address}</span>
                                                        <span class="output-value">{!vfOrder.billToAddress.email}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </section>

                                        <div class="separator"></div>
                                        
                                        <!-- Billing & Shipping -->
                                        <div class="row">
                                            <div class="columns small-12 medium-6">
                                                <!-- Billing Address -->
                                                <section class="group-container billing-address">
                                                    <h2 class="group-title">Billing address</h2>
                                                    <div class="field-group output inline">
                                                        <span class="input-label">{!$Label.Address_Line_1}</span>
                                                        <span class="output-value">{!vfOrder.billToAddress.street1}</span>
                                                    </div>
                                                    <div class="field-group output inline">
                                                        <span class="input-label">{!$Label.Postal_code}</span>
                                                        <span class="output-value">{!vfOrder.billToAddress.postalCode}</span>
                                                    </div>
                                                    <div class="field-group output inline">
                                                        <span class="input-label">{!$Label.City}</span>
                                                        <span class="output-value">{!vfOrder.billToAddress.city}</span>
                                                    </div>
                                                    <div class="field-group output inline">
                                                        <span class="input-label">{!$Label.Country}</span>
                                                        <span class="output-value">{!vfOrder.billToAddress.countryLabel}</span>
                                                    </div>
                                                    <div class="field-group output inline">
                                                        <span class="input-label">{!$Label.Region}</span>
                                                        <span class="output-value">{!vfOrder.billToAddress.stateLabel}</span>
                                                    </div>
                                                    <div class="field-group output inline">
                                                        <span class="input-label">{!$Label.PO_number}</span>
                                                        <span class="output-value">{!vfOrder.orderPONumber}</span>
                                                    </div>
                                                    <div class="field-group output inline">
                                                        <span class="input-label">{!$Label.Invoice_text}</span>
                                                        <span class="output-value">{!vfOrder.billToInvoiceText}</span>
                                                    </div>
                                                    <div class="field-group output inline">
                                                        <span class="input-label">{!$Label.VAT_number}</span>
                                                        <span class="output-value">{!vfOrder.billToAddress.vatNumber} </span>
                                                    </div>
                                                </section>
                                            </div>
                                            <apex:outputPanel layout="block" styleClass="columns small-12 medium-6" id="shipToAddressBloc">
                                                <input type="hidden" id="hiddenShippingRegion" />
                                                <!-- Shipping Address -->
                                                <section class="group-container shipping-address">
                                                    <h2 class="group-title">Shipping address</h2>
                                                    
                                                    <div class="field-group radio inline">
                                                        <div class="radio-box">
                                                            <div class="custom-user-input radio">
                                                                <input class="user-input radio validate[required]" type="radio" name="shipping-address" onclick="same_address_selected();" id="shipping-address-same" />
                                                                <label class="custom-radio" for="shipping-address-same"><i class="icon"></i></label>
                                                            </div>
                                                            <label class="input-label" for="shipping-address-same">Same as billing address</label>
                                                        </div>
                                                        <div class="radio-box">
                                                            <div class="custom-user-input radio">
                                                                <input class="user-input radio validate[required]" type="radio" name="shipping-address" onclick="different_shipping_address();" id="shipping-address-different"/>
                                                                <label class="custom-radio" for="shipping-address-different"><i class="icon"></i></label>
                                                            </div>
                                                            <label class="input-label" for="shipping-address-different">Ship to a different address</label>
                                                        </div>
                                                        <apex:actionStatus id="runningShipToStatus">
                                                            <apex:facet name="start">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src="{!$Resource.IEC_progress}" alt="x" /></apex:facet>
                                                        </apex:actionStatus>
                                                    </div>

                                                    <div class="shipping-address-container {!IF(vfOrder.shipToSameAsBilTo,'is-hidden','')}">
                                                        <div class="field-group select choose-address row">
                                                            <div class="columns medium-6">
                                                                <div class="custom-user-input select">
                                                                    <i class="icon chevron-down"></i>
                                                                    <apex:selectList value="{!sfOrder.ShipTo_Location__c}" id="shipToLocation" multiselect="false" size="1" styleClass="user-input select validate[required]">
                                                                        <apex:selectOptions value="{!shippingAddresses}"/>
                                                                        <apex:actionSupport event="onchange" action="{!changeShipToAddress}" reRender="errorBloc,displayButton,shipToLocation,shippingInstructionSection,orderTotalTaxes,orderTotalFreight,orderTotalHandling,orderTotalAmount" status="runningShipToStatus" />
                                                                    </apex:selectList>
                                                                </div>
                                                            </div>
                                                            <div class="columns medium-6" id="addNewAddress">
                                                                <a onclick="javascript:showNewAddressForm();" href="javascript:;">Add a new address</a>
                                                            </div>
                                                        </div>
                                                        
                                                        <apex:outputPanel id="shippingFormValidationError">
                                                            <apex:outputPanel styleClass="alert error" rendered="{!hasError}" layout="block">
                                                                <apex:pageMessages escape="false"/>
                                                                <script type="text/javascript">
                                                                    showNewAddressForm();
                                                                </script>
                                                            </apex:outputPanel>
                                                        </apex:outputPanel>

                                                        <div class="form-address is-hidden">
                                                            <div class="field-group text inline">
                                                                <label>
                                                                    <span class="input-label">Address nickname <span class="required">*</span> <span class="optional">(i.e work, home)</span></span>
                                                                    <apex:inputText styleClass="user-input text validate[required]" id="shippingAddressName" value="{!newShipToAddress.addressName}" />
                                                                </label>
                                                            </div>

                                                            <div class="field-group text inline">
                                                                <label>
                                                                    <span class="input-label">{!$Label.Address_Line_1} <span class="required">*</span></span>
                                                                    <apex:inputText styleClass="user-input text validate[required]" id="shippingAddress1" value="{!newShipToAddress.street1}" />
                                                                </label>
                                                            </div>
                                                            <apex:outputPanel id="postalCode">
                                                            <div class="field-group text inline">
                                                                <label>
                                                                    <span class="input-label">{!$Label.Postal_code} <span style="{!if(newShipToAddress.isPostalCodeRequired,'','display: none;')}" class="required">*</span></span>
                                                                    <apex:inputText styleClass="user-input text" id="shippingPostalCode" value="{!newShipToAddress.postalCode}" />{!newShipToAddress.isPostalCodeRequired}
                                                                </label>
                                                            </div>
                                                            </apex:outputPanel>
                                                            <div class="field-group text inline">
                                                                <label>
                                                                    <span class="input-label">{!$Label.City} <span class="required">*</span></span>
                                                                    <apex:inputText styleClass="user-input text validate[required]" id="shippingCity" value="{!newShipToAddress.city}" />
                                                                </label>
                                                            </div>
                                                            <div class="field-group select inline">
                                                                <span class="input-label">{!$Label.Country} <span class="required">*</span></span>
                                                                <div class="custom-user-input select">
                                                                    <i class="icon chevron-down"></i>
                                                                    <apex:selectList id="shippingCountry" value="{!newShipToAddress.countryCode}" size="1" styleClass="user-input select validate[required]">
                                                                        <apex:selectOptions value="{!availableCountries}"/>
                                                                        <apex:actionSupport event="onchange" action="{!refreshShipToProvinces}" reRender="shippingFormValidationError,billToStateBloc, postalCodeBlock,postalCode" status="btStatus" />
                                                                    </apex:selectList>
                                                                    <apex:actionStatus id="btStatus">
                                                                        <apex:facet name="start">&nbsp;<img src="{!$Resource.IEC_progress}" alt="x" /></apex:facet>
                                                                    </apex:actionStatus>
                                                                </div>
                                                            </div>

                                                            <apex:outputPanel styleClass="field-group select inline" id="billToStateBloc" layout="block">
                                                                <apex:outputPanel styleClass="input-label" rendered="{!newAddressAvailableStates.size > 0}">
                                                                    {!$Label.Region} <span class="required">*</span>
                                                                </apex:outputPanel>
                                                                <apex:outputPanel styleClass="custom-user-input select validate[required]" layout="block" rendered="{!newAddressAvailableStates.size > 0}">
                                                                    <i class="icon chevron-down"></i>
                                                                    <apex:selectList id="shippingRegion" value="{!newShipToAddress.stateCode}" styleClass="user-input select validate[required]" size="1">
                                                                        <apex:selectOptions value="{!newAddressAvailableStates}"/>
                                                                        <apex:actionSupport event="onchange" action="{!regionChanged}" reRender="errorBloc,billToStateBloc" status="btStatus" />
                                                                    </apex:selectList>
                                                                </apex:outputPanel>
                                                            </apex:outputPanel>

                                                            <div class="field-group text inline">
                                                                <label>
                                                                    <span class="input-label">VAT # <span class="optional">optional</span></span>
                                                                    <apex:inputText styleClass="user-input text" value="{!newShipToAddress.vatNumber}" />
                                                                </label>
                                                                <p class="input-description">Provide us with your VAT # for faster processing of your order.</p>
                                                            </div>

                                                            <div class="field-group text inline">
                                                                <label>
                                                                    <span class="input-label">Phone <span class="required">*</span></span>
                                                                    <apex:inputText styleClass="user-input text validate[required]" id="newShippingPhone" value="{!newShipToAddress.phone}" />
                                                                </label>
                                                            </div>
                                                            <div class="field-group text inline">
                                                                <label>
                                                                    <span class="input-label">Email address <span class="required">*</span></span>
                                                                    <apex:inputText styleClass="user-input text validate[required]" id="newShippingEmail" value="{!newShipToAddress.email}" />
                                                                </label>
                                                            </div>
                                                            <div class="action text-right">
                                                                <ul class="list actions">
                                                                    <li><apex:commandLink styleClass="text-link" value="Cancel" onclick="javascript:hideNewAddressForm();" /></li>
                                                                    <li><apex:commandLink styleClass="button secondary" status="saveAdrStatus" action="{!saveNewAddress}" reRender="shippingFormValidationError, shipToAddressBloc" value="Save address" oncomplete="selectDefaultShipToRadio(); sendShipToCustomerToSAP();" /></li>
                                                                </ul>
                                                                <apex:actionStatus id="saveAdrStatus">
                                                                    <apex:facet name="start">&nbsp;<img src="{!$Resource.IEC_progress}" alt="x" /></apex:facet>
                                                                </apex:actionStatus>
                                                                <!-- <a class="button secondary" href="#">Save address</a> -->
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Shipping Instructions -->
                                                    <!-- <div class="group-container shipping-instructions"> -->
                                                    <apex:outputPanel layout="block" styleClass="group-container shipping-instructions" id="shippingInstructionSection">
                                                        <h3 class="group-title">Shipping instructions <span class="optional">(optional)</span></h3>
                                                        <div class="field-group text inline">
                                                            <label>
                                                                <span class="input-label">{!$Label.Company_name}</span>
                                                                <apex:inputText styleClass="user-input text" value="{!vfOrder.shipToContact.accountName}" />
                                                            </label>
                                                        </div>
                                                        <div class="field-group text inline">
                                                            <label>
                                                                <span class="input-label">Attention</span>
                                                                <!-- <apex:inputText styleClass="user-input text" value="{!vfOrder.shipToInstructionAttention}" /> -->
                                                                <apex:inputText styleClass="user-input text" value="{!vfOrder.shipToContact.contactName}" />
                                                            </label>
                                                        </div>
                                                        <div class="field-group text inline">
                                                            <label>
                                                                <span class="input-label">Phone</span>
                                                                <!-- <apex:inputText styleClass="user-input text" value="{!vfOrder.shipToInstructionPhone}" /> -->
                                                                <apex:inputText styleClass="user-input text" value="{!vfOrder.shipToContact.phone}" />
                                                            </label>
                                                        </div>
                                                        <div class="field-group text inline">
                                                            <label>
                                                                <span class="input-label">Email</span>
                                                                <!-- <apex:inputText styleClass="user-input text" value="{!vfOrder.shipToInstructionEmail}" /> -->
                                                                <apex:inputText styleClass="user-input text" value="{!vfOrder.shipToContact.email}" />
                                                            </label>
                                                        </div>
                                                        <div class="field-group textarea inline">
                                                            <label>
                                                                <span class="input-label text-top">Message</span>
                                                                <apex:inputTextarea rows="5" styleClass="user-input textarea" value="{!vfOrder.shipToInstructions}" />
                                                            </label>
                                                        </div>
                                                    </apex:outputPanel>
                                                    <!-- </div> -->
                                                </section>
                                            </apex:outputPanel>
                                        </div>
                                        
                                        <div class="separator"></div>
                                        
                                        <!-- Your Order -->
                                        <section class="group-container your-order">
                                            <h2 class="group-title">Your order</h2>
                                            <apex:outputPanel styleClass="table-container" id="yourOrder" layout="block">
                                                <div class="header text-right table-actions">
                                                    <apex:outputLink value="{!$Site.BaseUrl}/IEC_ShoppingCart" rendered="{!vfOrder.orderPreviousType != 'Quote'}">Edit Order</apex:outputLink>
                                                    <!-- <a href="{!$Site.BaseUrl}/IEC_ShoppingCart">Edit Order</a> -->
                                                </div>

                                                <table class="data-table table-shopping-cart js-adjust-tooltip-placement">
                                                    <tr class="heading">
                                                        <th class="product-name">Product Name</th>
                                                        <th class="product-number">Product Number</th>
                                                        <th class="promotion-code">Promo code</th>
                                                        <th class="quantity">Quantity</th>
                                                        <th class="item-price">Item Price</th>
                                                        <th class="total-price">Total Price</th>
                                                    </tr>

                                                    <apex:variable var="itemCount" value="{!0}"/>
                                                    <apex:variable var="totalAmount" value="{!0}"/>
                                                    <apex:repeat value="{!vfOrder.orderItems}" var="item">
                                                        <apex:variable var="itemCount" value="{!itemCount + 1}"/>
                                                        <tr class="item">
                                                            <td class="product-name">
                                                                <h2 class="item-name">{!item.productName}</h2>
                                                                <div class="product-number">Product Number: {!item.productCode}</div>
                                                                
                                                                <div class="field-group checkbox renewal-and-terms">
                                                                    <!-- Auto Renew -->
                                                                    <apex:outputPanel layout="block" styleClass="checkbox-box with-tooltip" rendered="{!item.availableForSubscription}">
                                                                        <div class="custom-user-input checkbox">
                                                                            <!-- <input class="user-input checkbox auto-renewal-item" type="checkbox" id="auto-renewal-{!itemCount}" />
                                                                            <apex:inputHidden value="{!item.isAutoRenew}" /> -->
                                                                            
                                                                            <apex:inputCheckbox value="{!item.isAutoRenew}" id="auto" styleClass="user-input checkbox auto-renewal-{!itemCount} auto-renewal-item" />

                                                                            <label class="custom-checkbox auto-renewal-{!itemCount}" for=""><i class="icon"></i></label>
                                                                        </div>
                                                                        <label class="input-label auto-renewal-{!itemCount}" for="">{!$Label.PurchaseAsAutoRenew}</label>
                                                                        <div class="tooltip-container js-tooltip" data-placement="right">
                                                                            <a href="#" class="tooltip-icon"><span class="reader-only">Info</span><i class="fa fa-info-circle"></i></a>
                                                                            <div class="tooltip-description">
                                                                                <h3 class="title">{!$Label.PurchaseAsAutoRenew}</h3>
                                                                                <p>{!$Label.PurchaseAsAutoRenewInfo}</p>
                                                                            </div>
                                                                        </div>
                                                                    </apex:outputPanel>

                                                                    <!-- Terms & Conditions -->
                                                                    <apex:outputPanel layout="block" styleClass="checkbox-box" rendered="{!item.acceptedTnC != null}">
                                                                        <div class="custom-user-input checkbox">
                                                                            <!-- <input class="user-input checkbox validate[required]" onclick="javascript:viewTnC({!itemCount},'{!item.acceptedTnC.attachmentURL}')" type="checkbox" id="accept-terms-{!itemCount}" />
                                                                            <apex:inputHidden value="{!item.acceptedTnC.accepted}" /> -->   
                                                                            <apex:inputCheckbox value="{!item.acceptedTnC.accepted}" id="tnc" styleClass="user-input checkbox validate[required] accept-terms-{!itemCount}" />
                                                                            <label class="custom-checkbox accept-terms-{!itemCount}" for=""><i class="icon"></i></label>
                                                                        </div>
                                                                        <label class="input-label accept-terms-{!itemCount}" for="">
                                                                            <a href="javascript:;" onclick="viewTnC({!itemCount},'{!item.acceptedTnC.attachmentURL}')">Accept terms and conditions</a>
                                                                        </label>
                                                                    </apex:outputPanel>
                                                                </div>
                                                            </td>
                                                            <td class="product-number">{!item.productCode}</td>
                                                            <td class="promotion-code">
                                                                <!-- Promo Code applied -->
                                                                <apex:outputPanel styleClass="entered-promotion-code clearfix" rendered="{!item.couponCode != null}">
                                                                    <div class="pull-left">
                                                                        <span class="input-label promotion-code">Promo code: </span>
                                                                        <strong>{!item.couponCode}</strong>
                                                                        <apex:commandLink action="{!removeCoupon}" value="Remove" rerender="yourOrder,errorBloc" status="removeStatus">
                                                                            <apex:param name="firstParam" assignTo="{!updateItemId}" value="{!item.orderItemId}" />
                                                                        </apex:commandLink>
                                                                        <apex:actionStatus id="removeStatus">
                                                                            <apex:facet name="start">
                                                                                <img src="{!$Resource.IEC_progress}" border="0" width="43" height="15" />
                                                                            </apex:facet>
                                                                        </apex:actionStatus>
                                                                        <!-- <a class="action-link" href="#">Remove</a> -->
                                                                    </div>
                                                                    <div class="pull-right">
                                                                        <span class="promotion-price">
                                                                            <apex:outputText value="{0, number, currency}">
                                                                                <apex:param value="{!-item.discountAmount}"/>
                                                                            </apex:outputText>
                                                                        </span>
                                                                    </div>
                                                                </apex:outputPanel>

                                                                <!-- Apply Promo Code -->
                                                                <apex:variable value="1" var="couponCodeNotExist" rendered="{!item.couponCode == null}">
                                                                    <span class="input-label promotion-code">Promo code: </span>
                                                                    <apex:inputText value="{!item.couponCode}" rendered="{!vfOrder.orderPreviousType != 'Quote'}" styleClass="user-input promotion-code" />&nbsp;
                                                                    <apex:commandLink action="{!applyCoupon}" rendered="{!vfOrder.orderPreviousType != 'Quote'}" value="apply" rerender="yourOrder,errorBloc" status="applyStatus" oncomplete="setLabelFor();$(window).scrollTop(0);">
                                                                        <apex:param name="firstParam" assignTo="{!updateItemId}" value="{!item.orderItemId}" />
                                                                    </apex:commandLink>&nbsp;
                                                                    <apex:actionStatus id="applyStatus">
                                                                    <apex:facet name="start">
                                                                        <img src="{!$Resource.IEC_progress}" border="0" width="43" height="15" />
                                                                    </apex:facet>
                                                                </apex:actionStatus>
                                                                    <!-- <a class="action-link" href="#">Apply</a> -->
                                                                </apex:variable>
                                                            </td>
                                                            <td class="quantity">
                                                                <span class="input-label quantity">Quantity: </span>
                                                                {!item.quantityStripped}
                                                            </td>
                                                            <td class="price item-price">
                                                                <apex:outputText value="{0, number, currency}">
                                                                    <apex:param value="{!item.unitPrice}" />
                                                                </apex:outputText>
                                                            </td>
                                                            <td class="price total-price">
                                                                <apex:outputText value="{0, number, currency}">
                                                                    <apex:param value="{!item.subTotal}"/>
                                                                </apex:outputText>
                                                            </td>
                                                        </tr>
                                                        <apex:variable value="1" var="hasDiscounts" rendered="{!AND(item.charges!=null, item.charges.size>0)}">
                                                            <tr class="promotion">
                                                                <td class="product-name">
                                                                    <strong>Discounts</strong>
                                                                    <div class="tooltip-container js-tooltip" data-placement="right">
                                                                        <a href="#" class="tooltip-icon"><span class="reader-only">Info</span><i class="fa fa-info-circle"></i></a>
                                                                        <span class="tooltip-description">
                                                                            <h3 class="title">Discount Details</h3>
                                                                            <apex:repeat value="{!item.charges}" var="discount">
                                                                                <div class="">
                                                                                    {!discountLabels[discount.discountType]} : 
                                                                                    <apex:outputText value="{0, number, currency}">
                                                                                        <apex:param value="{!-discount.discountAmount}"/>
                                                                                    </apex:outputText>
                                                                                </div>
                                                                            </apex:repeat>
                                                                        </span>
                                                                    </div>
                                                                    <!-- <br />
                                                                    <apex:repeat value="{!item.charges}" var="discount">
                                                                    &nbsp;&nbsp; - {!discountLabels[discount.discountType]} <br />
                                                                    </apex:repeat> -->
                                                                </td>
                                                                <td class="product-number"></td>
                                                                <td class="promotion-code"></td>
                                                                <td class="quantity"></td>
                                                                <td class="price item-price"></td>
                                                                <td class="price total-price">
                                                                    <apex:outputText value="{0, number, currency}">
                                                                        <apex:param value="{!-item.discountAmount}"/>
                                                                    </apex:outputText>
                                                                    
                                                                    <!-- <br />
                                                                    <apex:repeat value="{!item.charges}" var="discount">
                                                                        <apex:outputText value="{0, number, currency}">
                                                                            <apex:param value="{!-discount.discountAmount}"/>
                                                                        </apex:outputText>
                                                                        <br />
                                                                    </apex:repeat> -->
                                                                </td>
                                                            </tr>
                                                        </apex:variable>
                                                    </apex:repeat>
                                                    <tr class="total sub-total">
                                                        <td class="sub-total" colspan="5">Subtotal</td>
                                                        <td class="price total-price">
                                                            <apex:outputText value="{0, number, currency}">
                                                                <apex:param value="{!vfOrder.orderSubTotalAmount-vfOrder.orderDiscountAmount}"/>
                                                            </apex:outputText>
                                                        </td>
                                                    </tr>
                                                    <!-- <tr class="tax">
                                                        <th colspan="6">Taxes</th>
                                                    </tr> -->
                                                    <tr class="tax">
                                                        <td class="product-name" colspan="3">{!$Label.Taxes}</td>
                                                        <td class="quantity"></td>
                                                        <td class="price item-price"></td>
                                                        <td class="price total-price">
                                                            <apex:outputText value="{0, number, currency}" id="orderTotalTaxes">
                                                                <apex:param value="{!vfOrder.taxes}"/>
                                                            </apex:outputText>
                                                        </td>
                                                    </tr>
                                                   <!--  <tr class="shipping handling">
                                                        <th colspan="6">Shipping and handling</th>
                                                    </tr> -->
                                                    <tr class="shipping">
                                                        <td class="product-name" colspan="3">{!$Label.Shipping}</td>
                                                        <td class="quantity"></td>
                                                        <td class="price item-price"></td>
                                                        <td class="price total-price">
                                                            <apex:outputText value="{0, number, currency}" id="orderTotalFreight">
                                                                <apex:param value="{!vfOrder.totalFreightCharge}"/>
                                                            </apex:outputText>
                                                        </td>
                                                    </tr>
                                                    <tr class="handling">
                                                        <td class="product-name" colspan="3">{!$Label.Handling}</td>
                                                        <td class="quantity"></td>
                                                        <td class="price item-price"></td>
                                                        <td class="price total-price">
                                                            <apex:outputText value="{0, number, currency}" id="orderTotalHandling">
                                                                <apex:param value="{!vfOrder.totalHandlingCharges}"/>
                                                            </apex:outputText>
                                                        </td>
                                                    </tr>
                                                    <tr class="total">
                                                        <td class="total" colspan="5">{!$Label.IDCard_Total}</td>
                                                        <td class="price total-price">
                                                            <apex:outputText value="{0, number, currency}" id="orderTotalAmount">
                                                                <apex:param value="{!vfOrder.orderTotalAmount}"/>
                                                            </apex:outputText>
                                                        </td>
                                                    </tr>
                                                </table>

                                                <div class="footer text-right table-actions">
                                                    <apex:outputLink value="{!$Site.BaseUrl}/IEC_ShoppingCart" rendered="{!vfOrder.orderPreviousType != 'Quote'}">Edit Order</apex:outputLink>
                                                    <!-- <a href="{!$Site.BaseUrl}/IEC_ShoppingCart">Edit Order</a> -->
                                                </div>
                                            </apex:outputPanel>
                                        </section>

                                        <div class="separator"></div>
                                            
                                        <!-- Payment Methods -->
                                        <section class="group-container payment-method">
                                            <h2 class="group-title">Payment method</h2>
                                            

                                            <div class="field-group radio payment-method js-adjust-tooltip-placement js-payment-method">
                                                <div class="field-group radio inline">
                                                    <apex:variable var="pmCount" value="{!0}"/>
                                                    <apex:repeat value="{!paymentMethods}" var="pm">
                                                        <apex:variable var="pmCount" value="{!pmCount+1}"/>
                                                        <div class="radio-box">
                                                            <div class="custom-user-input radio">
                                                                <input class="user-input radio pm" type="radio" name="payment-method" id="payment-method-{!pmCount}" value="{!pm}" />
                                                                <label class="custom-radio" for="payment-method-{!pmCount}"><i class="icon"></i></label>
                                                            </div>
                                                            <label class="input-label" for="payment-method-{!pmCount}">{!pm}</label>
                                                            <apex:outputPanel layout="block" styleClass="tooltip-container js-tooltip is-hidden bankTransfert" html-data-placement="right" rendered="{!pm=='Bank Transfer'}">
                                                                <a href="#" class="tooltip-icon"><span class="reader-only">Info</span><i class="fa fa-exclamation-triangle"></i></a>
                                                                <div class="tooltip-description">
                                                                    <p>Bank transfer is not available when an item is set to auto renewal.</p>
                                                                </div>
                                                            </apex:outputPanel>
                                                        </div>
                                                    </apex:repeat>
                                                </div>
                                            </div>

                                            <apex:outputPanel id="card_list" styleClass="payment-method-container" layout="block">
                                                <apex:inputHidden id="ccId" value="{!orderCreditCardId}" />
                                                <div class="table-container">
                                                    <table class="data-table table-saved-cards js-card-data-table">
                                                        <caption class="table-caption">Saved cards</caption>
                                                        <tr class="heading">
                                                            <th class="card">Saved cards</th>
                                                            <th class="name">Name printed on card</th>
                                                            <th class="date" colspan="2">Expires</th>
                                                        </tr>
                                                        <apex:variable var="index" value="{!1}" />
                                                        <apex:repeat value="{!creditCards}" var="card">
                                                            
                                               <apex:inputHidden rendered="{!card.isDefault}" value="{!card.zId}" id="defaultCreditCard" />
                                                            <!-- <tr>
                                                                <td colspan="3"><apex:inputHidden rendered="{!card.isDefault}" value="{!card.zId}" id="defaultCreditCard" /></td>
                                                            </tr> -->
                                               
                                                            <tr class="item {!IF(card.isDefault, ' is-selected ', '')}">
                                                                <td class="card">
                                                                    <div class="field-group radio">
                                                                        <div class="radio-box">
                                                                            <div class="custom-user-input radio">
                                                                                <!-- {!sfOrder.Zuora_Credit_Card_Id__c} -- {!card.zId} -->
                                                                                <apex:variable value="1" var="isDefault" rendered="{!OR(AND(sfOrder.Zuora_Credit_Card_Id__c!=null,card.zId == sfOrder.Zuora_Credit_Card_Id__c), AND(sfOrder.Zuora_Credit_Card_Id__c==null,card.isDefault))}">
                                                                                    <input class="user-input radio" type="radio" value="{!card.zId}" name="card-type" checked="checked" id="saved-card-{!index}" />
                                                                                </apex:variable>
                                                                                <apex:variable value="0" var="notDefault" rendered="{!card.zId != sfOrder.Zuora_Credit_Card_Id__c}">
                                                                                    <input class="user-input radio" type="radio" value="{!card.zId}" name="card-type" id="saved-card-{!index}" />
                                                                                </apex:variable>
                                                                                <label class="custom-radio" for="saved-card-{!index}"><i class="icon"></i></label>
                                                                            </div>
                                                                            <label class="input-label" for="saved-card-{!index}">
                                                                                <span class="card-image">
                                                                                    <apex:variable var="ccLogo" value="img/components/icons/credit-card/{!card.creditCardType}.png"/>
                                                                                    <img src="{!URLFOR($Resource.EcommerceAssets, ccLogo)}" alt="{!card.creditCardType}" />
                                                                                </span>
                                                                                <span class="card-name">
                                                                                    <strong>{!card.creditCardType}</strong>
                                                                                    <span class="ending-number">
                                                                                        {!card.creditCardMaskNumber}  
                                                                                        <apex:variable value="1" var="isExpired" rendered="{!card.isExpired}">
                                                                                            <i class="text-error">(expired)</i>
                                                                                        </apex:variable>
                                                                                    </span>
                                                                                </span>                                                                         
                                                                            </label>
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                                <td class="name">
                                                                    <strong class="label show-for-small">Name printed on card</strong>
                                                                    <span class="value">{!card.holderName}</span>
                                                                </td>
                                                                <td class="date">
                                                                    <strong class="label show-for-small">Expires</strong>
                                                                    <span class="value">{!card.expirationMonth}/{!card.expirationYear}</span>
                                                                </td>
                                                                <td class="action">
                                                                    <apex:outputLink value="javascript:;" onclick="startDeleteCreditCard('{!card.zId}');" html-data-target-modal="#js-modal-delete-credit-card" rendered="{!NOT(card.isDefault)}">Remove</apex:outputLink>
                                                                </td>
                                                            </tr>
                                                            <apex:variable var="index" value="{!index+1}" />
                                                        </apex:repeat>
                                                    </table>
                                                    <div class="footer table-actions">
                                                        <a class="icon plus" href="javascript:;" onclick="openModal('#modal-add-credit-card')">Add card</a>
                                                    </div>
                                                </div>
                                            </apex:outputPanel>
                                        </section>
                                    </section>

                                    <div class="footer-actions text-right">
                                        <apex:outputPanel id="displayButton">
                                            <!-- apex:outputPanel rendered="{!!hasError}" -->
                                                <ul class="list actions">
                                                    <apex:variable value="1" var="notQuote" rendered="{!vfOrder.orderPreviousType != 'Quote'}">
                                                    <li>
                                                        <a href="javascript:;" onclick="openModal('#quote-modal')" class="button secondary">{!$Label.Generate_Quote}</a>
                                                    </li>
                                                    </apex:variable>
        
                                                    <li>
                                                        <apex:actionFunction name="processPayment" reRender="errorBloc" action="{!processPayment}" status="payStatus" oncomplete="$(window).scrollTop(0);" />
                                                        <button class="button wide" type="button" onclick="processPayment();">
                                                            {!$Label.IDCard_Continue_Button}
                                                            <apex:actionStatus id="payStatus"> 
                                                                <apex:facet name="start"><img src="{!$Resource.IEC_progress}" style="margin-top: 5px; margin-left: 5px;" alt="x" /></apex:facet>
                                                            </apex:actionStatus>
                                                        </button>
                                                        <!-- <apex:commandButton action="{!processPayment}" status="payStatus" styleClass="button wide" value="Continue" reRender="errorBloc" oncomplete="$(window).scrollTop(0);" /> -->
                                                    </li>
                                                </ul>
                                        	<!-- /apex:outputPanel -->
                                        </apex:outputPanel>
                                        
                                        <!-- <apex:actionStatus id="payStatus">
                                            <apex:facet name="start">&nbsp;<img src="{!$Resource.IEC_progress}" alt="x" /></apex:facet>
                                        </apex:actionStatus> -->
                                    </div>
                                </apex:form>

                                <!-- Cart Empty -->
                                <apex:variable var="cartEmpty" value="0" rendered="{!OR(vfOrder.orderItems == null, vfOrder.orderItems.size == 0)}">
                                    <div class="footer-actions text-right">
                                        <a href="{!$Site.BaseUrl}/IEC_ProductList" class="button wide">{!$Label.Button_Continue_Shopping}</a>
                                    </div>
                                </apex:variable>
                            </apex:outputPanel>
                        </apex:outputPanel>
                    </main>

                    <!-- Page Footer  -->
                    <c:Footer is_checkout="true" />
                </div>
            </div>

            <!-- T&C Modal -->
            <div class="modal-container is-hidden" id="modal-terms-and-conditions">
                <div class="overlay"></div>
                <div class="modal-dialog" id="js-modal-dialog">
                    <input type="hidden" id="selectedRow" />
                    <section id="js-modal-terms-and-conditions" class="modal-content">
                        <header class="modal-header">
                            <h2 class="modal-title">Terms and conditions</h2>
                            <a href="javascript:closeModal('#modal-terms-and-conditions')" class="icon-close"><span class="reader-only">Close</span><i class="fa fa-times"></i></a>
                        </header>
                        <div class="modal-body">
                            <div class="scroll-container">
                                <iframe src="" id="tncFrame" width="100%" height="290px" frameborder="0"></iframe>
                            </div>
                        </div>
                        <footer class="modal-footer">
                            <ul class="list actions">
                                <li><button class="text-link" onclick="rejectTnC()">Cancel</button></li>
                                <li><button class="button wide" onclick="acceptTnC()">Accept</button></li>
                            </ul>
                        </footer>
                    </section>
                </div>
            </div>
            
            <apex:outputPanel id="cardIframe">
            <!-- Add Credit Card Modal -->
            <div class="modal-container is-hidden" id="modal-add-credit-card">
                <div class="overlay"></div>
                <div class="modal-dialog" id="js-modal-dialog">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <header class="modal-header">
                                <h2 class="modal-title">Add credit card</h2>
                                <a href="javascript:closeModal('#modal-add-credit-card');" class="icon-close"><span class="reader-only">Close</span><i class="fa fa-times"></i></a>
                            </header>
                            <div class="modal-body">
                                <iframe id="z_hppm_iframe" name="z_hppm_iframe" style="margin-left: 8px;" width="99%" height="420" src="{!iframeSrc}" frameborder="0"></iframe>
                            </div>
                            <footer class="modal-footer">
                                <ul class="list actions">
                                    <li>
                                        <button class="text-link" onclick="javascript:closeModal('#modal-add-credit-card');">Cancel</button>
                                    </li>
                                    <li>
                                        <button class="button wide" onclick="addCreditCard();">Save</button>
                                    </li>
                                </ul>
                            </footer>
                        </div>
                    </div>
                </div>
            </div>
            </apex:outputPanel>

            <!-- Delete Credit Card Modal  -->
            <div class="modal-container is-hidden" id="modal-delete-credit-card">
                <div class="overlay"></div>
                <div class="modal-dialog" id="js-modal-dialog">
                    <!-- <apex:form id="frmDelete"> -->
                    <apex:outputPanel layout="block" styleClass="modal-dialog" id="delete_block">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <header class="modal-header">
                                    <h2 class="modal-title">Delete credit card</h2>
                                    <a href="javascript:closeModal('#modal-delete-credit-card');" class="icon-close"><span class="reader-only">Close</span><i class="fa fa-times"></i></a>
                                </header>
                                <div class="modal-body">
                                    <table class="data-table table-saved-cards seleted">
                                        <caption class="table-caption">Card</caption>
                                        <tr class="heading">
                                            <th class="card">Credit card</th>
                                            <th class="name">Name printed on card</th>
                                            <th class="date">Expires</th>
                                        </tr>
                                        <tr class="item is-selected">
                                            <td class="card">
                                                <apex:outputPanel styleClass="card-image" rendered="{!selectedCreditCard.creditCardType !=''}">
                                                    <apex:variable var="ccLogo" value="img/components/icons/credit-card/{!selectedCreditCard.creditCardType}.png"/>
                                                    <img src="{!URLFOR($Resource.EcommerceAssets, ccLogo)}" alt="{!selectedCreditCard.creditCardType}" />
                                                </apex:outputPanel>
                                                <span class="card-name">
                                                    <strong>{!selectedCreditCard.creditCardType}</strong>
                                                    <span class="ending-number">{!selectedCreditCard.creditCardMaskNumber}  </span>
                                                </span>
                                            </td>
                                            <td class="name">
                                                <strong class="label show-for-small">Name printed on card</strong>
                                                <span class="value">{!selectedCreditCard.holderName}</span>
                                            </td>
                                            <td class="date">
                                                <strong class="label show-for-small">Expires</strong>
                                                <span class="value">{!selectedCreditCard.expirationMonth}/{!selectedCreditCard.expirationYear}</span>
                                            </td>
                                        </tr>                                       
                                    </table>
                                </div>
                                <footer class="modal-footer">
                                    <ul class="list actions">
                                        <li><button class="text-link" onclick="javascript:closeModal('#modal-delete-credit-card');">Cancel</button></li>
                                        <li>
                                            <apex:actionStatus id="deleteCCStatus">
                                                <apex:facet name="start">&nbsp;<img src="{!$Resource.IEC_progress}" alt="x" /></apex:facet>
                                            </apex:actionStatus>
                                            <button class="button wide" onclick="javascript:removeCreditCard();">Delete</button>                                            
                                        </li>
                                    </ul>                                               
                                </footer>
                            </div>
                        </div>
                    </apex:outputPanel>
                    <!-- </apex:form> -->
                </div>
            </div>

            <!-- Quote Confirm Modal -->
            <div class="modal-container is-hidden" id="quote-modal">
                <div class="overlay"></div>
                <div class="modal-dialog" id="js-modal-dialog">
                    <section id="modal-get-a-quote" class="modal-content">
                        <header class="modal-header">
                                <h2 class="modal-title">{!$Label.Generate_Quote}</h2>
                                <a href="javascript:;" onclick="javascript:closeModal('#quote-modal')" class="icon-close"><span class="reader-only">Close</span><i class="fa fa-times"></i></a>
                            </header>
                            <div class="modal-body">
                                <p>{!$Label.GetQuoteConfirmationMsg}</p>
                            </div>
                            <footer class="modal-footer">
                                <ul class="list actions">
                                    <li><button class="text-link" onclick="closeModal('#quote-modal')">Cancel</button></li>
                                    <li>
                                        <button class="button secondary" onclick="generateQuote()">
                                            {!$Label.Generate_Quote}
                                            <apex:actionStatus id="quoteStatus">
                                                <apex:facet name="start"><img src="{!$Resource.IEC_progress}" style="margin-top: 5px; margin-left: 5px;" alt="x" /></apex:facet>
                                            </apex:actionStatus>
                                        </button>
                                    </li>
                                </ul>
                            </footer>
                    </section>
                </div>
            </div>


            <script src="{!URLFOR($Resource.EcommerceAssets, 'js/vendor.min.js')}"></script>
            <script src="{!URLFOR($Resource.EcommerceAssets, 'js/script.js')}"></script>

            <script src="{!URLFOR($Resource.jQueryUI, 'jquery-ui.min.js')}"></script>

            <apex:variable var="validationLanguage" value="js/languages/jquery.validationEngine-{!language}.js"/>
            <script src="{!URLFOR($Resource.ValidationEngine, validationLanguage)}"></script>
            <script src="{!URLFOR($Resource.ValidationEngine, 'js/jquery.validationEngine.js')}"></script>
            
            <style type="text/css">
                .required{
                    color: #e6176f;
                }
            </style>

            <script type="text/javascript">

                var setLabelFor = function(){
                    var total_items = $("#total_items").val();
                    for(i=1; i<=total_items; i++){
                        var chkTnC = $("input.accept-terms-"+i).attr('id');
                        if(chkTnC != undefined)
                            $("label.accept-terms-"+i).attr('for',chkTnC);

                        var chkAuto = $("input.auto-renewal-"+i).attr('id');
                        if(chkAuto != undefined)
                            $("label.auto-renewal-"+i).attr('for',chkAuto);
                    }
                }
                
                var selectDefaultState = function(){
                    $('select[id$=shippingRegion]').val($('#hiddenShippingRegion').val());
                }

                var selectDefaultShipToRadio = function(){
                    if($("input[id$=shipToSameAsBilTo]").val() == 'true'){
                        $("#shipping-address-same").prop("checked", true);
                    }else{
                        $("#shipping-address-different").prop("checked", true);
                    }
                }

                var selectDefaultPaymentMethod = function(){
                    hideCreditCards();
                    $('.pm').each(function(idx, elt){
                        if($(elt).is(':checked'))
                        {
                            $('input[id$=orderPaymentType]').val($(elt).val());
                        }

                        if($(elt).val() == "{!sfOrder.Payment_Type__c}")
                        {
                            $(elt).prop("checked", true);

                            if($(elt).val() == 'Credit Card'){
                                showCreditCards();
                                if($('input[id$=ccId]').val() == '')
                                {
                                    // Use default cc if no other selected
                                    var defaultCreditCard = $("input[id$=defaultCreditCard]").val();
                                    //console.log(defaultCreditCard);
                                    $('input[id$=ccId]').val(defaultCreditCard);
                                }
                            }else{
                                hideCreditCards();
                            }
                        }
                    });
                }

                var showCreditCards = function(){
                    $('.payment-method-container').removeClass(className.hidden);
                }

                var hideCreditCards = function(){
                    $('.payment-method-container').addClass(className.hidden);
                }

                var deactivateBankTransfert = function(){
                    //console.log('Bank Transfer deactivation');
                    $(".pm[value='Bank Transfer']").prop("disabled",true);
                    $(".pm[value='Bank Transfer']").prop("checked",false);
                    $(".pm[value='Bank Transfer']").parent().parent().addClass('disabled with-tooltip');
                    $(".bankTransfert").removeClass(className.hidden);
                }

                var activateBankTransfert = function(){
                    //console.log('Bank Transfer activation');
                    $(".pm[value='Bank Transfer']").prop("disabled",false);
                    $(".pm[value='Bank Transfer']").parent().parent().removeClass('disabled with-tooltip');
                    $(".bankTransfert").addClass(className.hidden);
                }

                var populateNewAddressFields = function(data){
                    $('input[id$=shippingAddress1]').val(data.Street__c);
                    $('input[id$=shippingCity]').val(data.City__c);
                    $('input[id$=shippingPostalCode]').val(data.ZipCode__c);
                    $('select[id$=shippingCountry]').val(data.ISO_Country_Code__c);

                    refreshShipToProvinces(data.ISO_Country_Code__c);
                    $('#hiddenShippingRegion').val(data.ISO_State_Code__c);
                }

                var acceptTnC = function(){
                    $("input.accept-terms-"+$("#selectedRow").val()).prop('checked', "true");
                    closeModal("#modal-terms-and-conditions");
                }

                var rejectTnC = function(){
                    $("input.accept-terms-"+$("#selectedRow").val()).prop('checked', false);
                    closeModal('#modal-terms-and-conditions');
                }

                var viewTnC = function(rowNum, url){
                    $("#selectedRow").val(rowNum);
                    $("#tncFrame").attr('src',url);
                    openModal("#modal-terms-and-conditions");
                }

                var openModal = function(elt){
                    $(elt).removeClass(className.hidden);
                    $('body').attr('data-is-modal-open', 'true');
                }

                var closeModal = function(elt){
                    $(elt).addClass(className.hidden);
                    $('body').attr('data-is-modal-open', 'false');
                    $("#tncFrame").attr('src','');
                }

                var autoRenewSelected = function(){
                    var selected = false;

                    $(".auto-renewal-item").each(function(idx, elt){
                        if($(this).is(':checked')) selected = true;
                    });
                    
                    return selected;
                }

                var addCreditCard = function() {
                    submitHostedPage('z_hppm_iframe');
                    closeModal('#modal-add-credit-card');
                    $("#loader").removeClass(className.hidden);
                    $(".alert.success").css('display','none');
                    $(".alert.error").css('display','none');
                }

                function callbacksuccess(paymentMethodId) {
                    this.document.getElementById('{!$Component.frmShipToAddress.hiddenNewCreditCardPaymentId}').value = paymentMethodId;
                    $("#loader").addClass(className.hidden);
                    proceedToAddNewBackend();
                }
                
                function callbackfailure( paramString ) { 
                    $("#loader").addClass(className.hidden);  
                    displayCallBackfailureJS(paramString);
                }

                var showNewAddressForm = function(){
                    $('.form-address').removeClass(className.hidden);
                    $('.shipping-instructions').addClass(className.hidden);
                    $('#addNewAddress').addClass(className.hidden);
                }

                var hideNewAddressForm = function(){
                    $('.form-address').addClass(className.hidden);
                    $('.shipping-instructions').removeClass(className.hidden);
                    $('#addNewAddress').removeClass(className.hidden);
                }

                var same_address_selected = function(){
                    $('.shipping-address-container').addClass(className.hidden);
                    $("input[id$=shipToSameAsBilTo]").val('true');
                    changeShipToAddressOption();
                }

                var different_shipping_address = function(){
                    $('.shipping-address-container').removeClass(className.hidden);
                    $("input[id$=shipToSameAsBilTo]").val('false');
                    changeShipToAddressOption();
                }

                $(document).ready(function(){
                    setLabelFor();

                    //Front end validation
                    $("form").validationEngine();

                    selectDefaultShipToRadio();

                    selectDefaultPaymentMethod();

                    //If item in autoRenew 
                    if(autoRenewSelected())
                        deactivateBankTransfert();
                    else
                        activateBankTransfert();
                    
                    $("#shipping-address-same").on('click',function(){
                        //same_address_selected();
                    });

                    $("#shipping-address-different").on('click',function(){
                        //different_shipping_address();
                    });

                    $('input[id$=shippingAddress1]').autocomplete({
                        source: function( request, response ) {
                            IEC_ShippingController.findIECAddresses(request.term, function(result, event){
                                response( $.map( result , function( item ) {
                                    return {
                                        label: item.Full_Address__c,
                                        value: item.Street__c,
                                        address:item
                                    }
                                }));
                            });
                        },
                        select: function( event, ui ) {
                           populateNewAddressFields(ui.item.address);
                        }
                    });

                    $("select[id$=shipToLocation]").on('change',function(){
                        $('.form-address').addClass(className.hidden);
                    });

                    $(".auto-renewal-item").on('change',function(){
                        $(this).siblings('input[type=hidden]').val($(this).is(':checked'));
                        
                        if(autoRenewSelected())
                            deactivateBankTransfert();
                        else
                            activateBankTransfert();
                    });

                    $('.js-payment-method').on('change', '.user-input:checked', function() {
                        //console.log($(this).val());
                        $('input[id$=orderPaymentType]').val($(this).val());

                        if ($(this).val() === 'Credit Card') {
                            if($('input[id$=ccId]').val() == '')
                            {
                                // Use default cc if no other selected
                                var defaultCreditCard = $("input[id$=defaultCreditCard]").val();
                                //console.log(defaultCreditCard);
                                $('input[id$=ccId]').val(defaultCreditCard);
                            }
                                
                            $('.payment-method-container').removeClass(className.hidden);
                        }else{
                            $('.payment-method-container').addClass(className.hidden);
                        }
                    });

                    $('.js-card-data-table').on('change', '.user-input:checked', function() {
                        $('input[id$=ccId]').val($(this).val());
                    });
                    

                });
            </script>
        </body>

    </html>

</apex:page>