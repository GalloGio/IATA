<apex:page id="TreasuryDashboardPowerBiReportPage" controller="TreasuryDashboardPowerBiReportPageCtrl" showHeader="false" showChat="false" sideBar="false" action="{!redirect}">
    <apex:includeScript value="{!$Resource.PBIJS}"/>

    <div>
        <div id="paginatedReport" style="position:absolute; height:100%; width:100%"></div>
    </div>

    <style type="text/css">

            iframe {
                border:none;
            }

    </style>

    <script>

        let element = document.getElementById('paginatedReport');

        let models = window['powerbi-client'].models;
        let obj = "{!objectId}";
        let token = "{!accessToken}";
        let type = "{!tokenType}";
        let embedUrl = "{!embedUrl}";
        let groupId = "{!groupId}";
        let expiration = "{!expiration}";

        let typeOfToken = 0;
        if(type === 'Aad') {
            typeOfToken = models.TokenType.Aad;
        }
        if(type === 'Embed') {
            typeOfToken = models.TokenType.Embed;
        }


        console.log('ON PAGE');
        console.log('embedUrl:: ' , embedUrl);
        console.log('obj:: ', obj);
        console.log('token:: ' , token);
        console.log('groupId: ', groupId);


        var embedConfiguration = {
            id: "{!objectId}",
            type: "report",
            embedUrl: "{!embedUrl}",
            tokenType: typeOfToken,
            accessToken: "{!accessToken}",
            settings : {
                filterPaneEnabled: false,
                navContentPaneEnabled: false,
                //for forcing language to English
                /*localeSettings: {
                    language: "en",
                    formatLocale: "us"
                }*/
                //for transparent background in iFrame
                //background: models.BackgroundType.Transparent
            }
        };

        var report = powerbi.embed(element, embedConfiguration);

        var expDate = new Date(expiration);
        console.log('expiration: ', expiration);

        //normally we would use this piece of code, but there is error in promise in loaded powerbi.js
        /*report.off("loaded");
        report.on("loaded", function() {
            // Set token expiration listener (expDate, minutesBeforeExpiration, reportId, groupId)
            setTokenExpirationListener(expDate, 3, obj, groupId);
        });*/

        //this is workaround
        window.addEventListener("DOMContentLoaded",
        function() {
            setTokenExpirationListener(expDate, 3, obj, groupId);
        });



        function setTokenExpirationListener(tokenExpiration, minutesToRefresh, reportId, groupId){
            console.log('setting token expiration');
            // get current time
            var currentTime = Date.now();
            var expiration = Date.parse(tokenExpiration);
            var safetyInterval = minutesToRefresh* 60 * 1000;

            // time until token refresh in milliseconds
            var timeout = expiration - currentTime - safetyInterval;

            // if token already expired, generate new token and set the access token
            if (timeout<=0) {
                updateEmbedToken(reportId, groupId);
            }
            // set timeout so minutesToRefresh minutes before token expires, token will be updated
            else {
                console.log("Report Embed Token will be updated in " + timeout + " milliseconds.");
                setTimeout(function() {
                    updateEmbedToken(reportId, groupId);
                }, timeout);
            }


            function updateEmbedToken(reportId, groupId) {
                console.log('updating embed token');
                Visualforce.remoting.Manager.invokeAction(
                    '{!$RemoteAction.TreasuryDashboardPowerBiReportPageCtrl.refreshEmbedToken}', reportId, groupId,
                    function(result, event){
                        if (event.status) {
                            console.log('updateEmbedToken OK');
                            setNewEmbedToken(result, groupId, reportId);
                            //response OK
                        } else if (event.type === 'exception') {
                            //exception
                            console.log('Unable to update embed token - exception.');
                        } else {
                            //exception
                            console.log('Unable to update embed token - error.');
                        }
                    },
                    {escape: true}
                );
            }


            function setNewEmbedToken(result, groupId, reportId) {
                // Get a reference to the embedded report HTML element
                var embedContainer = document.getElementById('paginatedReport');

                // Get a reference to the embedded report.
                var report = powerbi.get(embedContainer);

                var resultArray = result.split('expiration=');

                var newToken = resultArray[0];
                var newExpDate = new Date(resultArray[1]);

                console.log('newToken: ', newToken);
                console.log('newExpDate: ', newExpDate);

                report.setAccessToken(newToken)
                    .then(function() {
                        // Set token expiration listener (expDate, minutesBeforeExpiration, reportId, groupId)
                        setTokenExpirationListener(newExpDate, 3, reportId, groupId);
                    });
            }
    }

    </script>


</apex:page>
