<apex:page controller="MITA_AgreementsCtrl" sidebar="false">
	<c:Loading />
	<apex:includescript value="//cdn.datatables.net/1.10.4/js/jquery.dataTables.min.js" />
	<apex:stylesheet value="//cdn.datatables.net/1.10.4/css/jquery.dataTables.css" />

	<apex:form >
	<apex:outputPanel id="messages" >
		<apex:pageMessages />
		<input value="{!isThereAnError}" id="HowManyErrors" type="hidden"/>
		<input id="canChangeTab" value="{!NOT(OR(editMITAAgreementMode, editBIETAAgreementMode, editContactMode, searchContactMode, duplicateContactMode, editAccountMode))}" type="hidden"/>
	</apex:outputPanel>
	</apex:form>

	<style>
		.columnContainer{width:100%; vertical-align:top;}
		.firstColumn{width:30%; vertical-align:top;}
		.secondColumn{width:70%; vertical-align:top;}
		.hide {display: none;}
	</style>


	<apex:panelGrid styleclass="columnContainer" columns="2" columnClasses="firstColumn, secondColumn">

       <!-- BLOCK IN THE LEFT FOR THE LIST OF ALL THE AIRLINES -->
       <apex:pageBlock title="Choose an airline" id="chooseAirlineBlock" >
			<apex:form >
				Display only MITA Members
				<input type="checkbox" id="OnlyMITAAirlines" checked="checked"/><br/>
				Search on
				<select id="filterOn" size="1">
					<option value="code">Code</option>
					<option value="name">Name</option>
					<option value="all">All</option>
				</select>
				<table id="airlinesTable" class="display">
					<thead>
						<tr>
							<th>DCode</th>
							<th>NCode</th>
							<th>Airline Name</th>
							<th>MITA member</th>
						</tr>
					</thead>
					<tbody>
						<apex:outputText value="{!AccountTable}" escape="false" />
					</tbody>
				</table>
				<apex:inputHidden value="{!accountid}" id="accountid"/>
				<apex:actionFunction id="selectAccount"  name="selectAccount" action="{!selectAccount}" rerender="messages,column2" status="Loading"/>
			</apex:form>
		</apex:pageBlock>





		<!-- PANEL IN THE RIGHT WITH THE DETAILS OF THE CHOSEN AIRLINE -->
		<apex:outputPanel id="column2" style="width:40%">
			<script>$('#canChangeTab').val('true')</script>

			<apex:outputPanel id="accountInfoPanel">
				<apex:form >

				<apex:pageBlock rendered="{!chosenAccount}" >
					<h1><a href="/{!acc.Id}" target="_blank" style="font-size:1.5em;">{!acc.Name_on_AOC__c} / {!acc.Airline_designator__c} / {!acc.IATACode__c}</a></h1><br/><br/>
					<!-- CUSTOM TAB HEADER -->
					<div class="mytabheadercontainer" >
						<div class="mytabheader active" id="hdAirline" onclick="showTab('Airline')">Airline</div>
						<div class="mytabheader" id="hdMITA" onclick="showTab('MITA')">MITA</div>
						<div class="mytabheader" id="hdBIETA" onclick="showTab('BIETA')">BIETA</div>
						<div class="mytabheader" id="hdContacts" onclick="showTab('Contacts')">Contacts</div>
					</div>

					<!-- TAB CONTAINER -->
					 <div class="mytabcontainer">

					 	<!-- FIRST TAB: AIRLINE -->
						<div class="mytab active" id="tabAirline">
							<apex:pageBlockSection title="Airline information">
								<apex:outputField value="{!acc.Airline_designator__c}" />
								<apex:outputField value="{!acc.IATACode__c}" />
								<apex:outputField value="{!acc.Membership_status__c}" />
								<apex:outputField value="{!acc.Airline_Prefix__c}" />
								<apex:outputField value="{!acc.Due_Diligence_Status__c}" />
								<apex:outputField value="{!acc.ICH_Member__c}" />
								<apex:PageBlockSectionItem />
								<apex:outputField value="{!acc.ACH_Member__c}" />
							</apex:pageBlockSection>
							<apex:pageBlockSection id="viewAccountMITAInfo" rendered="{!NOT(editAccountMode)}" title="Participant dates of MITA agreement">
								<apex:outputField value="{!acc.MITA_Member__c}" styleclass="outMITAMember"/>
								<apex:outputField value="{!acc.MITA_Currency__c}" />

								<apex:outputField value="{!acc.MITA_IATA_Interline_Cargo__c}" />
								<apex:outputField value="{!acc.MITA_IATA_Interline_Passenger__c}" />

								<apex:outputField value="{!acc.MITA_IATA_Interline_Cargo_Charges__c}" />
								<apex:outputField value="{!acc.MITA_IATA_Interline_Passenger_Charges__c}" />

								<apex:outputField value="{!acc.MITA_IATA_Interline_Cargo_Claims__c}" />
								<apex:pageBlockSectionItem />

								<apex:outputField value="{!acc.MITA_IATA_Interline_Pass_Art3_Joined__c}" />
								<apex:outputField value="{!acc.MITA_IATA_Interline_Art3_Excepted_Status__c}" />


								<apex:outputField value="{!acc.MITA_One_way_Pass_Issuing_Airline__c}" />
								<apex:outputField value="{!acc.MITA_One_way_Pass_Participating__c}" />

								<apex:commandButton value="Deactivate MITA member" onclick="return confirm('Are you sure? This will inactivate all MITA agreements for this Airline.');" action="{!deactivateMitaMember}" style="float:right;" />

							</apex:pageBlockSection>
							<apex:pageBlockSection id="editAccountMITAInfo" rendered="{!editAccountMode}" title="Participant dates of MITA agreement">
								<apex:inputField value="{!acc.MITA_Member__c}" styleclass="outMITAMember"/>
								<apex:inputField value="{!acc.MITA_Currency__c}" />

								<apex:inputField value="{!acc.MITA_IATA_Interline_Cargo__c}" />
								<apex:inputField value="{!acc.MITA_IATA_Interline_Passenger__c}" />

								<apex:inputField value="{!acc.MITA_IATA_Interline_Cargo_Charges__c}" />
								<apex:inputField value="{!acc.MITA_IATA_Interline_Passenger_Charges__c}" />

								<apex:inputField value="{!acc.MITA_IATA_Interline_Cargo_Claims__c}" />
								<apex:pageBlockSectionItem />

								<apex:inputField value="{!acc.MITA_IATA_Interline_Pass_Art3_Joined__c}" />
								<apex:inputField value="{!acc.MITA_IATA_Interline_Art3_Excepted_Status__c}" />

								<apex:inputField value="{!acc.MITA_One_way_Pass_Issuing_Airline__c}" />
								<apex:inputField value="{!acc.MITA_One_way_Pass_Participating__c}" />

							</apex:pageBlockSection>

							<apex:pageBlockSection id="viewAccountBIETAInfo" rendered="{!NOT(editAccountMode)}" title="Participant dates of BIETA agreement">
								<apex:outputField value="{!acc.BIETA_Member__c}"/>
								<apex:outputField value="{!acc.BIETA_Bilateral_Date__c}" />

								<apex:outputField value="{!acc.BIETA_One_way_Electronic_Issuing_Airline__c}" />
								<apex:outputField value="{!acc.BIETA_One_way_Electronic_Participating__c}" />

								<apex:outputField value="{!acc.BIETA_One_way_Intermodal_Issuing_Airline__c}" />
								<apex:outputField value="{!acc.BIETA_One_way_Intermodal_Participating__c}" />

								<apex:commandButton value="Deactivate BIETA member" onclick="return confirm('Are you sure? This will inactivate all BIETA agreements for this Airline.');" action="{!deactivateBietaMember}" style="float:right;" />

							</apex:pageBlockSection>
							<apex:pageBlockSection id="editAccountBIETAInfo" rendered="{!editAccountMode}" title="Participant dates of BIETA agreement">
								<apex:inputField value="{!acc.BIETA_Member__c}"/>
								<apex:inputField value="{!acc.BIETA_Bilateral_Date__c}"/>


								<apex:inputField value="{!acc.BIETA_One_way_Electronic_Issuing_Airline__c}" />
								<apex:inputField value="{!acc.BIETA_One_way_Electronic_Participating__c}" />

								<apex:inputField value="{!acc.BIETA_One_way_Intermodal_Issuing_Airline__c}" />
								<apex:inputField value="{!acc.BIETA_One_way_Intermodal_Participating__c}" />

							</apex:pageBlockSection>

							<br/>
							<div style="text-align:center;">
								<apex:commandButton value="Edit Airline"   action="{!editAccount}" rerender="accountInfoPanel, messages" rendered="{!NOT(editAccountMode)}" status="Loading"/>
								<apex:commandButton value="Save Airline"   action="{!saveAccount}" rerender="accountInfoPanel, agreementSearchPanel, messages" rendered="{!editAccountMode}" status="Loading" onComplete="updateAirlineList()"/>
								<apex:commandButton value="Cancel" action="{!resetAccount}" rerender="accountInfoPanel, messages" rendered="{!editAccountMode}" status="Loading" immediate="true"/>
							</div>


						</div>

					 	<!-- SECOND TAB: MITA -->
						<div class="mytab" id="tabMITA">

							<!-- SECTION FOR MITA AGREEMENT INFO -->
							<apex:outputPanel id="MITAagreementInfoPanel">
								<apex:pageBlockSection title="Agreement details" columns="1" rendered="{!NOT(chosenMITAAgreement)}">
									<apex:pageBlockSectionItem />
									<apex:pageBlockSectionItem />
									<apex:pageBlockSectionItem />
								</apex:pageBlockSection>

								<!-- MITA VIEW -->
								<apex:pageBlockSection id="viewMITAAgreementInfo" rendered="{!AND(chosenMITAAgreement,NOT(editMITAAgreementMode),!wrapper.isMixed)}" title="Agreement details">
									<apex:pageBlockSectionItem >
										<apex:outputLabel for="theLink" value="{!$ObjectType.MITA_Agreement__c.fields.Airline_1__c.Label}" />
										<apex:commandLink id="theLink"
														  value="{!wrapper.agreement.Airline_1__r.Name_on_AOC__c}"
														  onclick="$('[id$=accountid]').val('{!wrapper.agreement.Airline_1__c}'); selectAccount();"
														  rerender="messages"/>
									</apex:PageBlockSectionItem>
									<apex:pageBlockSectionItem >
										<apex:outputLabel for="theLink" value="{!$ObjectType.MITA_Agreement__c.fields.Airline_2__c.Label}" />
										<apex:commandLink id="theLink"
														  value="{!wrapper.agreement.Airline_2__r.Name_on_AOC__c}"
														  onclick="$('[id$=accountid]').val('{!wrapper.agreement.Airline_2__c}'); selectAccount();"
														  rerender="messages"/>
									</apex:PageBlockSectionItem>

									<apex:outputField value="{!wrapper.agreement.Agreement_type__c}" />
									<apex:outputField value="{!wrapper.agreement.Status__c}" />

									<apex:outputField value="{!wrapper.agreement.Effective_date__c}" />
									<apex:outputField value="{!wrapper.agreement.Cancellation_date__c}" />

									<apex:outputField value="{!wrapper.agreement.Agreement_processed_date__c}" />
									<apex:outputField value="{!wrapper.agreement.Cancellation_processed_date__c}" />

									<apex:outputField value="{!wrapper.agreement.Withdrawal_Request_Reception_Date__c}" />
									<apex:outputField value="{!wrapper.agreement.Cancellation_Reason__c}" />
								</apex:pageBlockSection>

								<!-- MITA VIEW for MIXED -->
								<apex:pageBlockSection id="viewMITAAgreementInfoMIXED" rendered="{!AND(chosenMITAAgreement,NOT(editMITAAgreementMode),wrapper.isMixed)}" title="Agreement details">
									<apex:pageBlockSectionItem >
										<apex:outputLabel for="theLink" value="{!$ObjectType.MITA_Agreement__c.fields.Airline_1__c.Label}" />
										<apex:commandLink id="theLink"
														  value="{!wrapper.agreementPax.Airline_1__r.Name_on_AOC__c}"
														  onclick="$('[id$=accountid]').val('{!wrapper.agreementPax.Airline_1__c}'); selectAccount();"
														  rerender="messages"/>
									</apex:PageBlockSectionItem>
									<apex:pageBlockSectionItem >
										<apex:outputLabel for="theLink" value="{!$ObjectType.MITA_Agreement__c.fields.Airline_2__c.Label}" />
										<apex:commandLink id="theLink"
														  value="{!wrapper.agreementPax.Airline_2__r.Name_on_AOC__c}"
														  onclick="$('[id$=accountid]').val('{!wrapper.agreementPax.Airline_2__c}'); selectAccount();"
														  rerender="messages"/>
									</apex:PageBlockSectionItem>

									<apex:PageBlockSectionItem />
									<apex:PageBlockSectionItem />

									<apex:outputField value="{!wrapper.agreementPax.Agreement_type__c}" />
									<apex:outputField value="{!wrapper.agreementCargo.Agreement_type__c}" />

									<apex:outputField value="{!wrapper.agreementPax.Status__c}" />
									<apex:outputField value="{!wrapper.agreementCargo.Status__c}" />

									<apex:outputField value="{!wrapper.agreementPax.Effective_date__c}" />
									<apex:outputField value="{!wrapper.agreementCargo.Effective_date__c}" />

									<apex:outputField value="{!wrapper.agreementPax.Agreement_processed_date__c}" />
									<apex:outputField value="{!wrapper.agreementCargo.Agreement_processed_date__c}" />

									<apex:outputField value="{!wrapper.agreementPax.Withdrawal_Request_Reception_Date__c}" />
									<apex:outputField value="{!wrapper.agreementCargo.Withdrawal_Request_Reception_Date__c}" />

									<apex:outputField value="{!wrapper.agreementPax.Cancellation_date__c}" />
									<apex:outputField value="{!wrapper.agreementCargo.Cancellation_date__c}" />

									<apex:outputField value="{!wrapper.agreementPax.Cancellation_processed_date__c}" />
									<apex:outputField value="{!wrapper.agreementCargo.Cancellation_processed_date__c}" />

									<apex:outputField value="{!wrapper.agreementPax.Cancellation_Reason__c}" />
									<apex:outputField value="{!wrapper.agreementCargo.Cancellation_Reason__c}" />
								</apex:pageBlockSection>

								<!-- MITA EDIT -->
								<apex:inputField value="{!wrapper.agreement.MITAorBIETA__c}" style="display:none" label="" rendered="{!editMITAAgreementMode}"/>
								<apex:pageBlockSection id="editMITAAgreementInfo" rendered="{!AND(chosenMITAAgreement,editMITAAgreementMode,!wrapper.isMixed)}" title="Agreement details">
									<apex:inputField value="{!wrapper.agreement.Airline_1__c}" rendered="{!AND(wrapper.isNew,wrapper.agreement.Airline_2__c = acc.Id)}" required="true"/>
									<apex:outputField value="{!wrapper.agreement.Airline_1__c}" rendered="{!!AND(wrapper.isNew,wrapper.agreement.Airline_2__c = acc.Id)}"/>
									<apex:inputField value="{!wrapper.agreement.Airline_2__c}" rendered="{!AND(wrapper.isNew,wrapper.agreement.Airline_1__c = acc.Id)}" required="true"/>
									<apex:outputField value="{!wrapper.agreement.Airline_2__c}" rendered="{!!AND(wrapper.isNew,wrapper.agreement.Airline_1__c = acc.Id)}" />

									<apex:inputField value="{!wrapper.agreement.Agreement_type__c}" required="true" rendered="{!wrapper.isNew}"/>
									<apex:PageBlockSectionItem rendered="{!!wrapper.isNew}" />
									<apex:PageBlockSectionItem />

									<apex:inputField value="{!wrapper.agreement.Effective_date__c}" />
									<apex:inputField value="{!wrapper.agreement.Cancellation_date__c}" />

									<apex:inputField value="{!wrapper.agreement.Agreement_processed_date__c}" />
									<apex:inputField value="{!wrapper.agreement.Cancellation_processed_date__c}" />

									<apex:inputField value="{!wrapper.agreement.Withdrawal_Request_Reception_Date__c}" />
									<apex:inputField value="{!wrapper.agreement.Cancellation_Reason__c}" />
								</apex:pageBlockSection>

								<!-- MITA EDIT for MIXED -->
								<apex:pageBlockSection id="editMITAAgreementInfoMIXED" rendered="{!AND(chosenMITAAgreement,editMITAAgreementMode,wrapper.isMixed)}" title="Agreement details">
									<apex:inputField value="{!wrapper.agreementPax.Airline_1__c}" rendered="{!AND(wrapper.isNew,wrapper.agreementPax.Airline_2__c = acc.Id)}" required="true"/>
									<apex:outputField value="{!wrapper.agreementPax.Airline_1__c}" rendered="{!!AND(wrapper.isNew,wrapper.agreementPax.Airline_2__c = acc.Id)}"/>
									<apex:inputField value="{!wrapper.agreementPax.Airline_2__c}" rendered="{!AND(wrapper.isNew,wrapper.agreementPax.Airline_1__c = acc.Id)}" required="true"/>
									<apex:outputField value="{!wrapper.agreementPax.Airline_2__c}" rendered="{!!AND(wrapper.isNew,wrapper.agreementPax.Airline_1__c = acc.Id)}" />

									<apex:inputField value="{!wrapper.agreement.Agreement_type__c}" required="true" rendered="{!wrapper.isNew}"/>
									<apex:PageBlockSectionItem rendered="{!!wrapper.isNew}" />
									<apex:PageBlockSectionItem />

									<apex:commandLink action="{!viewGroupedAgreement}" value="Show bilateral agreement" rerender="MITAagreementInfoPanel, messages" rendered="{!wrapper.viewSeparated}" status="Loading"/>
									<apex:commandLink action="{!viewSeparatedAgreements}" value="Show agreements separated" rerender="MITAagreementInfoPanel, messages" rendered="{!!wrapper.viewSeparated}" status="Loading"/>
									<apex:PageBlockSectionItem />

									<apex:outputField value="{!wrapper.agreementPax.Agreement_type__c}" rendered="{!wrapper.viewSeparated}"/>
									<apex:outputField value="{!wrapper.agreementCargo.Agreement_type__c}" rendered="{!wrapper.viewSeparated}"/>

									<apex:inputField value="{!wrapper.agreementPax.Effective_date__c}" rendered="{!wrapper.viewSeparated}"/>
									<apex:inputField value="{!wrapper.agreementCargo.Effective_date__c}" rendered="{!wrapper.viewSeparated}"/>

									<apex:inputField value="{!wrapper.agreementPax.Agreement_processed_date__c}" rendered="{!wrapper.viewSeparated}"/>
									<apex:inputField value="{!wrapper.agreementCargo.Agreement_processed_date__c}" rendered="{!wrapper.viewSeparated}"/>

									<apex:inputField value="{!wrapper.agreementPax.Withdrawal_Request_Reception_Date__c}" rendered="{!wrapper.viewSeparated}"/>
									<apex:inputField value="{!wrapper.agreementCargo.Withdrawal_Request_Reception_Date__c}" rendered="{!wrapper.viewSeparated}"/>

									<apex:inputField value="{!wrapper.agreementPax.Cancellation_date__c}" rendered="{!wrapper.viewSeparated}"/>
									<apex:inputField value="{!wrapper.agreementCargo.Cancellation_date__c}" rendered="{!wrapper.viewSeparated}"/>

									<apex:inputField value="{!wrapper.agreementPax.Cancellation_processed_date__c}" rendered="{!wrapper.viewSeparated}"/>
									<apex:inputField value="{!wrapper.agreementCargo.Cancellation_processed_date__c}" rendered="{!wrapper.viewSeparated}"/>

									<apex:inputField value="{!wrapper.agreementPax.Cancellation_Reason__c}" rendered="{!wrapper.viewSeparated}"/>
									<apex:inputField value="{!wrapper.agreementCargo.Cancellation_Reason__c}" rendered="{!wrapper.viewSeparated}"/>

									<apex:outputField value="{!wrapper.agreement.Agreement_type__c}" rendered="{!!wrapper.viewSeparated}"/>
									<apex:PageBlockSectionItem rendered="{!!wrapper.viewSeparated}"/>

									<apex:inputField value="{!wrapper.agreement.Effective_date__c}" rendered="{!!wrapper.viewSeparated}"/>
									<apex:PageBlockSectionItem rendered="{!!wrapper.viewSeparated}"/>

									<apex:inputField value="{!wrapper.agreement.Agreement_processed_date__c}" rendered="{!!wrapper.viewSeparated}"/>
									<apex:PageBlockSectionItem rendered="{!!wrapper.viewSeparated}"/>

									<apex:inputField value="{!wrapper.agreement.Withdrawal_Request_Reception_Date__c}" rendered="{!!wrapper.viewSeparated}"/>
									<apex:PageBlockSectionItem rendered="{!!wrapper.viewSeparated}"/>

									<apex:inputField value="{!wrapper.agreement.Cancellation_date__c}" rendered="{!!wrapper.viewSeparated}"/>
									<apex:PageBlockSectionItem rendered="{!!wrapper.viewSeparated}"/>

									<apex:inputField value="{!wrapper.agreement.Cancellation_processed_date__c}" rendered="{!!wrapper.viewSeparated}"/>
									<apex:PageBlockSectionItem rendered="{!!wrapper.viewSeparated}"/>

									<apex:inputField value="{!wrapper.agreement.Cancellation_Reason__c}" rendered="{!!wrapper.viewSeparated}"/>
									<apex:PageBlockSectionItem rendered="{!!wrapper.viewSeparated}"/>
								</apex:pageBlockSection>

								<div style="text-align:center;">
									<apex:commandButton value="New"   action="{!newMITAAgreement}" rerender="MITAagreementInfoPanel, messages" rendered="{!NOT(editMITAAgreementMode)}" status="Loading"/>
									<apex:commandButton value="Edit"   action="{!editMITAAgreement}" rerender="MITAagreementInfoPanel, messages" rendered="{!AND(chosenMITAAgreement, NOT(editMITAAgreementMode))}" status="Loading"/>
									<apex:commandButton value="Save"   action="{!saveMITAAgreement}" rerender="messages" rendered="{!editMITAAgreementMode}" status="Loading" oncomplete="refreshAccountIfNoErrors()"/>
									<apex:commandButton value="Cancel" action="{!resetMITAAgreement}" rerender="MITAagreementInfoPanel, messages" rendered="{!editMITAAgreementMode}" status="Loading" immediate="true"/>
								</div>

							</apex:outputPanel>

							<!-- SECTION FOR MITA AGREEMENTS -->
							<apex:inputHidden value="{!MITAagreementid}" id="MITAagreementid"/>
							<apex:actionFunction id="selectMITAAgreement" name="selectMITAAgreement" action="{!selectMITAAgreement}" rerender="MITAagreementInfoPanel,messages" status="Loading"/>

							<apex:pageBlockSection title="Agreements" columns="1" id="MITAagreementSearchPanel">
								<apex:outputPanel >
									<div style="float:left; width:30%" >
										<apex:outputText value="{!MITAagreementTypes}" escape="false" />
									</div>
<!-- 									<div style="float:left; width:30%" > -->
<!-- 										<apex:commandButton value="Deactivate MITA member" onclick="return confirm('Are you sure? This will inactivate all MITA agreements for this Airline.');" action="{!deactivateMitaMember}" style="display:block; margin:auto;" /> -->
<!-- 									</div> -->
									<div style="float:right" >
										<input type="radio" name="MITAagreementactive" class="agreementactivefilter" data-type="MITA" data-value=" " />Show all the agreements<br/>
										<input type="radio" name="MITAagreementactive" class="agreementactivefilter" data-type="MITA" data-value="true" checked="checked"/>Active agreements<br/>
										<input type="radio" name="MITAagreementactive" class="agreementactivefilter" data-type="MITA" data-value="false" />Inactive agreements<br/>
									</div>

									<br style="clear:both"/>

									<table id="MITAagreementsTable" class="agreementsTable" >
										<thead>
											<tr>
												<th>Code</th>
												<th>Airline</th>
												<th>Agreement type</th>
												<th>Effective date</th>
												<th class="hide" >Active</th>
												<th>Status</th>
											</tr>
										</thead>
										<tbody>
											<apex:outputText value="{!MITAAgreementTable}" escape="false" />
										</tbody>
									</table>
									<script>
										initAgreementTable(true);
									</script>
									<br/><br/>
								</apex:outputPanel>
							</apex:pageBlockSection>

						</div>


						<!-- THIRD TAB: BIETA -->
						 <div class="mytab" id="tabBIETA">

							<!-- SECTION FOR BIETA AGREEMENT INFO -->
							<apex:outputPanel id="BIETAagreementInfoPanel">
								<apex:pageBlockSection title="Agreement details" columns="1" rendered="{!NOT(chosenBIETAAgreement)}">
									<apex:pageBlockSectionItem />
									<apex:pageBlockSectionItem />
									<apex:pageBlockSectionItem />
								</apex:pageBlockSection>

								<!-- BIETA VIEW -->
								<apex:pageBlockSection id="viewBIETAAgreementInfo" rendered="{!AND(chosenBIETAAgreement,NOT(editBIETAAgreementMode),!wrapper.isMixed)}" title="Agreement details">
									<apex:pageBlockSectionItem >
										<apex:outputLabel for="theLink" value="{!$ObjectType.MITA_Agreement__c.fields.Airline_1__c.Label}" />
										<apex:commandLink id="theLink"
															value="{!wrapper.agreement.Airline_1__r.Name_on_AOC__c}"
															onclick="$('[id$=accountid]').val('{!wrapper.agreement.Airline_1__c}'); selectAccount();"
															rerender="messages"/>
									</apex:PageBlockSectionItem>
									<apex:pageBlockSectionItem >
										<apex:outputLabel for="theLink" value="{!$ObjectType.MITA_Agreement__c.fields.Airline_2__c.Label}" />
										<apex:commandLink id="theLink"
															value="{!wrapper.agreement.Airline_2__r.Name_on_AOC__c}"
															onclick="$('[id$=accountid]').val('{!wrapper.agreement.Airline_2__c}'); selectAccount();"
															rerender="messages"/>
									</apex:PageBlockSectionItem>

									<apex:outputField value="{!wrapper.agreement.Agreement_type__c}" />
									<apex:outputField value="{!wrapper.agreement.Status__c}" />

									<apex:outputField value="{!wrapper.agreement.Effective_date__c}" />
									<apex:outputField value="{!wrapper.agreement.Cancellation_date__c}" />

									<apex:outputField value="{!wrapper.agreement.Agreement_processed_date__c}" />
									<apex:outputField value="{!wrapper.agreement.Cancellation_processed_date__c}" />

									<apex:outputField value="{!wrapper.agreement.Withdrawal_Request_Reception_Date__c}" />
									<apex:outputField value="{!wrapper.agreement.Cancellation_Reason__c}" />
								</apex:pageBlockSection>

								<!-- BIETA EDIT -->
								<apex:inputField value="{!wrapper.agreement.MITAorBIETA__c}" style="display:none" label="" rendered="{!editBIETAAgreementMode}"/>
								<apex:pageBlockSection id="editBIETAAgreementInfo" rendered="{!AND(chosenBIETAAgreement,editBIETAAgreementMode,!wrapper.isMixed)}" title="Agreement details">
									<apex:inputField value="{!wrapper.agreement.Airline_1__c}" rendered="{!AND(wrapper.isNew,wrapper.agreement.Airline_2__c = acc.Id)}" required="true"/>
									<apex:outputField value="{!wrapper.agreement.Airline_1__c}" rendered="{!!AND(wrapper.isNew,wrapper.agreement.Airline_2__c = acc.Id)}"/>
									<apex:inputField value="{!wrapper.agreement.Airline_2__c}" rendered="{!AND(wrapper.isNew,wrapper.agreement.Airline_1__c = acc.Id)}" required="true"/>
									<apex:outputField value="{!wrapper.agreement.Airline_2__c}" rendered="{!!AND(wrapper.isNew,wrapper.agreement.Airline_1__c = acc.Id)}" />

									<apex:inputField value="{!wrapper.agreement.Agreement_type__c}" required="true" rendered="{!wrapper.isNew}"/>
									<apex:PageBlockSectionItem rendered="{!!wrapper.isNew}" />
									<apex:PageBlockSectionItem />

									<apex:inputField value="{!wrapper.agreement.Effective_date__c}" />
									<apex:inputField value="{!wrapper.agreement.Cancellation_date__c}" />

									<apex:inputField value="{!wrapper.agreement.Agreement_processed_date__c}" />
									<apex:inputField value="{!wrapper.agreement.Cancellation_processed_date__c}" />

									<apex:inputField value="{!wrapper.agreement.Withdrawal_Request_Reception_Date__c}" />
									<apex:inputField value="{!wrapper.agreement.Cancellation_Reason__c}" />
								</apex:pageBlockSection>

								<div style="text-align:center;">
									<apex:commandButton value="New"   action="{!newBIETAAgreement}" rerender="BIETAagreementInfoPanel, messages" rendered="{!NOT(editBIETAAgreementMode)}" status="Loading"/>
									<apex:commandButton value="Edit"   action="{!editBIETAAgreement}" rerender="BIETAagreementInfoPanel, messages" rendered="{!AND(chosenBIETAAgreement, NOT(editBIETAAgreementMode))}" status="Loading"/>
									<apex:commandButton value="Save"   action="{!saveBIETAAgreement}" rerender=" messages" rendered="{!editBIETAAgreementMode}" status="Loading" oncomplete="refreshAccountIfNoErrors()"/>
									<apex:commandButton value="Cancel" action="{!resetBIETAAgreement}" rerender="BIETAagreementInfoPanel, messages" rendered="{!editBIETAAgreementMode}" status="Loading" immediate="true"/>
								</div>

							</apex:outputPanel>


							<!-- SECTION FOR BIETA AGREEMENTS -->
							<apex:inputHidden value="{!BIETAagreementid}" id="BIETAagreementid"/>
							<apex:actionFunction id="selectBIETAAgreement" name="selectBIETAAgreement" action="{!selectBIETAAgreement}" rerender="BIETAagreementInfoPanel,messages" status="Loading"/>

							<apex:pageBlockSection title="Agreements" columns="1" id="BIETAagreementSearchPanel">
								<apex:outputPanel >
									<div style="float:left; width: 30%;" >
										<apex:outputText value="{!BIETAagreementTypes}" escape="false" />
									</div>
<!-- 									<div style="float:left; width: 30%;" > -->
<!-- 										<apex:commandButton value="Deactivate BIETA member" onclick="return confirm('Are you sure? This will inactivate all BIETA agreements for this Airline.');" action="{!deactivateBietaMember}" style="display:block; margin:auto;" /> -->
<!-- 									</div> -->
									<div style="float:right" >
										<input type="radio" name="BIETAagreementactive" class="agreementactivefilter" data-type="BIETA" data-value=" " />Show all the agreements<br/>
										<input type="radio" name="BIETAagreementactive" class="agreementactivefilter" data-type="BIETA" data-value="true" checked="checked"/>Active agreemnents<br/>
										<input type="radio" name="BIETAagreementactive" class="agreementactivefilter" data-type="BIETA" data-value="false" />Inactive agreemnents<br/>
									</div>


									<br style="clear:both"/>

									<table id="BIETAagreementsTable" class="agreementsTable" >
										<thead>
											<tr>
												<th>Code</th>
												<th>Airline</th>
												<th>Agreement type</th>
												<th>Effective date</th>
												<th class="hide" >Active</th>
												<th>Status</th>
											</tr>
										</thead>
										<tbody>
											<apex:outputText value="{!BIETAAgreementTable}" escape="false" />
										</tbody>
									</table>
									<script>
										initAgreementTable(false);
									</script>
									<br/><br/>
								</apex:outputPanel>
							</apex:pageBlockSection>

						</div>

						<!-- FOURTH TAB: CONTACTS -->
						<div class="mytab "  id="tabContacts">
							<apex:pageBlockSection id="contactList" title="Airline Contacts" columns="1" >
								<apex:pageBlockTable value="{!contacts}" var="c" onRowClick="clickOnContact('{!c.Id}')">
									<apex:column headerValue="Name">
										<apex:outputLink value="/{!c.Id}" target="_blank" >{!c.Name}</apex:outputLink>
									</apex:column>
									<apex:column headerValue="Title">
										<apex:outputField value="{!c.Title}" />
									</apex:column>
									<apex:column headerValue="Email">
										<apex:outputField value="{!c.Email}" />
									</apex:column>
									<apex:column headerValue="Contact Type">
										<apex:outputField value="{!c.MITA_Contact_Type__c}" />
									</apex:column>
									<apex:column headerValue="Teletype">
										<apex:outputField value="{!c.MITA_Teletype__c}" />
									</apex:column>
								</apex:pageBlockTable>
							</apex:pageBlockSection>

							<br/><br/>

							<!-- SECTION WITH CONTACT DETAILS -->
							<apex:outputPanel id="contactDetailPanel">
								<apex:pageBlockSection title="Contact detail" rendered="{!AND(chosenContact, NOT(editContactMode))}">
									<apex:outputField value="{!c.Salutation}" />
									<apex:pageBlockSectionItem />

									<apex:outputField value="{!c.Name}" />
									<apex:outputField value="{!c.Status__c}" />

									<apex:outputField value="{!c.Title}" />
									<apex:outputField value="{!c.Email}" />

									<apex:outputField value="{!c.Phone}" />
									<apex:outputField value="{!c.Fax}" />

									<apex:outputField value="{!c.MITA_Contact_Type__c}" />
									<apex:outputField value="{!c.MITA_Teletype__c}" />

									<apex:outputField value="{!c.OtherStreet}" />
									<apex:outputField value="{!c.OtherCity}" />
									<apex:outputField value="{!c.OtherPostalcode}" />
									<apex:outputField value="{!c.OtherState}" />
									<apex:outputField value="{!c.OtherCountry}" />

								</apex:pageBlockSection>
								<apex:pageBlockSection title="Contact detail" rendered="{!AND(chosenContact, editContactMode)}">
									<apex:inputField value="{!c.Salutation}" />
									<apex:inputField value="{!c.Status__c}" />

									<apex:inputField value="{!c.FirstName}" required="true"/>
									<apex:inputField value="{!c.LastName}" required="true"/>


									<apex:inputField value="{!c.Title}" required="true"/>
									<apex:inputField value="{!c.Email}" required="true"/>

									<apex:inputField value="{!c.Phone}" />
									<apex:inputField value="{!c.Fax}" />

									<apex:inputField value="{!c.MITA_Contact_Type__c}" />
									<apex:inputField value="{!c.MITA_Teletype__c}" />

									<apex:inputField value="{!c.OtherStreet}" />
									<apex:inputField value="{!c.OtherCity}" />
									<apex:inputField value="{!c.OtherPostalcode}" />
									<apex:inputField value="{!c.OtherState}" />
									<apex:inputField value="{!c.OtherCountry}" />
								</apex:pageBlockSection>


								<!-- SECTION WITH FORM FOR SEARCHING CONTACTS BY EMAIL -->
								<apex:outputPanel id="searchContactPanel" rendered="{!AND(searchContactMode, NOT(confirmMoveContactMode))}">
									<apex:pageBlockSection title="Find a contact by email" >
										<apex:inputText label="Contact Email" value="{!contactEmail}" required="true"/>
									</apex:pageBlockSection>
									<apex:pageBlockSection title="Choose the proper contact" rendered="{!duplicateContactMode}" columns="1">
							             <apex:dataTable value="{!duplicateContacts}" var="cv" columnsWidth="20%" columnClasses="contactColumns" style="width:100%">
							                <apex:column >
							                     <apex:commandLink action="{!chooseContact}" value="Choose this contact" status="Loading" oncomplete="selectAccount()">
							                     	<apex:param value="{!duplicateContacts[cv].Id}" name="contactId"/>
							                     </apex:commandLink>
							                </apex:column>
							                <apex:column headerValue="Contact Name" ><a href="/{!duplicateContacts[cv].id}" target="_blank">{!duplicateContacts[cv].Name}</a></apex:column>
							                <apex:column value="{!duplicateContacts[cv].Title}" headerValue="Title"/>
							                <apex:column value="{!duplicateContacts[cv].Account.Name_on_AOC__c}" headerValue="Account Name"/>
							                <apex:column value="{!duplicateContacts[cv].Account.IATA_ISO_Country__r.Name}" headerValue="Country"/>
							            </apex:dataTable>
							        </apex:pageBlockSection>
								</apex:outputPanel>

								<!-- SECTION WHICH ASKS A CONFIRMATION FOR MOVING CONTACT AND ALLOWS USER TO CHANGE SOME FIELDS -->
								<apex:pageBlockSection rendered="{!confirmMoveContactMode}" columns="1">
									<apex:pageBlockSection title="Contact detail" >
										<apex:inputField value="{!foundContact.Salutation}" />
										<apex:inputField value="{!foundContact.Status__c}" />

										<apex:outputField value="{!foundContact.FirstName}" />
										<apex:outputField value="{!foundContact.LastName}" />


										<apex:inputField value="{!foundContact.Title}" required="true"/>
										<apex:inputField value="{!foundContact.Email}" required="true"/>

										<apex:inputField value="{!foundContact.Phone}" />
										<apex:inputField value="{!foundContact.Fax}" />

										<apex:inputField value="{!foundContact.MITA_Contact_Type__c}" />
										<apex:inputField value="{!foundContact.MITA_Teletype__c}" />

										<apex:inputField value="{!foundContact.OtherStreet}" />
										<apex:inputField value="{!foundContact.OtherCity}" />

										<apex:inputField value="{!foundContact.OtherPostalcode}" />
										<apex:inputField value="{!foundContact.OtherState}" />

										<apex:inputField value="{!foundContact.OtherCountry}" />
									</apex:pageBlockSection>
									<apex:pageMessage severity="Warning" strength="2" summary="If you proceed the contact {!foundContact.Name} will be moved from the {!foundContact.Account.Name_on_AOC__c} to {!acc.Name_on_AOC__c}. Do you really want to proceed?" />
								</apex:pageBlockSection>


								<div style="text-align:center;">
									<apex:commandButton value="New Contact"   action="{!newContact}" rerender="contactDetailPanel, messages" rendered="{!NOT(OR(editContactMode, searchContactMode))}" status="Loading"/>
									<apex:commandButton value="Edit Contact"   action="{!editContact}" rerender="contactDetailPanel, messages" rendered="{!AND(chosenContact,NOT(editContactMode))}" status="Loading"/>
									<apex:commandButton value="Save Contact"   action="{!saveContact}" rerender="messages" rendered="{!editContactMode}" status="Loading" oncomplete="refreshAccountIfNoErrors()"/>

									<apex:commandButton value="Add existing contact"   action="{!searchContact}" rerender="contactDetailPanel, messages" rendered="{!NOT(OR(editContactMode,searchContactMode))}" status="Loading"/>
									<apex:commandButton value="Choose Contact" rerender="messages"  action="{!moveContact}" rendered="{!AND(searchContactMode, NOT(duplicateContactMode), NOT(confirmMoveContactMode))}" status="Loading" oncomplete="selectAccount()"/>
									<apex:commandButton value="Confirm" rerender="messages"  action="{!confirmMoveContact}" rendered="{!confirmMoveContactMode}" status="Loading" oncomplete="selectAccount()"/>

									<apex:commandButton value="Remove from MITA contacts" rerender="contactDetailPanel,messages" action="{!removeContactFromMITA}" rendered="{!AND(chosenContact,NOT(editContactMode))}" status="Loading" onclick="if(!confirm('Are you sure you want remove this contact from MITA contacts?')) return false;" oncomplete="selectAccount()"/>

									<apex:commandButton value="Cancel" action="{!resetContact}" rerender="contactDetailPanel, messages" rendered="{!OR(editContactMode,searchContactMode,duplicateContactMode,confirmMoveContactMode)}" status="Loading" immediate="true"/>
								</div>
								<apex:inputHidden value="{!contactid}" id="contactid"/>
								<apex:actionFunction id="selectContact" name="selectContact" action="{!selectContact}" rerender="contactDetailPanel, messages" status="Loading"/>

							</apex:outputPanel>
						</div>

						<script>showTab()</script>
					</div>



					<br/><br/>



				</apex:pageBlock>
				</apex:form>
			</apex:outputPanel>
		</apex:outputPanel>
	</apex:panelGrid>

    <script>

		var airlinesTable;
		var MITAagreementsTable;
		var BIETAagreementsTable;
		var activeTab = 'Airline';

		/****** METHODS TO SET UP AIRLINE DATA TABLE *****/
        $(document).ready( function () {

           initAirlineTable();

    		// FILTER management

    		$('#OnlyMITAAirlines').on( 'change', function(){ initAirlineTable();});
			$('#filterOn').on( 'change', function(){ initAirlineTable(); } );

			function initAirlineTable(){
				var searchstring = $("#airlinesTable_wrapper input[type='search']").size()==0 ? "" : $("#airlinesTable_wrapper input[type='search']").val();
				var member = $('#OnlyMITAAirlines').prop('checked') ? "true" : "";
				var code = $("#filterOn").val() == "code" || $("#filterOn").val() == "all";
				var name = $("#filterOn").val() == "name" || $("#filterOn").val() == "all";

				airlinesTable = $('#airlinesTable').DataTable({
					"lengthChange": false,
					"dom": '<"searchwrapper"f>rt<"bottom"ip><"clear">',
					"pageLength": 15,
					"columnDefs": [
						{ "name": "dcode", "targets": 0, "searchable": code},
						{ "name": "ncode", "targets": 1, "searchable": code},
						{ "name": "name", "targets": 2, "searchable": name},
						{ "name": "member", "targets": 3, "visible":false }
					],
					"oSearch": {"sSearch": searchstring},
					"bDestroy": true
				});
				airlinesTable.column('member:name').search(member).draw();
			}


    		// ONCLICK for all the rows
            $(airlinesTable.rows().nodes()).click(function () {

            	$(airlinesTable.rows().nodes()).removeClass('selected');
            	$(this).addClass('selected');
				$('[id$=accountid]').val($(this).attr('id'));
				localStorage.setItem("accountId", $(this).attr('id'));

              	selectAccount();
           });

			// INIT the page with the last account this user viewed.
			if(typeof(Storage) !== "undefined"){
				var accID = localStorage.getItem("accountId");
				if(accID != null){
					$('[id$=accountid]').val(accID);
					selectAccount();
				}
			}



        });


        // AFTER AIRLINE IS SAVED this function is called to keep up to date the table on the left
        function updateAirlineList(){
        	var member = $("[class$='MITAMember'] img").attr('src').indexOf('unchecked') == -1;
        	var aid = $('[id$=accountid]').val();
        	airlinesTable.rows().search();

        	var olddata = airlinesTable.row("#"+aid).data();
        	olddata[3] = member;
        	airlinesTable.row("#"+aid).data(olddata);
        	airlinesTable.draw();

        }

        function refreshAccountIfNoErrors(){
        	var n = $("[id*='HowManyErrors']").val();
        	if(parseInt(n)==0)
        		selectAccount();
        }

        /****** METHODS FOR AGREEMENTS ******/


        function initAgreementTable(isMITA){
			var agreementsTable = $('#'+(isMITA ? 'MITA' : 'BIETA')+'agreementsTable').DataTable({
				"dom": '<"top" lf>rt<"bottom"ip><"clear">',
				"pageLength": 50,
				"columnDefs": [
					{ "name": "code", "targets": 0 },
					{ "name": "name", "targets": 1 },
					{ "name": "type", "targets": 2 },
					{ "name": "startdate", "targets": 3 },
					{ "name": "active", "targets": 4 }
				]
			});

			if(isMITA)
				MITAagreementsTable = agreementsTable;
			else
				BIETAagreementsTable = agreementsTable;

			filterAgreements(isMITA);

			$(agreementsTable.rows().nodes()).click(function () {
            	$('[id$='+(isMITA ? 'MITA' : 'BIETA')+'agreementid]').val($(this).attr('id'));

            	if(isMITA){
            		$(MITAagreementsTable.rows().nodes()).removeClass('selected');
            		selectMITAAgreement();
            	}else{
            		$(BIETAagreementsTable.rows().nodes()).removeClass('selected');
            		selectBIETAAgreement();
            	}
            	$(this).addClass('selected');

				selectAgreement();


            });


            $(".agreementtypefilter, .agreementactivefilter").on( 'change', function(){
            	var isMITA = $(this).attr('data-type') == "MITA";
            	filterAgreements(isMITA);
            });


            function filterAgreements(isMITA){
            	var MB = isMITA ? "MITA" : "BIETA";
            	var typefilter = $('.agreementtypefilter[data-type="'+MB+'"]:checked').attr("data-value");
            	var activefilter = $('.agreementactivefilter[data-type="'+MB+'"]:checked').attr("data-value");

            	if(isMITA)
            		MITAagreementsTable
            			.column('type:name').search('"'+typefilter+'"')
            			.column('active:name').search('"'+activefilter+'"')
            			.draw();
            	else
            		BIETAagreementsTable
						.column('type:name').search('"'+typefilter+'"')
            			.column('active:name').search('"'+activefilter+'"')
            			.draw();
            }
        }

        /****** METHODS TO MANAGE THE CONTACT TAB ******/
        function clickOnContact(contactId){
        	$('[id$=contactid]').val(contactId);
           	selectContact();
        }


        function showTab(name){
        	// this will happen if I just refresh the page or a the right column
        	if(name==null)
        		name = activeTab;
        	// this happens when user explicitly cliks on a tab
        	else{
        		if($('#canChangeTab').val()!="true"){
	        		alert("The current tab has operations in progress. Please complete them before swithching to an other tab");
	        		return;
	        	}
        		activeTab = name;
        	}
        	$(".mytab, .mytabheader").removeClass("active");
        	$("#tab"+name+", #hd"+name).addClass("active");

        }
    </script>
	<style>
		.mytabheadercontainer{}
		.mytabheader{display:inline-block; border:1px solid lightgrey; border-top-left-radius:0.5em; border-top-right-radius:0.5em; padding:0.5em; margin-left:0.1em; font-weight:bold; cursor:pointer;}
		.mytabheader.active{background:#00655A; border:none; color:white; border:1px solid #00655A;}

		.mytabcontainer{ border:1px solid lightgrey; border-top:5px solid #00655A; border-radius:5px; border-top-left-radius:0; padding:1em;}
		.mytab{display:none; }
		.mytab.active{display:block;}
		.searchwrapper{display:inline-block;}
	</style>

</apex:page>