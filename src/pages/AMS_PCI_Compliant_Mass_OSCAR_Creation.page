<apex:page controller="AMS_PCI_Compliant_Mass_OSCAR_CreationCtr" sidebar="false">
  <script src="//code.jquery.com/jquery-1.12.3.min.js"/>
  <script src="//cdn.datatables.net/1.10.4/js/jquery.dataTables.min.js" />
  <link rel="stylesheet" href="//cdn.datatables.net/1.10.4/css/jquery.dataTables.css" />

  <style type="text/css">
    .filterBox {width: 250px;}
    .black_overlay{
        position: absolute;
        top: 0%;
        left: 0%;
        width: 100%;
        height: 100%;
        background-color: black;
        z-index:1001;
        -moz-opacity: 0.8;
        opacity:.80;
        filter: alpha(opacity=80);
    }
    .white_content {
        position: absolute;
        top: 25%;
        left: 25%;
        width: 50%;
        padding: 16px;
        z-index:1002;
        overflow: auto;
    }
    .errorMessage {color: #D8000C;}
    .successMessage {color: #4F8A10;}
  </style>
  <script>
    $( document ).ready(function() {
      $(".regionPicklist option[value='GVA HO']").remove();
      $(".regionPicklist option[value='Europe (Americas Countries)']").remove();
      $( ".requiredBox" ).each(function() {
        $(this).wrap( '<div class="requiredInput"></div>');
        $(this).before('<div class="requiredBlock"></div>');
      });
    });
  </script>

  <apex:form id="mainForm">
    <apex:PageMessages />
    <apex:actionFunction action="{!null}" name="refreshForm" reRender="searchResult"/>
    <c:Loading />
    <apex:pageBlock title="PCI Oscar mass creation" mode="edit">
      <table width="100%" border="0">
        <tr>
          <td width="200" valign="top">
            <apex:pageBlock id="filters" title="Filters" mode="edit">
              <apex:pageBlockButtons location="bottom">
                <apex:commandButton value="Search" action="{!searchPreview}" rerender="mainForm" status="Loading"/>
                <apex:commandButton value="Reset" action="{!reset}" rerender="mainForm" status="Loading"/>
              </apex:pageBlockButtons>
              <apex:pageBlockSection id="filterSection" columns="1">
                <apex:selectList value="{!filter.operation}" label="Operation Type" multiselect="false" size="1" required="true" styleclass="filterBox requiredBox" disabled="true">
                  <apex:selectOption itemValue="PCI" itemLabel="PCI"/>
                </apex:selectList>
                <apex:selectList value="{!filter.region}" label="Regions" multiselect="false" size="1" required="true" styleclass="filterBox requiredBox">
                  <apex:selectOption itemValue="" itemLabel="-- None --" />
                  <apex:selectOption itemValue="Americas" itemLabel="Americas" />
                  <apex:selectOption itemValue="Europe" itemLabel="Europe" />
                  <apex:selectOption itemValue="Africa & Middle East" itemLabel="Africa & Middle East" />
                  <apex:selectOption itemValue="China & North Asia" itemLabel="China & North Asia" />
                  <apex:selectOption itemValue="Asia & Pacific" itemLabel="Asia & Pacific" />
                  <apex:actionSupport event="onchange" reRender="countryList" id="Us3"/>
                </apex:selectList>
                <c:MultiselectPicklist id="countryList" 
                           leftLabel="{!$Label.ISSP_AMS_eBulletin_AvailableCountries}" 
                           leftOptions="{!countryNameListSelectOption}"
                           rightLabel="{!$Label.ISSP_AMS_eBulletin_SelectedCountries}"
                           rightOptions="{!CountrySelected}"
                           size="8"
                           width="100px"
                           btn_up_down="false"
                           readonly="false"/>
                <c:MultiselectPicklist id="locationTypes" 
                           leftLabel="Available Locations" 
                           leftOptions="{!locationTypes}"
                           rightLabel="Selected Locations"
                           rightOptions="{!selectedLocationTypes}"
                           size="8"
                           width="100px"
                           btn_up_down="false"
                           readonly="false"/>
              </apex:pageBlockSection>
            </apex:pageBlock>
          </td>
          <td valign="top">
            <apex:pageBlock id="searchResult" title="Result">
              <apex:pageMessage severity="error" 
                                strength="1" 
                                summary="Too many accounts founded, please remove some countries from the filter" 
                                rendered="{!tooMuchResults}"/>    

              
              
              <apex:pageBlockButtons location="bottom">
                <apex:commandButton value="{!approvalButtonLabel}" disabled="{!OR(isBatchRunning, isBatchFinished, srw.totalAccounts == 0, tooMuchResults)}" action="{!createPCIOscar}"/>                 
              </apex:pageBlockButtons>
              <table border="0" style="display: {!IF(tooMuchResults, 'none', '')}">
                <tr>
                  <th width="150px">Country</th>
                  <th width="150px" align="center"># Cases to create</th>
                  <th width="150px" align="center"># Errors</th>
                  <th width="150px" align="center"># Created Cases</th>
                </tr>
                <apex:repeat value="{!srw.mapNrAccounts}" var="country">
                  <tr>
                      <td>{!country}</td>
                      <td><apex:outputText value="{!srw.mapNrAccounts[country]}"/></td>
                      <td><apex:outputText value="{!srw.mapCountriesErrors[country]}"/></td>
                      <td><apex:outputText value="{!IF(!isBatchFinished,0,srw.mapNrAccounts[country] - srw.mapCountriesErrors[country])}"/></td>
                  </tr>
                </apex:repeat>
                  <tr>
                      <td style="font-weight: bold;">Total</td>
                      <td>{!srw.totalAccounts}</td>
                      <td>{!srw.totalErrors}</td>
                      <td>{!IF(!isBatchFinished,0,srw.totalAccounts - srw.totalErrors)}</td>
                  </tr>
              </table>
              <br/>
              <br/>
              <apex:actionRegion >
                <apex:outputPanel id="batchInfo">
                  <apex:pageMessage severity="info" strength="1" summary="The batch is running" rendered="{!isBatchRunning}"/>
                  <apex:pageMessage severity="confirm" strength="1" summary="The batch is completed" rendered="{!isBatchFinished}"/>
                </apex:outputPanel>
                <apex:actionPoller action="{!checkBatchStatus}" reRender="batchInfo, lstAccounts" interval="5" enabled="{!isPollerActive}" 
                                   oncomplete="if('{!isBatchFinished}' == 'true') {refreshForm();}"/>
              </apex:actionRegion> 
              <c:AMS_Batch_Progress_Bar id="progressBar"
                             cNumberOfJobs="1" 
                             cBatchId="{!batchId}"
                             cIsCompleted="{!NOT(isBatchFinished)}"
                             rendered="{!isBatchRunning || isBatchFinished}"
              />
            </apex:pageBlock>
          </td>
        </tr>
      </table>
    </apex:pageBlock>
  </apex:form>
</apex:page>