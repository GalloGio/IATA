<apex:page controller="AMS_PCI_Compliant_Mass_OSCAR_CreationCtr" sidebar="false">

	<style type="text/css">
	.filterBox { width: 100%; }
	.alignTop td { vertical-align: baseline; }
	.resultsTable td { width: 150px }
	.resultsTable tfoot td:first-child { font-weight: bold; }
	</style>

	<apex:form id="mainForm">
		<c:Loading />
		<apex:pageBlock title="PCI Oscar mass creation" mode="edit">
			<apex:pageMessages/>
			<apex:panelGrid columns="2" rowClasses="alignTop">
				<apex:pageBlockSection id="filters" title="Filters" columns="1">
					
					<apex:pageBlockSectionItem labelTitle="Operation Type">
						<apex:outputLabel value="Operation Type"/>
						<apex:outputPanel styleClass="requiredInput" layout="block">
							<apex:outputPanel styleClass="requiredBlock" layout="block"/>
							<apex:selectList value="{!operation}" multiselect="false" size="1" required="true" styleclass="filterBox">
								<apex:selectOption itemValue="PCI" itemLabel="PCI"/>
								<apex:selectOption itemValue="FOP" itemLabel="FOP Oscars"/>

								<apex:actionSupport event="onchange" reRender="filters" id="Us2"/>
							</apex:selectList>
						</apex:outputPanel>
					</apex:pageBlockSectionItem>

					<apex:pageBlockSectionItem labelTitle="Regions">
						<apex:outputLabel value="Regions"/>
						<apex:outputPanel styleClass="requiredInput" layout="block">
							<apex:outputPanel styleClass="requiredBlock" layout="block"/>
							<apex:selectList value="{!region}" multiselect="false" size="1" required="true" styleclass="filterBox">
								<apex:selectOption itemValue="" itemLabel="-- None --" />
								<apex:selectOption itemValue="Americas" itemLabel="Americas" />
								<apex:selectOption itemValue="Europe" itemLabel="Europe" />
								<apex:selectOption itemValue="Africa & Middle East" itemLabel="Africa & Middle East" />
								<apex:selectOption itemValue="China & North Asia" itemLabel="China & North Asia" />
								<apex:selectOption itemValue="Asia & Pacific" itemLabel="Asia & Pacific" />

								<apex:actionSupport event="onchange" reRender="filters" id="Us3"/>
							</apex:selectList>
						</apex:outputPanel>
					</apex:pageBlockSectionItem>

					<apex:pageBlockSectionItem helpText="If operation is FOP Oscars, only New Gen countries will be selected">
						<c:MultiselectPicklist id="countryList" 
							leftLabel="{!$Label.ISSP_AMS_eBulletin_AvailableCountries}" 
							leftOptions="{!availableCountries}"
							rightLabel="{!$Label.ISSP_AMS_eBulletin_SelectedCountries}"
							rightOptions="{!selectedCountries}"
							size="8"
							width="100px"
							btn_up_down="false"
							readonly="false"
							rendered="{!NOT(ISBLANK(operation))}"/>
					</apex:pageBlockSectionItem>

                    <apex:pageBlockSectionItem id="locationClasses" rendered="{!operation == 'PCI'}">
                      <c:MultiselectPicklist 
							leftLabel="Available Classes" 
                            leftOptions="{!availableClasses}"
                            rightLabel="Selected Classes"
                            rightOptions="{!selectedClasses}"
                            size="3"
                            width="100px"
                            btn_up_down="false"
                            readonly="false"
                            rendered="{!NOT(ISBLANK(operation))}"/>
                    </apex:pageBlockSectionItem>

					<apex:pageBlockSectionItem id="locationTypes">
                        <c:MultiselectPicklist 
							leftLabel="Available Locations" 
							leftOptions="{!availableLocations}"
							rightLabel="Selected Locations"
							rightOptions="{!selectedLocations}"
							size="8"
							width="100px"
							btn_up_down="false"
							readonly="false"
							rendered="{!NOT(ISBLANK(operation))}"/>
					</apex:pageBlockSectionItem>

					<apex:pageBlockSectionItem>
						<apex:outputPanel layout="block" style="text-align: center;">
							<apex:commandButton value="Search" action="{!search}" rerender="mainForm" status="Loading"/>
							<apex:commandButton value="Reset" action="{!reset}" rerender="mainForm" status="Loading"/>
						</apex:outputPanel>
					</apex:pageBlockSectionItem>
				</apex:pageBlockSection>

				<apex:pageBlockSection id="searchResult" title="Result" columns="1">
					<apex:pageMessage severity="error" 
					strength="1" 
					summary="Too many accounts founded, please remove some countries from the filter" 
					rendered="{!tooMuchResults}"/>

					<apex:dataTable value="{!summary}" var="country" rendered="{!NOT(tooMuchResults)}" styleClass="resultsTable">
						<apex:column headerValue="Country" value="{!country.name}" footerValue="Total" />
						<apex:column headerValue="# Cases to create" value="{!country.toCreate}" footerValue="{!totalAccounts}"/>
						<apex:column headerValue="# Errors" value="{!country.errors}">
							<apex:facet name="footer">{!IF(!isBatchFinished,0,totalErrors)}</apex:facet>
						</apex:column>
						<apex:column headerValue="# Created Cases" value="{!country.created}">
							<apex:facet name="footer">{!IF(!isBatchFinished,0,totalCreated)}</apex:facet>
						</apex:column>
					</apex:dataTable>

					<apex:pageBlockSectionItem  >
						<apex:commandButton value="Create OSCARs" disabled="{!OR(isBatchRunning, isBatchFinished, totalAccounts == 0, tooMuchResults)}" action="{!createOSCARs}" reRender="batchInfo"/>                 
					</apex:pageBlockSectionItem>
					
					<apex:outputPanel id="batchInfo">
						<apex:pageMessage severity="info" strength="1" summary="The batch is running" rendered="{!isBatchRunning}"/>
						<apex:pageMessage severity="confirm" strength="1" summary="The batch is completed" rendered="{!isBatchFinished}"/>
						<apex:actionRegion>
							<apex:actionPoller action="{!checkBatchStatus}" reRender="batchInfo, searchResult" interval="5" enabled="{!isBatchRunning}" />
						</apex:actionRegion> 
						<c:AMS_Batch_Progress_Bar id="progressBar"
							cNumberOfJobs="1" 
							cBatchId="{!batchId}"
							cIsCompleted="{!NOT(isBatchFinished)}"
							rendered="{!isBatchRunning || isBatchFinished}"
						/>
					</apex:outputPanel>
				</apex:pageBlockSection>
			</apex:panelGrid>
		</apex:pageBlock>
	</apex:form>
</apex:page>
