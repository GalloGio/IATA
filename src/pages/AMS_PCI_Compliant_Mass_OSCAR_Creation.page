<apex:page controller="AMS_PCI_Compliant_Mass_OSCAR_CreationCtr" sidebar="false">
<script src="//code.jquery.com/jquery-1.12.3.min.js"/>
<script src="//cdn.datatables.net/1.10.4/js/jquery.dataTables.min.js" />
<link rel="stylesheet" href="//cdn.datatables.net/1.10.4/css/jquery.dataTables.css" />

  <style>
    .filterBox {width: 250px;}
    .black_overlay{
        position: absolute;
        top: 0%;
        left: 0%;
        width: 100%;
        height: 100%;
        background-color: black;
        z-index:1001;
        -moz-opacity: 0.8;
        opacity:.80;
        filter: alpha(opacity=80);
    }
    .white_content {
        position: absolute;
        top: 25%;
        left: 25%;
        width: 50%;
        padding: 16px;
        z-index:1002;
        overflow: auto;
    }
    .errorMessage {color: #D8000C;}
    .successMessage {color: #4F8A10;}
  </style>

  <apex:form id="mainForm">
  <script>
  $( document ).ready(function() {
    $(".regionPicklist option[value='GVA HO']").remove();
    $(".regionPicklist option[value='Europe (Americas Countries)']").remove();
    // apply table pagination
    setPagination();
    $( ".requiredBox" ).each(function() {
      $(this).wrap( '<div class="requiredInput"></div>');
      $(this).before('<div class="requiredBlock"></div>');
    });
  });

  function setPagination() {
    $(".result-table").DataTable( {
      "destroy": true,
      "searching": false,
      "lengthMenu": [ 10, 25, 50, 100, 200, 500, 1000 ]
    });
  }

  function selectCheckboxes(value) {
    $(".line-select").each(function() {
      this.checked = value;
    });
  }

  function getSelectedIds() {
    var selectedIds = [];
    $(".result-table .dataRow").each(function() {

      var ischecked = false;
      console.log(this);
      $(this).find(".line-select").each(function() {
        ischecked = $(this).prop('checked');
      });
      if (ischecked) {
        $(this).find(".id-value").each(function() {
          selectedIds.push(this.innerHTML.trim());
        });
      }
    });
    return selectedIds;
  }

  </script>



  <c:Loading />

  <apex:pageBlock title="PCI Oscar mass creation" mode="edit">

  <apex:pageMessages id="errors" />
  <table width="100%" border="0">
  <tr>
    <td width="200" valign="top">

      <!-- Filter Section -->
      <apex:pageBlock id="filters" title="Filters" mode="edit" >

        <apex:pageBlockButtons location="bottom">
        	<apex:commandButton value="Search" action="{!searchPreview}" />
          	<apex:commandButton value="Reset" action="{!reset}" rerender="mainForm" status="Loading"/>
        </apex:pageBlockButtons>

        <apex:pageBlockSection id="filterSection" columns="1">
	        <apex:selectList value="{!filter.operation}" label="Operation Type" multiselect="false" size="1" required="true" styleclass="filterBox requiredBox" disabled="true">
	            <!-- <apex:selectOption itemValue="" itemLabel="-- None --" /> -->
	            <apex:selectOption itemValue="PCI" itemLabel="PCI"/>
	        </apex:selectList>
          <apex:selectList value="{!filter.region}" label="Regions" multiselect="false" size="1" required="true" styleclass="filterBox requiredBox">
              <apex:selectOption itemValue="" itemLabel="-- None --" />
              <apex:selectOption itemValue="Americas" itemLabel="Americas" />
              <apex:selectOption itemValue="Europe" itemLabel="Europe" />
              <apex:selectOption itemValue="Africa & Middle East" itemLabel="Africa & Middle East" />
              <apex:selectOption itemValue="China & North Asia" itemLabel="China & North Asia" />
              <apex:selectOption itemValue="Asia & Pacific" itemLabel="Asia & Pacific" />
              <apex:actionSupport event="onchange" reRender="countryList" id="Us3"/>
          </apex:selectList>
          <c:MultiselectPicklist id="countryList" 
                         leftLabel="{!$Label.ISSP_AMS_eBulletin_AvailableCountries}" 
                         leftOptions="{!countryNameListSelectOption}"
                         rightLabel="{!$Label.ISSP_AMS_eBulletin_SelectedCountries}"
                         rightOptions="{!CountrySelected}"
                         size="8"
                         width="100px"
                         btn_up_down="false"
                         readonly="false"/>

        </apex:pageBlockSection>

    </apex:pageBlock>

    </td>
    <td valign="top">
    <apex:actionFunction action="{!createPCIOscar}" name="createPCIOscar" >
      <apex:param name="selectedIds" value="" assignTo="{!selectedIds}"/>
    </apex:actionFunction>
    <apex:actionFunction action="{!null}" name="reRenderLst" reRender="lstAccounts"/>
      
      <apex:pageBlock title="Accounts">
        <apex:pageBlockButtons location="bottom">
          <apex:commandButton value="{!approvalButtonLabel}" onclick="console.log(getSelectedIds()); createPCIOscar(getSelectedIds());" 
              disabled="{!OR(isBatchRunning, isBatchFinished, lstAccountsWrapper.size == 0)}" rendered="{!showResults}" reRender="mainForm" oncomplete="setPagination();">            
          </apex:commandButton>          
        </apex:pageBlockButtons> 

        <apex:actionRegion >
          <apex:outputPanel id="batchInfo">
            <apex:pageMessage severity="info" strength="1" summary="The batch is running" rendered="{!isBatchRunning}"/>
            <apex:pageMessage severity="confirm" strength="1" summary="The batch is completed" rendered="{!isBatchFinished}"/>          
          </apex:outputPanel>
          <apex:actionPoller action="{!checkBatchStatus}" reRender="batchInfo, lstAccounts" interval="5" enabled="{!isPollerActive}" 
          oncomplete="setPagination();"/>
        </apex:actionRegion>
        <apex:outputPanel id="lstAccounts">
          <apex:outputPanel rendered="{!showResults}" style="margin-bottom: 5px;" layout="block">
            <!-- <apex:commandButton value="Select All" action="{!selectAll}"/> -->
            <input type="button" value="Select All" onclick="selectCheckboxes(true);"/>
            <!-- <apex:commandButton value="Deselect All" action="{!deselectAll}"/> -->
            <input type="button" value="Deselect All" onclick="selectCheckboxes(false);"/>
          </apex:outputPanel>
          <apex:pageBlockTable value="{!lstAccountsWrapper}" var="wrapper" rendered="{!showResults}" styleclass="result-table">
            <apex:column styleclass="id-value hidden" headerClass="hidden">
              {!wrapper.accountRecord.Id}
            </apex:column>

            <apex:column >
              <apex:inputCheckbox styleClass="line-select" value="{!wrapper.selected}" disabled="{!isBatchFinished}"/>
              <!-- <input class="line-select" type="checkbox"/> -->
            </apex:column>
            <apex:column >
              <apex:facet name="header">Account</apex:facet>
              <apex:outputLink value="/{!wrapper.accountRecord.Id}?retURL={!$CurrentPage.URL}" target="_blank">
                {!wrapper.accountRecord.Name}
              </apex:outputLink>
            </apex:column>
            <apex:column >
              <apex:facet name="header">Contact</apex:facet>
              <apex:outputLink value="/{!wrapper.contactRecord.Id}?retURL={!$CurrentPage.URL}" target="_blank">
                {!wrapper.contactRecord.Name}
              </apex:outputLink>
            </apex:column>
            <apex:column value="{!wrapper.portalStatus}" >
              <apex:facet name="header">Contact Portal Status</apex:facet>
            </apex:column>
            <apex:column value="{!wrapper.accountRecord.IATACode__c}" >
              <apex:facet name="header">IATA Code</apex:facet>
            </apex:column>
            <apex:column value="{!wrapper.accountRecord.IATA_ISO_Country__c}" >
              <apex:facet name="header">Country</apex:facet>
            </apex:column>
            <apex:column width="20%">
              <apex:facet name="header">Case</apex:facet>
              <apex:outputPanel layout="none" rendered="{!isBatchFinished}" >
                <apex:outputLink rendered="{!NOT(ISNULL(wrapper.caseRecord))}" value="/{!wrapper.caseRecord.Id}?retURL={!$CurrentPage.URL}" 
                                 target="_blank">
                  {!wrapper.caseRecord.CaseNumber}
                </apex:outputLink>
                <apex:outputText rendered="{!AND(ISNULL(wrapper.caseRecord),wrapper.selected)}" value="Error: {!mapAccountToError[wrapper.accountRecord.Id]}"/>
              </apex:outputPanel>
            </apex:column>
          </apex:pageBlockTable>
        </apex:outputPanel>  
      </apex:pageBlock>    
    
  </td>
    </tr>
  </table>
  </apex:pageBlock>
  </apex:form>
</apex:page>