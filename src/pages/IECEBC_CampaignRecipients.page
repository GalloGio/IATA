<apex:page standardController="EBC_Campaign__c" extensions="vfIECEBC_Campaign,vfIECEBC_CampaignRecipient" applyHtmlTag="false" applyBodyTag="false" sidebar="false" showheader="false" standardStylesheets="false" language="en" docType="html-5.0" action="{!pageLoad}">
	<apex:composition template="IECEBC_Layout">
        <apex:define name="pageHeadAdditions">
            <!-- Start of Page <head> -->
            <title>eBroadcast Campaign - Select recipients</title>
            <!-- End of Page </head> -->
        </apex:define>
        <apex:define name="pageScriptAdditions">
            <!-- If any page specific .js, add them here -->
            <script type="text/javascript">
            	jQuery(document).on('change', 'input[name="geo-filtering"]', function(){
                	if (jQuery(this).val() == 'custom-filter') {
                    	jQuery('#custom-filter-block').show();
                    } else {
                    	jQuery('#custom-filter-block').hide();
                    }
                });
            </script>
            <style type="text/css"> 
            	#existingLists .number-of-recipients { display: none; }
            	.no-provisional-cost #existingLists .number-of-recipients { display: inline; }
            </style>
        </apex:define>
        <apex:define name="pageContent">
            <!-- Start of Page Content -->
            <apex:form >
                <apex:actionFunction name="updateRecipientCount" action="{!doNothing}" reRender="">
                    <apex:param name="firstParam" assignTo="{!newFilter.Number_of_Recipients__c}" value="" />
                </apex:actionFunction>
            </apex:form>
            <script type="text/javascript">
            var newFilterJSON = '';
            function getNewFilterCount() {
                vfIECEBC_CampaignRecipient.getNewFilterCnt(newFilterJSON,  function(results, event){
                    jQuery('.newFilterCount').text(results);
                    jQuery('.recipientCountContainer').show();
                    updateRecipientCount(results);
                });
            }
            function displayConfirmationStep2() {
                vfIECEBC_CampaignRecipient.getNewFilterCnt(newFilterJSON,  function(results, event){
                    displayConfirmationStep3(results);
                });
            }
            
            function refreshExistingListCount(filterId) { 
                jQuery('.existingListRecipientCount,.existingListProvisionalCost,.existingListNewBalance').html('<img src="/img/loading.gif" />');
                
                jQuery('input', document.getElementById('{!$Component.existingListForm}')).attr('disabled', 'disabled');
                jQuery('.button').addClass('disabled');
                
                vfIECEBC_CampaignRecipient.getExistingFilterCnt(filterId,  function(results, event){
                    if (event.statusCode != 200) results = 0; 
                    
                    jQuery('.existingListRecipientCount').text((results).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
                    jQuery('.existingListProvisionalCost').text((results * {!productRatePlan.EBC_Currency_Cost_Per_Email__c}).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,'));
                    newBalance = {!billingAccount.eBroadcast_Email_Balance__c} - results;
                    if (newBalance<0) newBalance=0;
                    jQuery('.existingListNewBalance').text((newBalance.toString()).replace(/\B(?=(\d{3})+(?!\d))/g, ","));
                    
                    jQuery('.no-provisional-cost').removeClass('no-provisional-cost');
                    
                	jQuery('input', document.getElementById('{!$Component.existingListForm}')).removeAttr('disabled');
                	jQuery('.button').removeClass('disabled');
                });
            }
            </script>
            <apex:outputPanel id="newFilterJSON">
                <script type="text/javascript">
                newFilterJSON = '{!newFilterEscapedJSON}';
                </script>
            </apex:outputPanel>
            
            <main class="main-content no-provisional-cost">
                <div class="inner-wrapper">
                    <c:IECEBC_ProgressComponent currentStepNumber="{!currentStepNumber}" campaign="{!EBC_Campaign__c}" />
                    <h1 class="page-title">Select the list you want to use</h1>
                    
                    <apex:pageMessages />

                    <apex:form id="existingListForm" >
                        <apex:inputHidden value="{!campaign.EBC_Master_Filter__c}" id="selectedFilter" />
                        
                        <script type="text/javascript">
                        function updateSelectedTemplate(filterId) {
                            document.getElementById('{!$Component.selectedFilter}').value = filterId;
                            refreshExistingListCount(filterId);
                        }
                        </script>
                        
                        <div class="row">
                            <div class="main-container columns small-12 large-7">
                                <ul id="existingLists" class="list list-radio-select js-radio-list js-form-continue-validation" data-target-button="#js-continue-to-template">
                                    <apex:repeat value="{!masterFilters}" var="f">
                                        <li class="{!IF(f.Disabled, ' disabled', '')}{!IF(campaign.EBC_Master_Filter__c == f.Value, ' is-selected', '')}">
                                            <div class="radio-box">
                                                <div class="custom-user-input radio">
                                                    <apex:outputText rendered="{!campaign.EBC_Master_Filter__c == f.Value}">
                                                        <apex:outputText rendered="{!NOT(f.Disabled)}">
	                                                        <input class="user-input radio" name="filter" type="radio" id="item{!f.Value}" value="{!f.Value}" onchange="updateSelectedTemplate('{!f.Value}');" checked="checked" />
                                                        </apex:outputText>
                                                        <apex:outputText rendered="{!f.Disabled}">
	                                                        <input class="user-input radio" name="filter" type="radio" id="item{!f.Value}" value="{!f.Value}" onchange="updateSelectedTemplate('{!f.Value}');" checked="checked" disabled="disabled" readonly="readonly" />
                                                        </apex:outputText>
                                                    </apex:outputText>
                                                    <apex:outputText rendered="{!NOT(campaign.EBC_Master_Filter__c == f.Value)}">
                                                        
                                                        <apex:outputText rendered="{!NOT(f.Disabled)}">
	                                                        <input class="user-input radio" name="filter" type="radio" id="item{!f.Value}" value="{!f.Value}" onchange="updateSelectedTemplate('{!f.Value}');" />
                                                        </apex:outputText>
                                                        <apex:outputText rendered="{!f.Disabled}">
	                                                        <input class="user-input radio" name="filter" type="radio" id="item{!f.Value}" value="{!f.Value}" onchange="updateSelectedTemplate('{!f.Value}');" disabled="disabled" readonly="readonly" />
                                                        </apex:outputText>
                                                    </apex:outputText>
                                                    <label class="custom-radio" for="item{!f.Value}"><i class="icon"></i></label>
                                                </div>
                                                <label class="input-label" for="item{!f.Value}">
                                                    {!f.Label}
                                                </label>
                                            </div>
                                        </li>
                                    </apex:repeat>
                                </ul>
                                
								<apex:outputPanel layout="block" styleClass="list-actions" rendered="{!campaign.Status__c == 'DRAFT'}">
                                    <apex:commandLink styleClass="icon-link" rerender="modal">
                                        <i class="icon fa fa-list-ul" aria-hidden="true"></i>Create a new list
                                        <apex:param assignTo="{!newListStepNumber}" name="firstParam" value="1" />
                                    </apex:commandLink>
                                </apex:outputPanel>
                            </div>
                            
                            <div class="sub-container columns small-12 large-5">
                                <div class="summary-box">
                                    <div class="box-body fit">
                                        <table class="data-table zibra cost">
                                            <caption>Campaign Cost</caption>
                                            <tbody>
                                                <tr class="hide-no-count">
                                                    <th>
                                                        <div class="item-name">Recipients selected</div>
                                                    </th>
                                                    <td>
                                                        <div class="item-value">
                                                            <strong class="existingListRecipientCount">n/a</strong>
                                                            <span class="unit"> emails</span>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr> 
                                                    <th>
                                                        <div class="item-name">Available balance</div>
                                                    </th>
                                                    <td>
                                                        <div class="item-value text-green">
                                                            <strong><apex:outputText value="{0, number, ###,###,##0}"><apex:param value="{!billingAccount.eBroadcast_Email_Balance__c}"/></apex:outputText></strong>
                                                            <span class="unit"> emails</span>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr class="hide-no-count">
                                                    <th>
                                                        <div class="item-name">Provisional cost</div>
                                                    </th>
                                                    <td>
                                                        <div class="item-value">
                                                            <strong class="text-orange">USD $<span class="existingListProvisionalCost">n/a</span></strong>
                                                            <p>for <span class="existingListRecipientCount">n/a</span> emails at $<apex:outputText value="{0, number, ###,###,##0.00}"><apex:param value="{!productRatePlan.EBC_Currency_Cost_Per_Email__c}"/></apex:outputText> cost/email</p>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr class="hide-no-count">
                                                    <th>
                                                        <div class="item-name">Your new account balance will be</div> 
                                                    </th>
                                                    <td>
                                                        <div class="item-value">
                                                            <strong class="existingListNewBalance">n/a</strong>
                                                            <span class="unit"> email(s)</span>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="footer-actions text-right">
                            <ul class="list actions">
                                <apex:outputText rendered="{!campaign.Is_Step2_Writable__c}">
	                                <li><apex:commandLink action="{!previous}" styleClass="button secondary" value="Previous" /></li>
                                </apex:outputText>
                                <apex:outputText rendered="{!campaign.Is_Step2_Writable__c}">
	                                <li><apex:commandLink action="{!saveAndExit}" reRender="pageMessagesBlock" styleClass="button secondary" value="Save and Return to Dashboard" /></li>
                                </apex:outputText>
                                <apex:outputText rendered="{!campaign.Is_Step2_Writable__c}">
	                                <li><apex:commandLink action="{!saveAndContinue}" reRender="pageMessagesBlock" styleClass="button" value="Continue" /></li>
                                </apex:outputText>
                                <apex:outputText rendered="{!NOT(campaign.Is_Step2_Writable__c)}">
	                                <li><apex:commandLink action="{!previous}" value="Previous" styleClass="button secondary" /></li>
                                </apex:outputText>
                                <apex:outputText rendered="{!NOT(campaign.Is_Step2_Writable__c)}">
	                                <li><apex:commandLink action="{!next}" value="Next" styleClass="button" /></li>
                                </apex:outputText>
                            </ul>
                        </div>
                    </apex:form>
                </div>
            </main>
            
			
            <apex:outputPanel id="modal">
                <apex:pageMessages />
                <script type="text/javascript">
                	newFilterJSON = '{!newFilterEscapedJSON}';
                </script>
            	<apex:outputText rendered="{!newListStepNumber != null}">
                    <div class="modal-container" id="js-modal">
                        <div class="overlay"></div>
                        <div class="modal-dialog" id="js-modal-dialog">
                            <apex:outputText rendered="{!newListStepNumber == 1}">
                                <apex:form id="js-modal-create-audience-wrapper">
                                <section id="js-modal-new-list-audience" class="modal-content wide">
                                        <header class="modal-header">
                                            <h2 class="modal-title">Create a new list</h2>
                                                                                     
                                            <a href="#" id="js-modal" class="icon-close js-close-modal"><i class="fa fa-times"></i></a>
                                            <script>
                                            $j = jQuery.noConflict();
                                                            
                                            $j('#js-modal').on('click', '.js-close-modal', function(event) {
                                                event.preventDefault();
                                                 $j('#js-modal').addClass(className.hidden);
                                                 body.attr('data-is-modal-open', 'false');
                                                 $j('.js-champaign-actions').val('default');
                                            });
                                            </script> 
                                        </header>
                                        
                                        <div class="modal-body">
                                            
                                            <div class="process">
                                                <ol class="list steps">
                                                    <li class="step step-1 {!IF(newListStepNumber == 1, ' active', '')}">
                                                        <apex:commandLink rendered="{!NOT(newListStepNumber <= 1)}" action="{!doNothing}" reRender="modal" value="Audience">
                                                            <apex:param assignTo="{!newListStepNumber}" name="firstParam" value="1" />
                                                        </apex:commandLink>
                                                        <apex:outputText rendered="{!newListStepNumber <= 1}">
                                                            <a href="javascript:void(0);">Audience</a>
                                                        </apex:outputText>
                                                    </li>
                                                    <apex:outputText rendered="{!newFilter.Audience__c != 'Custom'}">
                                                        <li class="step step-2 {!IF(newListStepNumber == 2, ' active', '')} {!IF(newListStepNumber < 2, ' disabled', '')}">
                                                            <apex:commandLink rendered="{!NOT(newListStepNumber <= 2)}" action="{!doNothing}" reRender="modal" value="Geo Selection">
                                                                <apex:param assignTo="{!newListStepNumber}" name="firstParam" value="2" />
                                                            </apex:commandLink>
                                                            <apex:outputText rendered="{!newListStepNumber <= 2}">
                                                                <a href="javascript:void(0);">Geo Selection</a>
                                                            </apex:outputText>
                                                        </li>
                                                    </apex:outputText>
                                                    <apex:outputText rendered="{!newFilter.Audience__c != 'Custom'}">
                                                        <li class="step step-3 {!IF(newListStepNumber == 3, ' active', '')} {!IF(newListStepNumber < 3, ' disabled', '')}">
                                                            <apex:commandLink rendered="{!NOT(newListStepNumber <= 3)}" action="{!doNothing}" reRender="modal" value="Refinement" immediate="true" html-formnovalidate="formnovalidate" >
                                                                <apex:param assignTo="{!newListStepNumber}" name="firstParam" value="3" />
                                                            </apex:commandLink>
                                                            <apex:outputText rendered="{!newListStepNumber <= 3}">
                                                                <a href="javascript:void(0);">Refinement</a>
                                                            </apex:outputText>
                                                        </li>
                                                    </apex:outputText>
                                                    <li class="step step-{!IF(newFilter.Audience__c != 'Custom', '4', '2')} {!IF(newListStepNumber == 4, ' active', '')} {!IF(newListStepNumber < 4, ' disabled', '')}">
                                                        <a href="javascript:void(0);">Confirmation</a>
                                                    </li>
                                                </ol>
                                            </div>
                                            <h3 class="step-title">Audience</h3>
                                            <p>Please select lorem dolor sit amet nulla vel sodales mauris. Maecenas ante magna, henderite at mollis quis.</p>
                                            
                                            <apex:actionFunction action="{!doNothing}" name="updateAudience" rerender="modal">
                                                <apex:param assignTo="{!newFilter.Audience__c}" name="firstParam" value="" />
                                            </apex:actionFunction>
                                            
                                            <ul class="list list-radio-select js-radio-list js-form-continue-validation" data-target-button="#js-continue-to-geo-selection" id="js-radio-list-audience">
                                                <apex:variable var="isOptionDisabled" value="{!campaign.EBC_Master_Filter__c != null && campaign.EBC_Master_Filter__r != '' && campaign.EBC_Master_Filter__r.Audience__c != 'Agency'}" />
                                                <li class="{!IF(isOptionDisabled, ' disabled', '')}">
                                                    <div class="radio-box">
                                                        <div class="custom-user-input radio">
                                                            <apex:outputText rendered="{!NOT(isOptionDisabled)}">
                                                                <apex:outputText rendered="{!newFilter.Audience__c == 'Agency'}">
                                                                    <input class="user-input radio" onchange="updateAudience(this.value);" type="radio" name="audience" id="new-list-1" value="Agency" checked="checked" />
                                                                </apex:outputText>
                                                                <apex:outputText rendered="{!newFilter.Audience__c != 'Agency'}">
                                                                    <input class="user-input radio" onchange="updateAudience(this.value);" type="radio" name="audience" id="new-list-1" value="Agency" />
                                                                </apex:outputText>
                                                            </apex:outputText>
                                                            <apex:outputText rendered="{!isOptionDisabled}">
                                                                <input disabled="disabled" readonly="readonly" class="user-input radio" type="radio" name="audience" id="new-list-1" value="Agency" />
                                                            </apex:outputText>
                                                            <label class="custom-radio" for="new-list-1"><i class="icon"></i></label>
                                                        </div>
                                                        <label class="input-label" for="new-list-1">IATA Travel Agencies</label>
                                                    </div>
                                                </li>
                                                <apex:variable var="isOptionDisabled" value="{!campaign.EBC_Master_Filter__c != null && campaign.EBC_Master_Filter__r != '' && campaign.EBC_Master_Filter__r.Audience__c != 'Agent'}" />
                                                <li class="{!IF(isOptionDisabled, ' disabled', '')}">
                                                    <div class="radio-box">
                                                        <div class="custom-user-input radio">
                                                            <apex:outputText rendered="{!NOT(isOptionDisabled)}">
                                                                <apex:outputText rendered="{!newFilter.Audience__c == 'Agent'}">
                                                                    <input class="user-input radio" onchange="updateAudience(this.value);" type="radio" name="audience" id="Agent" value="Agent" checked="checked" />
                                                                </apex:outputText>
                                                                <apex:outputText rendered="{!newFilter.Audience__c != 'Agent'}">
                                                                    <input class="user-input radio" onchange="updateAudience(this.value);" type="radio" name="audience" id="Agent" value="Agent" />
                                                                </apex:outputText>
                                                            </apex:outputText>
                                                            <apex:outputText rendered="{!isOptionDisabled}">
                                                                <input disabled="disabled" readonly="readonly" class="user-input radio" type="radio" name="audience" id="Agent" value="Agent" />
                                                            </apex:outputText>
                                                            
                                                            <label class="custom-radio" for="Agent"><i class="icon"></i></label>
                                                        </div>
                                                        <label class="input-label" for="Agent">IATA/IATAN ID Cardholders</label>
                                                    </div>
                                                </li>
                                                <apex:variable var="isOptionDisabled" value="{!campaign.EBC_Master_Filter__c != null && campaign.EBC_Master_Filter__r != '' && campaign.EBC_Master_Filter__r.Audience__c != 'Custom'}" />
                                                <li class="{!IF(isOptionDisabled, ' disabled', '')}">
                                                    <div class="radio-box">
                                                        <div class="custom-user-input radio">
                                                            <apex:outputText rendered="{!NOT(isOptionDisabled)}">
                                                                <apex:outputText rendered="{!newFilter.Audience__c == 'Custom'}">
                                                                	<input class="user-input radio" onchange="updateAudience(this.value);" type="radio" name="audience" id="new-list-3" value="Custom" checked="checked" />
                                                                </apex:outputText>
                                                                <apex:outputText rendered="{!newFilter.Audience__c != 'Custom'}">
                                                                	<input class="user-input radio" onchange="updateAudience(this.value);" type="radio" name="audience" id="new-list-3" value="Custom" />
                                                                </apex:outputText>
                                                            </apex:outputText>
                                                            <apex:outputText rendered="{!isOptionDisabled}">
                                                                <input disabled="disabled" readonly="readonly" class="user-input radio" type="radio" name="audience" id="new-list-3" value="Custom" />
                                                            </apex:outputText>
                                                            
                                                            <label class="custom-radio" for="new-list-3"><i class="icon"></i></label>
                                                        </div>
                                                        <label class="input-label" for="new-list-3">Provide a list of IATA Numeric Codes</label>
                                                    </div>
                                                    <apex:outputPanel rendered="{!newFilter.Audience__c == 'Custom'}">
                                                        <div class="field-group textarea">
                                                            <label>
                                                                <span class="input-label">Paste your list of IATA numeric codes in the box below:</span>
                                                                <apex:inputField value="{!newFilter.IATA_Codes__c}" styleClass="user-input textarea" />
                                                            </label>
                                                            <p class="input-description">Each IATA code needs to be entered seperated by a semicolon with a max of <strong>5,000 codes</strong>.</p>
                                                        </div>
                                                    </apex:outputPanel>
                                                </li>
                                            </ul>
                                            <apex:outputText rendered="{!NOT(newFilterFieldsValidity['Audience__c'])}">
                                                <div class="errorMsg"><strong>Error:</strong> You must enter a value</div>
                                            </apex:outputText> 
                                            
                                        </div>
                                        <apex:actionFunction action="{!doNothing}" name="storeAudience" rerender="modal">
                                            <apex:param assignTo="{!newFilter.Audience__c}" name="firstParam" value="" />
                                        </apex:actionFunction>
                                        <footer class="modal-footer">
                                            <div class="footer-actions text-right">
                                                <ul class="list actions">
                                                    <li>
                                                        <apex:outputText rendered="{!ISBLANK(newFilter.Audience__c)}">
                                                            <a href="javascript:void(0);" class="button disabled" data-default-state="disabled">Continue</a> 
                                                        </apex:outputText>
                                                        <apex:commandLink rendered="{!NOT(ISBLANK(newFilter.Audience__c))}" onclick="jQuery('body').css('cursor', 'wait');" action="{!validateNewFilter}" styleClass="button" value="Continue" rerender="modal" oncomplete="jQuery('body').css('cursor', 'auto');">
                                                            <apex:param assignTo="{!newListStepNumber}" name="firstParam" value="{!IF(newFilter.Audience__c != 'Custom', 2, 4)}" />
                                                        </apex:commandLink>
                                                    </li>
                                                </ul>
                                            </div>
                                        </footer>
                                </section>
                                </apex:form>
                            </apex:outputText>
                            <apex:outputText rendered="{!newListStepNumber == 2}">
                                <section id="js-modal-new-list-geo-selection" class="modal-content wide">
                                    
                                    <apex:form >
                                        <script type="text/javascript">
                                        function saveGeoStateAndRefreshCount() {
                                            jQuery('.newFilterCount').html('<img src="/img/loading.gif" />');
                                            saveGeoStateAndRefreshCountAF();
                                        }
                                        </script>
                                        <apex:actionFunction name="saveGeoStateAndRefreshCountAF" reRender="newFilterJSON" action="{!doNothing}" oncomplete="getNewFilterCount();" />
                                        
                                        <header class="modal-header">
                                            <h2 class="modal-title">Create a new list</h2>
                                            <a href="#" class="icon-close js-close-modal js-clear-form"><i class="fa fa-times"></i></a>
                                        </header>
                                        
                                        <div class="modal-body">
                                            
                                            
                                            <div class="process">
                                                <ol class="list steps">
                                                    <li class="step step-1 {!IF(newListStepNumber == 1, ' active', '')}">
                                                        <apex:commandLink rendered="{!NOT(newListStepNumber <= 1)}" action="{!doNothing}" reRender="modal" value="Audience">
                                                            <apex:param assignTo="{!newListStepNumber}" name="firstParam" value="1" />
                                                        </apex:commandLink>
                                                        <apex:outputText rendered="{!newListStepNumber <= 1}">
                                                            <a href="javascript:void(0);">Audience</a>
                                                        </apex:outputText>
                                                    </li>
                                                    <apex:outputText rendered="{!newFilter.Audience__c != 'Custom'}">
                                                        <li class="step step-2 {!IF(newListStepNumber == 2, ' active', '')} {!IF(newListStepNumber < 2, ' disabled', '')}">
                                                            <apex:commandLink rendered="{!NOT(newListStepNumber <= 2)}" action="{!doNothing}" reRender="modal" value="Geo Selection">
                                                                <apex:param assignTo="{!newListStepNumber}" name="firstParam" value="2" />
                                                            </apex:commandLink>
                                                            <apex:outputText rendered="{!newListStepNumber <= 2}">
                                                                <a href="javascript:void(0);">Geo Selection</a>
                                                            </apex:outputText>
                                                        </li>
                                                    </apex:outputText>
                                                    <apex:outputText rendered="{!newFilter.Audience__c != 'Custom'}">
                                                        <li class="step step-3 {!IF(newListStepNumber == 3, ' active', '')} {!IF(newListStepNumber < 3, ' disabled', '')}">
                                                            <apex:commandLink rendered="{!NOT(newListStepNumber <= 3)}" action="{!doNothing}" reRender="modal" value="Refinement" immediate="true" html-formnovalidate="formnovalidate">
                                                                <apex:param assignTo="{!newListStepNumber}" name="firstParam" value="3" />
                                                            </apex:commandLink>
                                                            <apex:outputText rendered="{!newListStepNumber <= 3}">
                                                                <a href="javascript:void(0);">Refinement</a>
                                                            </apex:outputText>
                                                        </li>
                                                    </apex:outputText>
                                                    <li class="step step-{!IF(newFilter.Audience__c != 'Custom', '4', '2')} {!IF(newListStepNumber == 4, ' active', '')} {!IF(newListStepNumber < 4, ' disabled', '')}">
                                                        <a href="javascript:void(0);">Confirmation</a>
                                                    </li>
                                                </ol>
                                            </div>
                                            <h3 class="step-title">Geo-Selection</h3>
                                            <p>For your convenience, we have ready-made Geo-Selections. Select one of the following or create your own Geo-Selection.</p>
                                            
                                            
                                            <apex:actionFunction action="{!doNothing}" name="updateGeoFilterPreset" rerender="modal">
                                                <apex:param assignTo="{!geoFilterPreset}" name="firstParam" value="" />
                                            </apex:actionFunction>
                                            <ul class="list list-radio-select js-radio-list js-form-continue-validation" id="js-radio-list-geo-selection" data-target-button="#js-continue-to-refinement">
                                                <apex:repeat value="{!geoFilterPresets}" var="globalGeoFilterId">
                                                    <li>
                                                        <div class="radio-box">
                                                            <div class="custom-user-input radio">
                                                                <apex:outputText rendered="{!globalGeoFilterId == geoFilterPreset}">
	                                                                <input onchange="updateGeoFilterPreset(this.value);" checked="checked" value="{!globalGeoFilterId}" class="user-input radio" type="radio" name="geo-filtering" id="{!globalGeoFilterId}" />
                                                                </apex:outputText>
                                                                <apex:outputText rendered="{!globalGeoFilterId != geoFilterPreset}">
                                                                	<input onchange="updateGeoFilterPreset(this.value);" value="{!globalGeoFilterId}" class="user-input radio" type="radio" name="geo-filtering" id="{!globalGeoFilterId}" />
                                                                </apex:outputText>
                                                                <label class="custom-radio" for="{!globalGeoFilterId}"><i class="icon"></i></label>
                                                            </div>
                                                            <label class="input-label" for="{!globalGeoFilterId}">
                                                                {!geoFilterPresets[globalGeoFilterId].Name}
                                                                <span class="number-of-recipients">(90,000 recipients)</span>
                                                            </label>
                                                        </div>
                                                    </li>
                                                </apex:repeat>
                                                <li>
                                                    <div class="radio-box">
                                                        <div class="custom-user-input radio">
                                                            <apex:outputText rendered="{!geoFilterPreset == 'custom-filter'}">
                                                            	<input onchange="updateGeoFilterPreset(this.value);" checked="checked" class="user-input radio" type="radio" name="geo-filtering" value="custom-filter" id="custom-filter" />
                                                            </apex:outputText>
                                                            <apex:outputText rendered="{!geoFilterPreset != 'custom-filter'}">
                                                            	<input onchange="updateGeoFilterPreset(this.value);" class="user-input radio" type="radio" name="geo-filtering" value="custom-filter" id="custom-filter" />
                                                            </apex:outputText>
                                                            <label class="custom-radio" for="custom-filter"><i class="icon"></i></label>
                                                        </div>
                                                        <label class="input-label" for="custom-filter">Custom Geo-Selection</label>
                                                    </div>
                                                    <div id="custom-filter-block" style="{!IF(geoFilterPreset == 'custom-filter', '', 'display: none;')}">
                                                        <div class="group-container custom-geo-selection">
                                                            <div class="field-group recipents-match select default">
                                                                Recipents match
                                                                <div class="custom-user-input select">
                                                                    <i class="icon angle-down"></i>
                                                        			<apex:inputField value="{!newFilter.Geo_Condition__c}" styleClass="user-input select" required="true" />
                                                                </div>
                                                                of the following Geo-Selections:
                                                            </div>
                                                            
                                                            <apex:outputPanel id="geoFilters">
                                                                <script type="text/javascript">
                                                                newFilterJSON = '{!newFilterEscapedJSON}';
                                                                </script>
                                                                <apex:actionFunction name="refreshGeoFilter" action="{!doNothing}" rerender="geoFilters" />
                                                                <apex:variable value="-1" var="ind" />
                                                                <apex:repeat value="{!geoFilters}" var="f">
                                                                    <apex:variable var="ind" value="{!TEXT(VALUE(ind) + 1)}" />
                                                                    <apex:outputPanel layout="block" styleClass="field-group select default">
                                                                        <div class="custom-user-input select">
                                                                            <i class="icon angle-down"></i>
                                                                            <apex:selectList onchange="refreshGeoFilter();" value="{!f.EBC_Application_Filter__c}" styleClass="user-input select" size="1">
                                                                                <apex:selectOption itemLabel="Please Select" itemValue="" />
                                                                                <apex:selectOptions value="{!availableGeoApplicationFilterOptions}" />
                                                                            </apex:selectList> 
                                                                        </div>
                                                                        <apex:outputText rendered="{!f.EBC_Application_Filter__c != null}">
                                                                            <apex:variable var="dataType" value="{!allAvailableApplicationFilters[f.EBC_Application_Filter__c].Data_Type__c}" />
                                                                            <div class="custom-user-input select">
                                                                                <i class="icon angle-down"></i>
                                                                                <apex:selectList rendered="{!dataType == 'Text'}" value="{!f.Field_Operator__c}" styleClass="user-input select" size="1">
                                                                                    <apex:selectOption itemValue="=" itemLabel="Is" />
                                                                                    <apex:selectOption itemValue="!=" itemLabel="Is Not" />
                                                                                </apex:selectList>
                                                                                <apex:selectList rendered="{!dataType == 'Picklist'}" value="{!f.Field_Operator__c}" styleClass="user-input select" size="1">
                                                                                    <apex:selectOption itemValue="=" itemLabel="Is" />
                                                                                    <apex:selectOption itemValue="!=" itemLabel="Is Not" />
                                                                                </apex:selectList>
                                                                            </div>
                                                                            <apex:inputText rendered="{!dataType == 'Text'}" value="{!f.Field_Value__c}" styleClass="user-input text" />
                                                                            
                                                                            <apex:outputPanel layout="block" styleClass="custom-user-input select" rendered="{!dataType == 'Picklist' && f.EBC_Application_Filter__c != null}">
                                                                                <i class="icon angle-down"></i>	
                                                                                <apex:selectList value="{!f.Field_Value__c}" styleClass="user-input select" size="1">
                                                                                    <apex:selectOptions value="{!allAvailableApplicationFilterValues[f.EBC_Application_Filter__c]}" />
                                                                                </apex:selectList>
                                                                            </apex:outputPanel>
                                                                            
                                                                            <apex:commandLink styleClass="action-link" action="{!removeGeoFilter}" rerender="geoFilters">
                                                                                <i class="icon fa fa-minus-circle" aria-hidden="true"></i>Remove
                                                                                <apex:param name="firstParam" assignTo="{!geoFilterIndex}" value="{!ind}" />
                                                                            </apex:commandLink>
                                                                        </apex:outputText>
                                                                    </apex:outputPanel>
                                                                </apex:repeat>
                                                            </apex:outputPanel>
                                                            
                                                            <div class="action add-field">
                                                                <a class="js-add-field" onclick="addGeoFilter(); return false;">
                                                                    <i class="icon fa fa-plus-circle" aria-hidden="true"></i>Add
                                                                </a> 
                                                            </div>
                                                            
                                                            <apex:actionFunction name="addGeoFilter" oncomplete="jQuery('body').css('cursor', 'auto');" action="{!addGeoFilter}" rerender="geoFilters" />
                                                            <div class="action refresh-count">
                                                                <span class="recipientCountContainer" style="display: none"><strong><span class="newFilterCount">n/a</span> recipients</strong> in this segment.</span>
                                                                <a href="javascript:void(0);" styleClass="button secondary" onclick="saveGeoStateAndRefreshCount();"><i class="icon fa fa-refresh" aria-hidden="true"></i> Refresh count</a>
                                                                <div class="recipientCountContainer" style="display: none"><strong>Note:</strong> The number of recipients is based on any Geo &amp; Refinement filters you may have set.</div>
                                                            </div>
                                                            
                                                        </div>
                                                    </div>
                                                </li>
                                            </ul>
                                        </div>
                                        <footer class="modal-footer">
                                            <div class="footer-actions text-right">
                                                <ul class="list actions">
                                                    <li>
                                                        <apex:outputText rendered="{!ISBLANK(geoFilterPreset)}">
                                                            <a href="javascript:void(0);" class="button disabled" data-default-state="disabled">Continue</a> 
                                                        </apex:outputText>
                                                        <apex:commandLink rendered="{!NOT(ISBLANK(geoFilterPreset))}" onclick="jQuery('body').css('cursor', 'wait');" action="{!validateNewFilter}" styleClass="button" value="Continue" rerender="modal" oncomplete="jQuery('body').css('cursor', 'auto');">
                                                            <apex:param assignTo="{!newListStepNumber}" name="firstParam" value="3" />
                                                        </apex:commandLink>
                                                    </li>
                                                </ul>
                                            </div>
                                        </footer>
                                    </apex:form>
                                </section>
                            </apex:outputText>
                            <apex:outputText rendered="{!newListStepNumber == 3}">
                                <section id="js-modal-new-list-refinement" class="modal-content wide">
                                    <apex:form >
                                        <script type="text/javascript">
                                        function saveRefinementStateAndRefreshCount() {
                                            jQuery('.newFilterCount').html('<img src="/img/loading.gif" />');
                                            saveRefinementStateAndRefreshCountAF();
                                        }
                                        </script>
                                        <apex:actionFunction name="saveRefinementStateAndRefreshCountAF" reRender="newFilterJSON" action="{!doNothing}" oncomplete="getNewFilterCount();" />
                                        <apex:actionFunction name="displayConfirmation" reRender="newFilterJSON" action="{!doNothing}" oncomplete="displayConfirmationStep2();" />
                                        
                                        <apex:actionFunction name="addRefinementFilter" oncomplete="jQuery('body').css('cursor', 'auto');" action="{!addRefinementFilter}" rerender="refinementFiltersx" />
                                        
                                        <header class="modal-header">
                                            <h2 class="modal-title">Create a new list</h2>
                                            <a href="#" class="icon-close js-close-modal js-clear-form"><i class="fa fa-times"></i></a>
                                        </header>
                                        
                                        <div class="modal-body">
                                            
                                            
                                            <div class="process">
                                                <ol class="list steps">
                                                    <li class="step step-1 {!IF(newListStepNumber == 1, ' active', '')}">
                                                        <apex:commandLink rendered="{!NOT(newListStepNumber <= 1)}" action="{!doNothing}" reRender="modal" value="Audience">
                                                            <apex:param assignTo="{!newListStepNumber}" name="firstParam" value="1" />
                                                        </apex:commandLink>
                                                        <apex:outputText rendered="{!newListStepNumber <= 1}">
                                                            <a href="javascript:void(0);">Audience</a>
                                                        </apex:outputText>
                                                    </li>
                                                    <apex:outputText rendered="{!newFilter.Audience__c != 'Custom'}">
                                                        <li class="step step-2 {!IF(newListStepNumber == 2, ' active', '')} {!IF(newListStepNumber < 2, ' disabled', '')}">
                                                            <apex:commandLink rendered="{!NOT(newListStepNumber <= 2)}" action="{!doNothing}" reRender="modal" value="Geo Selection">
                                                                <apex:param assignTo="{!newListStepNumber}" name="firstParam" value="2" />
                                                            </apex:commandLink>
                                                            <apex:outputText rendered="{!newListStepNumber <= 2}">
                                                                <a href="javascript:void(0);">Geo Selection</a>
                                                            </apex:outputText>
                                                        </li>
                                                    </apex:outputText>
                                                    <apex:outputText rendered="{!newFilter.Audience__c != 'Custom'}">
                                                        <li class="step step-3 {!IF(newListStepNumber == 3, ' active', '')} {!IF(newListStepNumber < 3, ' disabled', '')}">
                                                            <apex:commandLink rendered="{!NOT(newListStepNumber <= 3)}" action="{!doNothing}" reRender="modal" value="Refinement">
                                                                <apex:param assignTo="{!newListStepNumber}" name="firstParam" value="3" />
                                                            </apex:commandLink>
                                                            <apex:outputText rendered="{!newListStepNumber <= 3}">
                                                                <a href="javascript:void(0);">Refinement</a>
                                                            </apex:outputText>
                                                        </li>
                                                    </apex:outputText>
                                                    <li class="step step-{!IF(newFilter.Audience__c != 'Custom', '4', '2')} {!IF(newListStepNumber == 4, ' active', '')} {!IF(newListStepNumber < 4, ' disabled', '')}">
                                                        <a href="javascript:void(0);">Confirmation</a>
                                                    </li>
                                                </ol>
                                            </div>
                                            <h3 class="step-title">Refinement</h3>
                                            
                                            <div class="group-container custom-geo-selection">
                                                <div class="field-group recipents-match select default">
                                                    Recipents match
                                                    <div class="custom-user-input select">
                                                        <i class="icon angle-down"></i>
                                                        <apex:inputField value="{!newFilter.Refinement_Condition__c}" styleClass="user-input select" required="true" />
                                                    </div>
                                                    of the following filters:
                                                </div>
                                                
                                                <apex:outputPanel id="refinementFilters">
                                                    <script type="text/javascript">
                                                    newFilterJSON = '{!newFilterEscapedJSON}';
                                                    </script>
                                                    <apex:actionFunction name="refreshFilter" action="{!doNothing}" rerender="refinementFilters" />
                                                    <apex:actionFunction name="refreshFilterReset" action="{!resetFilter}" rerender="refinementFilters">
                                                        <apex:param assignTo="{!resetFilterIndex}" name="firstParam" value="" />
                                                    </apex:actionFunction>
                                                    <apex:variable value="-1" var="ind" />
                                                    <apex:repeat value="{!refinementFilters}" var="f">
                                                        <apex:variable var="ind" value="{!TEXT(VALUE(ind) + 1)}" />
                                                        <apex:outputPanel layout="block" styleClass="field-group select default">
                                                            <div class="custom-user-input select">
                                                                <i class="icon angle-down"></i>
                                                                <apex:selectList onchange="refreshFilterReset({!ind});" value="{!f.EBC_Application_Filter__c}" styleClass="user-input select" size="1">
                                                                    <apex:selectOption itemLabel="Please Select" itemValue="" />
                                                                    <apex:selectOptions value="{!availableRefinementApplicationFilterOptions}" />
                                                                </apex:selectList> 
                                                            </div>
                                                            <apex:outputText rendered="{!f.EBC_Application_Filter__c != null}">
                                                                <apex:variable var="dataType" value="{!allAvailableApplicationFilters[f.EBC_Application_Filter__c].Data_Type__c}" />
                                                                <div class="custom-user-input select">
                                                                    <i class="icon angle-down"></i>
                                                                    <apex:selectList rendered="{!dataType == 'Text'}" value="{!f.Field_Operator__c}" styleClass="filter{!ind}dependant user-input select" size="1">
                                                                        <apex:selectOption itemValue="=" itemLabel="Is" />
                                                                        <apex:selectOption itemValue="!=" itemLabel="Is Not" />
                                                                    </apex:selectList>
                                                                    <apex:selectList rendered="{!dataType == 'Picklist'}" value="{!f.Field_Operator__c}" styleClass="filter{!ind}dependant user-input select" size="1">
                                                                        <apex:selectOption itemValue="=" itemLabel="Is" />
                                                                        <apex:selectOption itemValue="!=" itemLabel="Is Not" />
                                                                    </apex:selectList>
                                                                    <apex:selectList rendered="{!dataType == 'Date'}" value="{!f.Field_Operator__c}" styleClass="filter{!ind}dependant user-input select" size="1">
                                                                        <apex:selectOption itemValue="=" itemLabel="Is" />
                                                                        <apex:selectOption itemValue="!=" itemLabel="Is Not" />
                                                                        <apex:selectOption itemValue="<" itemLabel="Before" />
                                                                        <apex:selectOption itemValue="<=" itemLabel="Before or Equals" />
                                                                        <apex:selectOption itemValue=">" itemLabel="After" />
                                                                        <apex:selectOption itemValue=">=" itemLabel="Equals or After" />
                                                                    </apex:selectList>
                                                                    <apex:selectList rendered="{!dataType == 'Checkbox'}" value="{!f.Field_Operator__c}" styleClass="filter{!ind}dependant user-input select" size="1">
                                                                        <apex:selectOption itemValue="= true" itemLabel="Is True" />
                                                                        <apex:selectOption itemValue="= false" itemLabel="Is False" />
                                                                    </apex:selectList>
                                                                </div>
                                                                <apex:inputText rendered="{!dataType == 'Text'}" value="{!f.Field_Value__c}" styleClass="filter{!ind}dependant user-input text" />
                                                                <apex:inputField rendered="{!dataType == 'Date'}" value="{!f.Field_Value__c}" styleClass="filter{!ind}dependant user-input text" />
                                                                
                                                                <apex:outputPanel layout="block" styleClass="custom-user-input select" rendered="{!dataType == 'Picklist' && f.EBC_Application_Filter__c != null}">
                                                                    <i class="icon angle-down"></i>	
                                                                    <apex:selectList value="{!f.Field_Value__c}" styleClass="filter{!ind}dependant user-input select" size="1">
                                                                        <apex:selectOptions value="{!allAvailableApplicationFilterValues[f.EBC_Application_Filter__c]}" />
                                                                    </apex:selectList>
                                                                </apex:outputPanel>
                                                                
                                                                 
                                                                <apex:commandLink styleClass="action-link" action="{!removeRefinementFilter}" rerender="refinementFilters">
                                                                    <i class="icon fa fa-minus-circle" aria-hidden="true"></i>Remove
                                                                    <apex:param name="firstParam" assignTo="{!refinementFilterIndex}" value="{!ind}" />
                                                                </apex:commandLink>
                                                            </apex:outputText>
                                                        </apex:outputPanel>
                                                    </apex:repeat>
                                                </apex:outputPanel>
                                                
                                                <div class="action add-field">
                                                    <a class="js-add-field" onclick="addRefinementFilter(); return false;">
                                                        <i class="icon fa fa-plus-circle" aria-hidden="true"></i>Add
                                                    </a> 
                                                </div>
                                                
                                                <apex:actionFunction name="addRefinementFilter" oncomplete="jQuery('body').css('cursor', 'auto');" action="{!addRefinementFilter}" rerender="refinementFilters" />
                                                
                                                
                                                <div class="action refresh-count">
                                                    <span class="recipientCountContainer" style="display: none">
                                                        <strong><span class="newFilterCount">n/a</span> recipients</strong> in this segment.
                                                    </span>
                                                    <a href="javascript:void(0);" styleClass="button secondary" onclick="saveRefinementStateAndRefreshCount();"><i class="icon fa fa-refresh" aria-hidden="true"></i> Calculate recipients count</a>
                                                    <div style="display: none" class="recipientCountContainer"><strong>Note:</strong> The number of recipients is based on any Geo &amp; Refinement filters you may have set.</div>
                                                </div>
                                            </div>
                                        </div>
                                        <footer class="modal-footer">
                                            <div class="footer-actions text-right">
                                                <ul>
                                                    <li>
                                                        <apex:actionFunction name="displayConfirmationStep3" action="{!validateNewFilter}" rerender="modal" oncomplete="jQuery('body').css('cursor', 'auto');">
                                                            <apex:param assignTo="{!newFilter.Number_of_Recipients__c}" name="firstParam" value="" />
                                                            <apex:param assignTo="{!newListStepNumber}" name="secondParam" value="4" />
                                                        </apex:actionFunction>
                                                        <a href="#" onclick="jQuery('body').css('cursor', 'wait'); displayConfirmation(); return false;" class="button">Continue</a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </footer>
                                    </apex:form>
                                </section>
                            </apex:outputText>
                            <apex:outputText rendered="{!newListStepNumber == 4}">
                                <section id="js-modal-new-list-confirmation" class="modal-content wide">
                                    
                                    <apex:form >
                                        <apex:outputPanel id="confirmationBlock">
                                            
                                            <header class="modal-header">
                                                <h2 class="modal-title">Create a new list</h2>
                                                <a href="#" class="icon-close js-close-modal js-clear-form"><i class="fa fa-times"></i></a>
                                            </header>
                                            
                                            <div class="modal-body">
                                                
                                                
                                                <div class="process">
                                                <ol class="list steps">
                                                    <li class="step step-1 {!IF(newListStepNumber == 1, ' active', '')}">
                                                        <apex:commandLink rendered="{!NOT(newListStepNumber <= 1)}" action="{!doNothing}" reRender="modal" value="Audience">
                                                            <apex:param assignTo="{!newListStepNumber}" name="firstParam" value="1" />
                                                        </apex:commandLink>
                                                        <apex:outputText rendered="{!newListStepNumber <= 1}">
                                                            <a href="javascript:void(0);">Audience</a>
                                                        </apex:outputText>
                                                    </li>
                                                    <apex:outputText rendered="{!newFilter.Audience__c != 'Custom'}">
                                                        <li class="step step-2 {!IF(newListStepNumber == 2, ' active', '')} {!IF(newListStepNumber < 2, ' disabled', '')}">
                                                            <apex:commandLink rendered="{!NOT(newListStepNumber <= 2)}" action="{!doNothing}" reRender="modal" value="Geo Selection">
                                                                <apex:param assignTo="{!newListStepNumber}" name="firstParam" value="2" />
                                                            </apex:commandLink>
                                                            <apex:outputText rendered="{!newListStepNumber <= 2}">
                                                                <a href="javascript:void(0);">Geo Selection</a>
                                                            </apex:outputText>
                                                        </li>
                                                    </apex:outputText>
                                                    <apex:outputText rendered="{!newFilter.Audience__c != 'Custom'}">
                                                        <li class="step step-3 {!IF(newListStepNumber == 3, ' active', '')} {!IF(newListStepNumber < 3, ' disabled', '')}">
                                                            <apex:commandLink rendered="{!NOT(newListStepNumber <= 3)}" action="{!doNothing}" reRender="modal" value="Refinement">
                                                                <apex:param assignTo="{!newListStepNumber}" name="firstParam" value="3" />
                                                            </apex:commandLink>
                                                            <apex:outputText rendered="{!newListStepNumber <= 3}">
                                                                <a href="javascript:void(0);">Refinement</a>
                                                            </apex:outputText>
                                                        </li>
                                                    </apex:outputText>
                                                    <li class="step step-{!IF(newFilter.Audience__c != 'Custom', '4', '2')} {!IF(newListStepNumber == 4, ' active', '')} {!IF(newListStepNumber < 4, ' disabled', '')}">
                                                        <a href="javascript:void(0);">Confirmation</a>
                                                    </li>
                                                </ol>
                                                </div>
                                                <h3 class="step-title">Confirmation</h3>
                                                
                                                <div class="row">
                                                    <div class="main-container columns small-12 large-5">
                                                        <table class="data-table new-campaign">
                                                            <tr>
                                                                <th>Audience:</th>
                                                                <td>
                                                                    IATA Travel Agencies
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <th>Geo Selection:</th>
                                                                <td>
                                                                    <apex:outputText rendered="{!geoFilterPreset == 'custom-filter'}">
                                                                    	<span class="label">Custom</span>
                                                                    </apex:outputText>
                                                                    <apex:outputText rendered="{!geoFilterPreset != 'custom-filter'}">
                                                                    	<span class="label">{!geoFilterPresets[geoFilterPreset].Name}</span>
                                                                    </apex:outputText>
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <th>Refinement:</th>
                                                                <td>
                                                                    {!uniqueRefinementFiltersName}
                                                                </td>
                                                            </tr>
                                                        </table>
                                                        <apex:outputPanel id="newFilterNameField" layout="block" styleClass="field-group text list-name">
                                                            <label>
                                                                <span class="input-label">Please provide a list name</span>
                                                                <apex:inputField type="text" styleClass="user-input text js-remaining-characters" value="{!newFilter.Name}" html-data-target-element=".js-remaining-count" html-data-target-id="list-name" html-data-max-length="{!$ObjectType.EBC_Master_Filter__c.fields.Name.length}" />
                                                            </label>
                                                            <div class="input-remaining">
                                                                <span class="js-remaining-count" data-id="list-name">{!$ObjectType.EBC_Master_Filter__c.fields.Name.length}</span>
                                                            </div>
                                                            
                                                            <apex:outputText rendered="{!newFilter.Id != null}">
                                                                <script type="text/javascript">
                                                                window.location.href = 'https://{!$Site.Domain}{!URLFOR($Page.IECEBC_CampaignTemplate)}?id={!campaign.id}';
                                                                </script>
                                                            </apex:outputText>
                                                        </apex:outputPanel>
                                                    </div>
                                                    <div class="sub-container columns small-10 large-7">
                                                        <div class="summary-box">
                                                            <div class="box-body fit">
                                                                <table class="data-table zibra cost"> 
                                                                    <caption>Campaign Cost</caption>
                                                                    <tr>
                                                                        <th>
                                                                            <div class="item-name">Recipients selected</div>
                                                                        </th>
                                                                        <td>
                                                                            <div class="item-value">
                                                                                <strong><span class="newFilterCount"><apex:outputText value="{0, number, ###,###,##0}"><apex:param value="{!newFilter.Number_of_Recipients__c}"/></apex:outputText></span></strong>
                                                                                <span class="unit"> emails</span>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    <tr> 
                                                                        <th>
                                                                            <div class="item-name">Available balance</div>
                                                                        </th>
                                                                        <td>
                                                                            <div class="item-value text-green">
                                                                                <strong><apex:outputText value="{0, number, ###,###,##0}"><apex:param value="{!billingAccount.eBroadcast_Email_Balance__c}"/></apex:outputText></strong>
                                                                                <span class="unit"> emails</span>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>
                                                                            <div class="item-name">Provisional cost</div>
                                                                        </th>
                                                                        <td>
                                                                            <div class="item-value">
                                                                                <strong class="text-orange">USD $<apex:outputText value="{0, number, ###,###,##0.00}"><apex:param value="{!productRatePlan.EBC_Currency_Cost_Per_Email__c * newFilter.Number_of_Recipients__c}"/></apex:outputText></strong>
                                                                                <p>for <apex:outputText value="{0, number, ###,###,##0}"><apex:param value="{!newFilter.Number_of_Recipients__c}"/></apex:outputText> emails at $<apex:outputText value="{0, number, ###,###,##0.00}"><apex:param value="{!productRatePlan.EBC_Currency_Cost_Per_Email__c}"/></apex:outputText> cost/email</p>
                                                                            </div>
                                                                        </td> 
                                                                    </tr>
                                                                    <tr>
                                                                        <th>
                                                                            <div class="item-name">Your new account balance will be</div> 
                                                                        </th>
                                                                        <td>
                                                                            <div class="item-value">
                                                                                <strong><apex:outputText value="{0, number, ###,###,##0}"><apex:param value="{!IF(billingAccount.eBroadcast_Email_Balance__c - newFilter.Number_of_Recipients__c<0,0,billingAccount.eBroadcast_Email_Balance__c - newFilter.Number_of_Recipients__c)}"/></apex:outputText></strong>
                                                                                <span class="unit"> email(s)</span>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <footer class="modal-footer">
                                                <div class="footer-actions text-right">
                                                    <ul class="list actions">
                                                        <li>
                                                            <apex:commandLink onclick="jQuery('body').css('cursor', 'wait');" action="{!createNewFilterAndUse}" styleClass="button wide" value="Save and use in campaign" oncomplete="jQuery('body').css('cursor', 'auto');" rerender="newFilterNameField" /> 
                                                        </li>
                                                    </ul>
                                                </div>
                                            </footer>
                                        </apex:outputPanel>
                                    </apex:form>
                                </section>
                            </apex:outputText>
                            <apex:outputText rendered="{!newListStepNumber == 5}">
                                <section id="js-modal-confirmation" class="modal-content">
                                    
                                    <apex:form >
                                        <header class="modal-header">
                                            <h2 class="modal-title">Confirmation</h2>
                                            <a href="#" class="icon-close js-close-modal"><i class="fa fa-times"></i></a>
                                        </header>
                                        <div class="modal-body">
                                            <h3 class="title">Check against account balance</h3>
                                            <p><strong>15,000</strong> emails will be sent against your 50,000 emails account balance.</p>
                                        </div>
                                        <footer class="modal-footer">
                                            <ul class="list actions">
                                                <li>
                                                    <button class="text-link js-close-modal">Cancel</button>
                                                </li>
                                                <li>
                                                    <a class="button wide" href="?page=template">Continue to template</a>
                                                </li>
                                            </ul>
                                        </footer>
                                    </apex:form>
                                </section>
                            </apex:outputText>
                        </div>
                    </div>   
                </apex:outputText>
            </apex:outputPanel> 
            
            <apex:outputText rendered="{!campaign.EBC_Master_Filter__c != null}">
                <script>
                jQuery(document).ready(function(){
                	refreshExistingListCount('{!campaign.EBC_Master_Filter__c}');
                });
                </script>
            </apex:outputText>
            <!-- End of Page Content -->
        </apex:define>
    </apex:composition>
</apex:page>