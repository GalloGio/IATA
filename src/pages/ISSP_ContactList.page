<apex:page controller="ISSP_ContactList" tabStyle="Contact" action="{!initialization}"  standardStylesheets="false" showHeader="false" sidebar="false"  applyBodyTag="false" applyHtmlTag="false" >
 <html>
 <c:ISSP_Header  communityName="{!communityName}" ></c:ISSP_Header>
 <body>
    <apex:includeScript value="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" />
    <apex:includeScript value="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js" />
    
    <script src="{!URLFOR($Resource.DataTablesBootstrap)}"></script>
    <script src="{!URLFOR($Resource.JqueryDataTables)}"></script>  
    <script src="{!URLFOR($Resource.JqueryDataTablesAlphabetSearch)}"></script>

    <link type="text/css" rel="stylesheet" href="{!URLFOR($Resource.DataTablesBootstrapCSS,'dataTables.bootstrap.min.css')}" />

    <style type="text/css">
      div.alphabet {
        clear:both;
        position:relative;
        margin:0.5em 0;
      }

      @media screen and (max-width:640px){
        div.alphabet {
          text-align:center;
        }
      }

      div.alphabet ul {
        display:inline-block;
        margin:0;
        padding:0;
        list-style:none;
      }

      div.alphabet li {
        display:inline-block;
      }

      div.alphabet a {
        display:inline-block;
        cursor:pointer;
        text-align:center;
        text-decoration:none;
        box-sizing:content-box;
        padding:0.2em 0.1em;
        min-width:1.3em;
        color:#333 !important;
        border:1px solid transparent;
        border-radius:2px;
      }

      div.alphabet a:hover {
        color:#FFF !important;
        border:1px solid #111;
        background-color:#585858;
        background:linear-gradient(to bottom, #585858 0%, #111 100%);
      }

      div.alphabet a:active {
        outline:none;
        background-color:#2b2b2b;
        background:linear-gradient(to bottom, #2b2b2b 0%, #0c0c0c 100%);
        box-shadow:inset 0 0 3px #111;
      } 

      div.alphabet a.empty {
        color:#888 !important;
      }

      div.alphabet a.active,
      div.alphabet a.active.empty {
        color:#333 !important;
        border:1px solid #979797;
        background-color:#FFF;
        background:linear-gradient(to bottom, #fff 0%, #dcdcdc 100%)
      }

      div.alphabet .alphabet-info-display {
        margin-right:0.5em;
      }

      div.alphabet div.alphabet-info {
        position:absolute;
        border:1px solid #111;
        background-color:#585858;
        background:linear-gradient(to bottom, #585858 0%, #111 100%);
        border-radius:2px;
        color:#FFF;
        margin-top:0.2em;
        padding:0.2em 0.4em;
        text-align:center;
        opacity:0;
        z-index:9999;
      }

      tr.alphabet-group, tr.alphabet-group:hover {
        background-color:rgba(0,0,0,0.15) !important;
      }      
    </style>

    <div class="container">
     <c:ISSP_CustomNavigation communityName="{!communityName}" />

    <script>

    // When document is ready
    $(document).ready(function() {
        onready();
    });

    function onready() {
        // Color invalid domain in red
        $(".domainpartred").each(function(){
            var inner = $(this).html();
            var innserSplited = inner.split('@');
            var domainColorSpan = '<span class="colorred">'.concat('@').concat(innserSplited[1]).concat('</span>');
            $(this).html(innserSplited[0]).append(domainColorSpan);
            $('.colorred').css("color", "red");
        });

        // Color valid domain in green
        $(".domainpartgreen").each(function(){
            var inner = $(this).html();
            var innserSplited = inner.split('@');
            var domainColorSpan = '<span class="colorgreen">'.concat('@').concat(innserSplited[1]).concat('</span>');
            $(this).html(innserSplited[0]).append(domainColorSpan);
            $('.colorgreen').css("color", "green");
        });

        // Create Jquery tooltip only for the invalid email domain validation (cross)
        $(".emadomvalinvpopup").tooltip();
    }

    function selectAllCheckboxes(obj,receivedInputID){
        var inputCheckBox = document.getElementsByTagName("input");
        for(var i=0; i<inputCheckBox.length; i++){
            if(inputCheckBox[i].id.indexOf(receivedInputID)!=-1){
                inputCheckBox[i].checked = obj.checked;
            }
        }
    }

    function showIdModal(){
      $('#idCardModal').modal('show');
    }

    function closeIdModal(){
      $('#idCardModal').modal('hide');
    }

    function showReasonModal(){
      $('#inactiveReason').modal('show');
    }

    function closeModal(){
      $('#inactiveReason').modal('hide');
    }

    function showRejectReasonModal(){
      $('#rejectionReason').modal('show');
    }

    function closeRejectModal(){
      $('#rejectionReason').modal('hide');
    }
    </script>


    <style type="text/css">
    a.alpha-link {
       font-weight: normal;
       font-size: 91%;
       padding: 0 4px;
       color: #015BA7 !important;
    }

    a.alpha-link+a.alpha-link {
       border-left: 1px solid #CFCECE;
    }

    a.alpha-link:hover {
       background-color: #e0f5fc !important;
    }

    a.alpha-select {
       font-weight: bold;
       text-decoration: none;
       background-color: #C6E1FF;
       color: #000000 !important;
    }

    /* Jquery tootip style customization */
    .tooltip {font-size:13px;}
    </style>

    <apex:form id="contactListForm">

<!--
    <apex:actionFunction name="next" action="{!setCon.next}" rerender="Contacts" />
    <apex:actionFunction name="previous" action="{!setCon.previous}" rerender="Contacts" />
    <apex:actionFunction name="first" action="{!setCon.first}" rerender="Contacts" />
    <apex:actionFunction name="last" action="{!setCon.last}" rerender="Contacts" />
    <apex:actionFunction name="refresh" action="{!refresh}" rerender="contactListForm" />
  -->
    <apex:inputHidden value="{!selectedList}" id="selectedItemHidden"/>
    <!-- <apex:pageMessages /> -->
    <h4>{!$Label.ISSP_Company_Administration} <span class="glyphicon glyphicon-chevron-right small " aria-hidden="true"></span>
        {!$Label.ISSP_Contacts}<br />
         <small>{!$Label.ISSP_PageDescription_ISSP_ContactList}</small></h4>

    <img src="/s.gif" alt="Contact" class="pageTitleIcon" title="Contact"/>
<div class="row">
<div class="col-md-4 col-sm-6 col-xs-12">
    <select id="testSelect" class="form-control selector" onchange="$('[id$=selectedItemHidden]').val($(this).val());refresh();">
        <apex:repeat value="{!ListViewNameList}" var="csName" id="theRepea1">
            <option value="{!csName}">{!$Label[contactListViewMap[csName].Label_API_name__c]}</option>
        </apex:repeat>
    </select>
    </div>
    <div class="{!if(isAdmin,"col-md-3 pull-right","")}">
          <apex:commandButton onClick="navigateToUrl('/apex/ISSP_PortalUserCreation?retUrl=%2Fapex%2FISSP_ContactList&mid=M4S1{!if(communityName=='CNS','&CommunityName='+communityName,'')}','LIST_VIEW','newContact');return false;" value="{!$Label.ISSP_Contact_OneStepCreate}" rendered="{!isAdmin}" StyleClass="btn_iata_primary btn btn-block"/>
           </div>
     </div>
    <script>
        $('#testSelect').val( '{!selectedList}' );
    </script>

    <apex:outputPanel id="theRepeat" >
    <div class="alert alert-danger" style="display:{!if(errorMessage.size == 0,'none','')}">
        <strong>{!$Label.ISSP_Error}</strong>
        <apex:repeat value="{!errorMessage}" var="er" >
            <p><apex:outputText value="{!er}" escape="false" /></p>
        </apex:repeat>
    </div>
    </apex:outputPanel>

    <apex:outputPanel id="theSecondModal" >
    <apex:outputPanel rendered="{!contactsWithIdCard}" >
    <script>showIdModal();</script>
    <!-- Id Card users being inactivated -->
    <div class="modal fade" id="idCardModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">{!$Label.ISSP_InactiveUser_Important}</h4>
          </div>
          <div class="modal-body">
            <apex:outputText value="{!contactsWithIdCardString}" escape="false" />
          </div>
          <div class="modal-footer">
            <apex:commandButton action="{!inactivate}" onclick="closeIdModal();" value="{!$Label.ISSP_Confirm}" rerender="Contacts, theRepeat" StyleClass="btn btn-default"/>
            <apex:commandButton action="{!resetIdCard}" value="{!$Label.ISSP_Cancel}" onclick="closeIdModal();" rerender="Contacts, theRepeat" StyleClass="btn btn-primary"/>
          </div>
        </div>
      </div>
     </div>
  </apex:outputPanel>
  </apex:outputPanel>

    <apex:pageBlock id="Contacts" >
      <!--  <apex:pageBlockButtons location="top"> -->
      <script>onready();</script>
      <br />
      <div class="row">
          <div class="{!if(!isAdmin,"col-md-3","")}">
            <apex:commandButton onClick="navigateToUrl('/003/e?retURL=%2FISSP_ContactList','LIST_VIEW','newContact');return false;" value="{!$Label.ISSP_NewContact}" rendered="{!!isAdmin}" StyleClass="btn_iata_primary btn btn-block "/>
          </div>

          <div class="{!if(AND(isAdmin, buttonReject),"col-md-3","")}">
          <apex:commandButton value="{!$Label.ISSP_Reject}" rendered="{!AND(isAdmin, buttonReject)}" rerender="theRepeat" onclick="showRejectReasonModal();" StyleClass="btn_iata_primary btn btn-block" />
           </div>
          <div class="{!if(AND(isAdmin, buttonInactivate),"col-md-3","")}">
          <!-- <apex:commandButton action="{!inactivate}" value="{!$Label.ISSP_Inactivate}" rendered="{!AND(isAdmin, buttonInactivate)}" rerender="Contacts, theRepeat" onclick="if(!confirm('{!$Label.ISSP_ConfirmInactivate}')){return};" StyleClass="btn_iata_primary btn btn-block "/> -->
          <apex:commandButton value="{!$Label.ISSP_Inactivate}" rendered="{!AND(isAdmin, buttonInactivate)}" rerender="theRepeat" onclick="showReasonModal();" StyleClass="btn_iata_primary btn btn-block "/>
           </div>
          <div class="{!if(AND(isAdmin, buttonActivate),"col-md-3","")}">
            <apex:commandButton action="{!activateContact}" value="{!$Label.ISSP_Activate}" rendered="{!AND(isAdmin, buttonActivate)}" rerender="Contacts, theRepeat" onclick="if(!confirm('{!$Label.ISSP_ConfirmApprove}')){return};" StyleClass="btn_iata_primary btn btn-block" />
           </div>
          <div class="{!if(AND(isAdmin, buttonAdmin),"col-md-3","")}">
            <apex:commandButton action="{!makeAdmin}" value="{!$Label.ISSP_MakeAdmin}" rendered="{!AND(isAdmin, buttonAdmin)}" rerender="Contacts, theRepeat" onclick="if(!confirm('{!$Label.ISSP_MakeAdmin}')){return};" StyleClass="btn_iata_primary btn btn-block"/>
           </div>
          <div class="{!if(AND(isAdmin, buttonChange),"col-md-3","")}">
            <apex:commandButton action="{!changeUserPortalStatus}" value="{!$Label.ISSP_ChangeUserPortalStatus}" rendered="{!AND(isAdmin, buttonChange)}" rerender="Contacts, theRepeat" StyleClass="btn_iata_primary btn btn-block"/>
          </div>
      </div>
      <!-- buttons to export data -->
      <div class="row text-right">
        <span style="margin: 15px">
            <apex:outputLink styleclass="btn btn_iata_primary btn-xs hidden" value="/ISSP_ContactListPDF?selectedList={!selectedList}" target="_blank">
                <span class="glyphicon glyphicon-th" aria-hidden="true"></span>
                {!$Label.ISSP_Download_in_PDF}
            </apex:outputlink>
            <apex:outputLink styleclass="btn btn_iata_primary btn-xs" value="/ISSP_ContactListCSV?selectedList={!selectedList}">
                <span class="glyphicon glyphicon-th" aria-hidden="true"></span>
                {!$Label.ISSP_Download_in_CSV}
            </apex:outputlink>
        </span>
      </div>

    <div>
      <table id="pbt_contacts2" class="table table-striped compact" cellspacing="0">
        <thead>
          <tr>
            <th class="tableFormat" style="color: #428bca; font-size: 12px;">
              <apex:inputCheckBox id="selectAll" onclick="selectAllCheckboxes(this,'inputId')" />
            </th>
            <th class="tableFormat" style="color: #428bca; font-size: 12px;">{!$Label.ISSP_My_Contact_Action}&nbsp;</th>

            <apex:repeat value="{!fields}" var="f">
              <th class="tableFormat" style="color: #428bca; font-size: 12px;">{!f.label}&nbsp;</th>
            </apex:repeat>

            <apex:outputpanel rendered="{!isAdmin}">
              <th class="tableFormat" style="color: #428bca; font-size: 12px;">{!$ObjectType.User.fields.LastLoginDate.label}&nbsp;</th>
            </apex:outputpanel>
            
          </tr>

        </thead>
        <tbody>
          <apex:repeat value="{!contactList}" var="auxList">
            <apex:repeat value="{!auxList}" var="item">
              <tr>
                <td style="font-size: 13px;">
                  <apex:inputCheckBox value="{!item.selected}" id="inputId" />
                </td>
                <td style="font-size: 13px;">
                  <apex:outputLink value="/ISSP_Contact?Id={!item.recordContact.Id}&action=edit{!if(communityName=='CNS','&CommunityName='+communityName,'')}" target="_self">{!$Label.ISSP_Edit}</apex:outputLink>
                </td>

                <apex:repeat value="{!fields}" var="f">              
                  <td style="font-size: 13px;">
                    <apex:outputpanel rendered="{! IF(f.FieldPath=='Email', true, false) }">
                        <apex:outputpanel rendered="{! IF(item.recordContact.ValidContactDomainName__c == 'valid', true, false) }">
                            <apex:image url="{! $Resource.IntelliMail__check }" width="16" height="16" />
                        </apex:outputpanel>
                        <apex:outputpanel rendered="{! IF(item.recordContact.ValidContactDomainName__c == 'invalid', true, false) }">
                            <span title="{! $Label.ISSP_ContactList_HoverPopup_Text }" class="emadomvalinvpopup">
                                <apex:image url="{! $Resource.AccountDomainValidation_Invalid }" width="16" height="16" />
                            </span>
                        </apex:outputpanel>
                        <apex:outputText value="&nbsp;" escape="false" />
                     </apex:outputpanel>

                    <apex:outputpanel rendered="{!IF(f.FieldPath != 'ISSP_Contact_Name__c' && f.FieldPath != 'ISSP_Account_Name__c',true,false)}">
                      <apex:outputpanel rendered="{! IF(f.FieldPath!='Email', true, false) }">
                        <apex:outputfield value="{!item.recordContact[f.fieldPath]}" />
                      </apex:outputpanel>
                      <apex:outputpanel rendered="{! IF(f.FieldPath=='Email', true, false) }">
                        <apex:outputpanel rendered="{! IF(item.recordContact.ValidContactDomainName__c == 'valid', true, false) }">
                          <a href="mailto:{! item.recordContact[f.fieldPath] }"><span class="domainpartgreen"><apex:outputText value="{! item.recordContact[f.fieldPath] }" /></span></a>
                        </apex:outputpanel>
                        <apex:outputpanel rendered="{! IF(item.recordContact.ValidContactDomainName__c == 'invalid', true, false) }">
                          <a href="mailto:{! item.recordContact[f.fieldPath] }"><span class="domainpartred"><apex:outputText value="{! item.recordContact[f.fieldPath] }" /></span></a>
                        </apex:outputpanel>
                        <apex:outputpanel rendered="{! IF(item.recordContact.ValidContactDomainName__c == '', true, false) }">
                          <apex:outputField value="{! item.recordContact[f.fieldPath] }" />
                        </apex:outputpanel>
                      </apex:outputpanel>
                    </apex:outputpanel>

                    <apex:outputpanel rendered="{!IF(f.FieldPath=='ISSP_Contact_Name__c',true,false)}">
                      <apex:outputLink value="/apex/ISSP_Contact?Id={!item.recordContact.Id}&mid=M4S1{!if(communityName=='CNS','&CommunityName='+communityName,'')}" target="_self">{!item.recordContact.name}</apex:outputLink>
                    </apex:outputpanel>

                    <apex:outputpanel rendered="{!IF(f.FieldPath=='ISSP_Account_Name__c',true,false)}">
                      <apex:outputLink value="/apex/ISSP_Account?Id={!item.recordContact.Accountid}&mid=M4S1{!if(communityName=='CNS','&CommunityName='+communityName,'')}" target="_self">{!item.recordContact.Account.Name}</apex:outputLink> 
                    </apex:outputpanel>
                  </td>
                </apex:repeat>

                <apex:outputpanel rendered="{!isAdmin}">
                  <td style="font-size: 13px;"><apex:outputField value="{!item.user.LastLoginDate}" rendered="{!item.user!=null}"/></td>
                </apex:outputpanel>
              </tr>
            </apex:repeat>
          </apex:repeat>
        </tbody>
      </table>
      <script type="text/javascript">      
        $('#pbt_contacts2').dataTable( { 
          "pageLength": 10,
          "lengthMenu": [5, 10, 25, 50 ],
          "searching": true,
          dom: 'Alfrtip',
          alphabetSearch: {
            column: 2
          }
        } );                      
        $("div.alphabet-group").remove();        
      </script>

    </div>

    </apex:pageBlock>

    <!-- Modal ask for inactivation reason -->
    <div class="modal fade" id="inactiveReason">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">{!$Label.ISSP_ReasonInactivation}</h4>
          </div>
          <div class="modal-body">
            <apex:selectList id="reasonList" value="{!contactStatus}" size="1" styleClass="UserStatus form-control"  >
        <apex:selectOptions value="{!inactiveReasonOptions}" />
      </apex:selectList>
          </div>
          <div class="modal-footer">
            <apex:commandButton action="{!checkIdCard}" onclick="closeModal();" value="{!$Label.ISSP_Confirm}" 
              rerender="theSecondModal, theRepeat,Contacts, loadStatusSpinner" 
              status="loadStatusSpinner"
              StyleClass="btn btn-default"/>
            <apex:commandButton value="{!$Label.ISSP_Cancel}" onclick="closeModal();" rerender="Contacts, theRepeat" StyleClass="btn btn-primary"/>
          </div>
        </div>
      </div>
     </div>

     <!-- Modal ask for rejection reason -->
    <div class="modal fade" id="rejectionReason">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">{!$Label.ISSP_ReasonRejection}</h4>
          </div>
          <div class="modal-body">
            <apex:selectList id="reasonRejectList" value="{!contactStatus}" size="1" styleClass="UserStatus form-control"  >
        <apex:selectOptions value="{!rejectionReasonOptions}" />
      </apex:selectList>
          </div>
          <div class="modal-footer">
            <apex:commandButton action="{!reject}" onclick="closeRejectModal();" value="{!$Label.ISSP_Confirm}" rerender="Contacts, theRepeat" StyleClass="btn btn-default"/>
            <apex:commandButton value="{!$Label.ISSP_Cancel}" onclick="closeRejectModal();" rerender="Contacts, theRepeat" StyleClass="btn btn-primary"/>
          </div>
        </div>
      </div>
     </div>

 </apex:form>
  <c:ISSP_CustomFooter communityName="{!communityName}"/>

  <div id="load_scrl" class="loadingBox loader" style="display:none;"> </div>
  <div class="loadingBox overlay"> </div>

  <apex:actionStatus onstart="startLoading();" onstop="endLoading();" id="loadStatusSpinner"/>

  <style>
      .overlay {
          display: none;
          height: 100%;
          left: 0;
          position: fixed;
          top: 0;
          opacity: 0.3;
          -moz-opacity: 0.3;
          width: 100%;
          -ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=30)";
          filter: alpha(opacity=30);
          background: #000;
          -khtml-opacity: 0.3;
          z-index: 1000;
      }
      .loader {
          background: url('/img/loading32.gif') scroll no-repeat 0 0;
          width: 32px;
          height: 32px;
          position: absolute;
          left: 50%;
      }
  </style>

  <script type="text/javascript">
      function startLoading(){
          $('#load_scrl').css('top', $(document).scrollTop() + 200);
          $('.loadingBox').show();
      }
      function endLoading(){
           $('.loadingBox').hide();
      }
  </script> 


</div><!-- end container -->
     </body>
    </html>
</apex:page>