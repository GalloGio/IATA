<apex:page standardController="EBC_Campaign__c" extensions="vfIECEBC_Campaign" applyHtmlTag="false" applyBodyTag="false" sidebar="false" showheader="false" standardStylesheets="false" language="en" docType="html-5.0" action="{!pageLoad}">
	<apex:composition template="IECEBC_Layout">
        <apex:define name="pageHeadAdditions">
            <!-- Start of Page <head> -->
            <title>eBroadcast Campaign - Design</title>
            <style type="text/css">
            	.plugin-container {}
	            	.plugin-container iframe { display: none; }
	            	.plugin-container div#notice {
                		display: block;
                		line-height: 32px;
                	}
	            	.plugin-container div#notice img {margin-right: 20px;}
            	.plugin-container.loaded {}
	            	.plugin-container.loaded iframe { display: block !important; }
	            	.plugin-container.loaded div#notice { display: none !important; }
            </style>
            <!-- End of Page </head> -->
        </apex:define>
        <apex:define name="pageScriptAdditions">
            <!-- If any page specific .js, add them here -->
        </apex:define>
        <apex:define name="pageContent">
            <!-- Start of Page Content -->
            <main class="main-content">
                <div class="inner-wrapper">
                    <apex:outputText rendered="{!campaign.Is_Step4_Writable__c}">
                        <div class="plugin-container">
                            <iframe id="IECEBC_MosaicoEditor" src="/iec/IECEBC_MosaicoEditor?Id={!campaign.EBC_Design__c}" frameborder="false" scrolling="true" width="100%" height="1200"></iframe>
                            <div id="notice">
                                <img src="/img/loading32.gif" align="left" /> Loading Editor. If you have problem to see the editor, please <a href="/iec/IECEBC_MosaicoEditor?Id={!campaign.EBC_Design__c}">click here</a>.
                            </div>
                        </div>
                        <script type="text/javascript">
                        if (window.location.search.indexOf('notice=sendtest_needed') !== -1) {
                            alert('You must execute "Send a Test Email" before continue');
                        }
                        var isCallbackAvailable = false;
                        var viewModel;
                        function onEditorLoaded() {
                            var isLoaded = false;
                            try {
                                if ('function' == typeof(document.getElementById('IECEBC_MosaicoEditor').contentWindow.mosaicoSave.execute)) {
                                    jQuery('.plugin-container').addClass('loaded');
                                    isCallbackAvailable = true;
                                    viewModel = document.getElementById('IECEBC_MosaicoEditor').contentWindow.globalViewModel;
                                }
                            } catch(e) { }
                            
                            if (!isCallbackAvailable) {
                                jQuery('#notice').html('Your browser cannot load the embeded editor. Please open it full screen by following <a href="/iec/IECEBC_MosaicoEditor?Id={!campaign.EBC_Design__c}">click here</a>');
                            }
                        }
                        </script>
                    </apex:outputText>
                    <apex:outputText rendered="{!NOT(campaign.Is_Step4_Writable__c)}">
                        <c:IECEBC_ProgressComponent currentStepNumber="{!currentStepNumber}" campaign="{!EBC_Campaign__c}" />
                        
                        <h1 class="page-title">Design your campaign</h1>
                        
                        <iframe id="IECEBC_CampaignPreview" src="/iec/IECEBC_CampaignPreview?Id={!campaign.EBC_Design__c}" frameborder="false" scrolling="true" width="100%" height="600"></iframe>
                    </apex:outputText>
                    <apex:form >
                        <div class="footer-actions text-right">
                            <ul class="list actions">
                                <apex:outputText rendered="{!campaign.Is_Step4_Writable__c}">
	                                <li><apex:commandLink action="{!previous}" styleClass="button secondary" value="Previous" /></li>
                                </apex:outputText>
                                
                                <apex:outputText rendered="{!campaign.Is_Step4_Writable__c}">
                                    <li><apex:commandLink onclick="if (isCallbackAvailable) { viewModel.save.execute(); } location.href='/iec/iecebc_dashboard'; return false;" styleClass="button secondary" value="Save and Return to Dashboard" /></li>
                                </apex:outputText>
                                
                                <li><apex:commandLink action="{!saveAsTemplate}" onclick="if(isCallbackAvailable) { viewModel.save.execute(true); }" oncomplete="console.log('x'); viewModel.notifier.clear(); viewModel.notifier.success(document.getElementById('IECEBC_MosaicoEditor').contentWindow.globalViewModel.t('Template created successfully.'));" styleClass="button secondary" value="Save As Template" /></li>
                                
                                <apex:outputText rendered="{!campaign.Is_Step4_Writable__c}">
                                    <li><apex:commandLink action="{!next}" onclick="if(isCallbackAvailable) { viewModel.save.execute(); location.href='/iec/IECEBC_CampaignSchedule?id={!campaign.Id}'; return false; }" styleClass="button" value="Continue" /></li>
                                </apex:outputText>
                                
                                <apex:outputText rendered="{!NOT(campaign.Is_Step4_Writable__c)}">
	                                <li><apex:commandLink action="{!previous}" value="Previous" styleClass="button secondary" /></li>
                                </apex:outputText>
                                <apex:outputText rendered="{!NOT(campaign.Is_Step4_Writable__c)}">
	                                <li><apex:commandLink action="{!next}" value="Next" styleClass="button" /></li>
                                </apex:outputText>
                            </ul>
                        </div>
                    </apex:form>
                </div>
            </main>
            <!-- End of Page Content -->
        </apex:define>
    </apex:composition>
</apex:page>