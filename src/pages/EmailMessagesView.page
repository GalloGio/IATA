<apex:page standardController="Case"  extensions="EmailMessagesViewCon" showHeader="false">

    <apex:includeScript value="/support/console/30.0/integration.js"/>
    <apex:includeScript value="/soap/ajax/26.0/connection.js"/>
    <apex:includeScript value="/soap/ajax/26.0/apex.js"/>
    <apex:includeScript value="{!$Resource.jquery2_1_4}"/>

    <script type="text/javascript">

       var caseId = ("{!cse.Id}").substring(0,15);

       function getCountryEmail() {
            sforce.connection.sessionId = "{!$Api.Session_ID}";
            var countryEmail = sforce.apex.execute("IDFS_Util","getRecordTypeEmail",{caseRecordType:"{!cse.RecordType.DeveloperName}", caseBSPCountry:"{!cse.BSPCountry__c}"});
            if (countryEmail == '') {
                countryEmail = sforce.apex.execute("IDFS_Util","getIATACountryEmail",{caseBSPCountry:"{!cse.BSPCountry__c}"});
            }
            return countryEmail;
        }

        function DeleteMethod(id){

            if(confirm("Are you sure you want to delete this email?")){

                sforce.connection.sessionId = "{!$Api.Session_ID}";

                var isEmailDeleted = sforce.apex.execute("IDFS_Util","DeleteEmail",{EmailID:id});

                if(isEmailDeleted == 'true')
                {
                    // TODO: reload page
                    //window.top.location.reload();
                    //window.parent.location.reload();
                    // var temp = window.top.location;
                     window.top.location = ("{!$Label.SF_Base_URL}/" + caseId);
                }
                else
                {
                    alert('Email cannot be deleted at the moment');
                }
            }
        }

        function ToAllMethod(id){

            var countryEmail = getCountryEmail();
            var redirectUrlOne = "{!$Label.SF_Base_URL}/_ui/core/email/author/EmailAuthor?email_id=" + id + "&replyToAll=1&retURL=" + caseId + "&p26=" + countryEmail;
            var redirectUrlTwo = "{!$Label.SF_Base_URL}/_ui/core/email/author/EmailAuthor?email_id=" + id + "&replyToAll=1&retURL=" + caseId;

            if(countryEmail != '')
            {
                //window.top.location = redirectUrlOne;
                if (sforce.console.isInConsole()) {
                    ServiceConsoleIntegration(redirectUrlOne);
                } else {
                    window.top.location= redirectUrlOne;
                } 
            } else {
                if (sforce.console.isInConsole()) {
                    ServiceConsoleIntegration(redirectUrlTwo);
                } else {
                    window.top.location= redirectUrlTwo;

                }
                
            }
        }

        function ReplyMethod(id){

            var countryEmail = getCountryEmail();
            var redirectUrlOne = "{!$Label.SF_Base_URL}/_ui/core/email/author/EmailAuthor?email_id=" + id + "&replyToAll=0&retURL=" + caseId + "&p26=" + countryEmail;
            var redirectUrlTwo = "{!$Label.SF_Base_URL}/_ui/core/email/author/EmailAuthor?email_id=" + id + "&replyToAll=0&retURL=" + caseId;

            if(countryEmail != '')
            {
                //window.top.location = redirectUrlOne;
                if (sforce.console.isInConsole()) {
                    ServiceConsoleIntegration(redirectUrlOne);
                } else {
                    window.top.location= redirectUrlOne;
                } 
            } else {
                if (sforce.console.isInConsole()) {
                    ServiceConsoleIntegration(redirectUrlTwo);
                } else {
                    window.top.location= redirectUrlTwo;

                }
                
            }
        }

        function ServiceConsoleIntegration(redirectUrl)
        {
            if (sforce.console.isInConsole()) {
                sforce.console.getEnclosingTabId(function(enclosingResult){
                    sforce.console.getEnclosingPrimaryTabId(function(primaryResult){
                        sforce.console.openSubtab(primaryResult.id, redirectUrl, true, '', null);
                    });
                });
            } else {
                window.top.location.href = redirectUrl;
            }
        }

        function SendEmail(){

            var countryEmail = getCountryEmail();
            var redirectUrlOne = "{!$Label.SF_Base_URL}/email/author/emailauthor.jsp?retURL=" + caseId + "&p2_lkid={!cse.ContactId}&p3_lkid=" + caseId + "&rtype=003&p26=" + countryEmail;
            var redirectUrlTwo = ("{!$Label.SF_Base_URL}/email/author/emailauthor.jsp?retURL=" + caseId + "&p2_lkid={!cse.ContactId}&p3_lkid=" + caseId + "&rtype=003");

            if(countryEmail != '')
            {
                //window.top.location = redirectUrlOne;
                if (sforce.console.isInConsole()) {
                    ServiceConsoleIntegration(redirectUrlOne);
                } else {
                    window.top.location= redirectUrlOne;
                } 
            } else {
                if (sforce.console.isInConsole()) {
                    ServiceConsoleIntegration(redirectUrlTwo);
                } else {
                    window.top.location= redirectUrlTwo;

                }
                
            }
            
        }
         
        function openSubTab(id) {
            var retUrl= "{!$Label.SF_Base_URL}/" + id;
            if (sforce.console.isInConsole()) {
                    ServiceConsoleIntegration(retUrl);
                } else {
                    window.top.location= retUrl;
        }
        }


        function sendTrackedEmail(){
            window.top.location= ("/apex/sendSingleTrackedEmail?retURL={!cse.Id}&case={!cse.Id}");
        }

    </script>

    <apex:pageMessages />

    <style type="text/css">
    A:link {text-decoration: none; color: #015ba7;}
    A:visited {text-decoration: none}
    A:active {text-decoration: none}
    A:hover {text-decoration: underline; color: #015ba7;}
    </style>
    <apex:form >

        <apex:pageblock id="CustomList"  Title="Emails" helpTitle="Emails Help" helpUrl="https://help.salesforce.com/htviewhelpdoc?id=cases_email.htm&siteLang=en_US">
        <apex:facet name="header">
           <div class="pbHeader">
                <table border="0" cellpadding="0" cellspacing="0">
                    <tbody>
                        <tr>
                            <td class="pbTitle">
                                <img src="{!URLFOR($Resource.icon_home)}" class="relatedListIcon" style="width:24px; display:block; margin-left:0;" />
                                <h3 id="50011000000m9Uv_RelatedEmailMessageList_title">&nbsp;Emails</h3>
                            </td>
                            <td class="pbButton">
                                <input value="Send an Email" class="btn" name="newEmail" onclick="SendEmail();return false;" title="Send an Email" type="button"/>
                                <input value="Send a Tracked Email" class="btn" name="newEmail" onclick="sendTrackedEmail();return false;" title="Send a Tracked Email" type="button"
                                  style="display: {!IF($Permission.Can_send_a_tracked_email && ShowSendTrackedEmailButton,'','none')}"  />
                            </td>
                            <td class="pbHelp">
                                <span class="help" title="Emails Help (New Window)">
                                    <a href="#" onClick="window.open('https://help.salesforce.com/htviewhelpdoc?id=cases_email.htm&siteLang=en_US');" class="linkCol">
                                        <span class="linkSpan">Emails Help</span>
                                        <img src="/s.gif" alt="Emails Help (New Window)" class="helpIcon" title="Emails Help (New Window)"/>
                                    </a>
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </apex:facet>
        <apex:pageBlockButtons location="top" title="Emails">
                <apex:commandButton onclick="SendEmail();return false;" value="Send an email" id="theButton" />
        </apex:pageBlockButtons>
            <div style="height: 200px; overflow-y:auto; display:{!IF(EmailsAvailable==false,'none','block')}">
            <!-- VERSION JFO -->
            <table class="list" cellspacing="0" cellpadding="0" border="0">
                <tbody>
                    <tr class="headerRow">
                    <th class="actionColumn" scope="col">Action</th>
                    <th class=" zen-deemphasize" scope="col">Status</th>
                    <th class=" zen-deemphasize" scope="col" width="50" > </th>
                    <th class=" zen-deemphasize" scope="col">Subject</th>
                    <th class=" zen-deemphasize" scope="col">Email Address</th>
                    <th class=" zen-deemphasize" scope="col">Message Date</th>
                    </tr>
                    <apex:repeat var="message" value="{!emails}">
                        <tr class="dataRow even ">
                            <td class="actionColumn">
                                      <a href ="" onclick="ReplyMethod('{!message.Id}');return false;"  title="Reply" style="color:#015ba7; cursor: pointer;">
                                        <span value="View" class="view">Reply</span>
                                      </a>
                                      <span value="|" class="view"> |</span>
                                       <a href ="" onclick="ToAllMethod('{!message.Id}');return false;" style="color:#015ba7; cursor: pointer;" title="To All">
                                         <apex:outputText value="To All" />
                                       </a>
                                       <span value="|" class="view"> |</span>
                                      <a href ="" onclick="DeleteMethod('{!message.Id}');return false;" style="color:#015ba7; cursor: pointer;" title="Delete">
                                        <apex:outputText value="Del" />
                                      </a>
                            </td>
                            <td class=" dataCell " scope="row">
                                   <apex:outputText value="{!message.Status}" id="numberStatus" />
                                   <script>
                                       var state =document.getElementById("{!$Component.numberStatus}").innerHTML ;
                                       var CleanState;
                                        if(state == '0')
                                         CleanState = 'New';
                                        if(state =='1')
                                         CleanState = 'Read';
                                        if(state =='2')
                                         CleanState = 'Replied';
                                        if(state =='3')
                                         CleanState = 'Sent';
                                        if(state =='4')
                                         CleanState = 'Forwarded';
                                       document.getElementById("{!$Component.numberStatus}").innerHTML =  CleanState;
                                   </script>
                            </td>
                            <td class=" dataCell "  width="50" >
                                <div class="bEmailStatus">
                                    <img width="16" height="13" src="/img/{!IF((message.Incoming ==true),"emailInbound","emailOutbound")}.gif" title="{!IF((message.Incoming ==true),"Inbound","Outbound")}"/>
                                    <img width="16" height="13" src="/img/emailHasAttach.gif" style="display:{!IF((message.HasAttachment ==true),"","none")}"/>
                                </div>
                            </td>
                            <td class=" dataCell ">
                                <a style="font-weight: bold; cursor: pointer;" href="#" onclick="openSubTab('{!message.Id}');">
                                   {!if((message.Subject==null || message.Subject==''),'No Subject',message.Subject)}</a> <br/>
                                    <font style="font-style: italic; font-decoration: none; font-size: 11px;">{!LEFT(message.TextBody,77)}...</font></td>
                            <td class=" dataCell ">
                                {!If((message.Incoming==true),message.FromAddress,message.ToAddress)}
                            </td>
                            <td class=" dataCell "><apex:outputField value="{!message.MessageDate}"/></td>
                        </tr>
                    </apex:repeat>
                    <apex:repeat var="message" value="{!archivedMessages}">
                        <tr class="dataRow even ">
                            <td class="actionColumn">
                                <a class="actionLink actionLink" title="Reply"  target="_parent" href="/_ui/core/email/author/EmailAuthor?email_id={!message.EmailMessage__c}&replyToAll=0&retURL=%2F{!aCaseId}">Reply</a>
                                |
                                <a class="actionLink actionLink" title="To All" target="_parent" href="/_ui/core/email/author/EmailAuthor?email_id={!message.EmailMessage__c}&replyToAll=1&retURL=%2F{!aCaseId}">To All</a>
                            </td>
                            <td class=" dataCell " scope="row">
                                 <apex:outputText value="{!originalEmail[message.EmailMessage__c].Status}" id="numberStatus" />
                                   <script>
                                       var state = document.getElementById("{!$Component.numberStatus}").innerHTML ;
                                       var CleanState;
                                        if(state == '0')
                                         CleanState = 'New';
                                        if(state =='1')
                                         CleanState = 'Read';
                                        if(state =='2')
                                         CleanState = 'Replied';
                                        if(state =='3')
                                         CleanState = 'Sent';
                                        if(state =='4')
                                         CleanState = 'Forwarded';
                                        document.getElementById("{!$Component.numberStatus}").innerHTML =  CleanState + ' [Archived]';
                                   </script>
                            </td>
                            <td class=" dataCell ">
                                <div class="bEmailStatus">
                                    <img width="16" height="13" src="/img/{!IF((originalEmail[message.EmailMessage__c].Incoming ==true),"emailInbound","emailOutbound")}.gif" title="{!IF((originalEmail[message.EmailMessage__c].Incoming ==true),"Inbound","Outbound")}"/>
                                    <img width="16" height="13" src="/img/emailHasAttach.gif"/>
                                </div>
                            </td>
                            <td class=" dataCell ">
                                <a style="font-weight: bold;"  href="/{!message.Id}" target="_parent">
                                    {!if(ISBLANK(originalEmail[message.EmailMessage__c].Subject),'No Subject',originalEmail[message.EmailMessage__c].Subject)}</a> <br/>
                                    <font style="font-style: italic; font-decoration: none; font-size: 11px;">{!LEFT(originalEmail[message.EmailMessage__c].TextBody,77)}...</font></td>
                            <td class=" dataCell ">
                                {!If((originalEmail[message.EmailMessage__c].Incoming==true),originalEmail[message.EmailMessage__c].FromAddress,originalEmail[message.EmailMessage__c].ToAddress)}
                            </td>
                            <td class=" dataCell "><apex:outputField value="{!originalEmail[message.EmailMessage__c].MessageDate}"/></td>
                        </tr>
                    </apex:repeat>
                    <!--TRACKED EMAIL -->
                    <apex:repeat var="trackedEmail" value="{!trackedEmails}">
                        <tr class="dataRow even ">
                            <td class="actionColumn">
                                <a class="actionLink actionLink" title="View"  target="_parent" href="/{!trackedEmail.Id}">View</a>
                            </td>

                            <td class=" dataCell " scope="row">
                                 <apex:outputText value="{!trackedEmail.Status__c} [Tracked]" />
                            </td>
                            <td class=" dataCell ">
                                <div class="bEmailStatus">
                                    <img width="16" height="13" src="/img/emailOutbound.gif" title="Outbound"/>
                                </div>
                            </td>
                            <td class=" dataCell ">
                                <a style="font-weight: bold;"  href="/{!trackedEmail.Id}" target="_parent">
                                    {!if(ISBLANK(trackedEmail.Subject__c),'No Subject',trackedEmail.Subject__c)}</a> <br/>
                                    <font style="font-style: italic; font-decoration: none; font-size: 11px;">{!LEFT(trackedEmail.Html_Body__c,77)}...</font></td>
                            <td class=" dataCell ">
                                <apex:outputField value="{!trackedEmail.ToContact__c}" />
                            </td>
                            <td class=" dataCell "><apex:outputField value="{!trackedEmail.CreatedDate}"/></td>
                        </tr>
                    </apex:repeat> 
                </tbody>
            </table>
            </div>

        <apex:outputLabel value="No Emails available" rendered="{!EmailsAvailable==false}" styleClass="noRowsHeader"></apex:outputLabel>
    </apex:pageblock>
    </apex:form>
</apex:page>