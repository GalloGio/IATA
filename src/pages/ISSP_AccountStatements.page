<apex:page controller="ISSP_Ctrl_AccountStatements"
           cache="false"
           sidebar="false"
           showHeader="false"
           standardStylesheets="false"
           action="{!initActions}"
           id="page">

<c:ISSP_Header ></c:ISSP_Header>
<apex:stylesheet value="{!URLFOR($Resource.ISSP_AccountStatements,'css/style.css')}"/>
<apex:stylesheet value="{!URLFOR($Resource.bootstraptoggle,'css/bootstrap-toggle.min.css')}"/>
<script src="{!URLFOR($Resource.bootstraptoggle,'js/bootstrap-toggle.min.js')}"></script>
<apex:includeScript value="{!$Resource.jquery2_1_4}"/>

    <!--WMO358 Start 2018/11/02-->
    <style>
        /* The Modal (background) */
        .modal {
            position: fixed; 
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgb(0,0,0); 
            background-color: rgba(0,0,0,0.4);
        }

        .showModal {
            display: block; /* Hidden by default */
        }

        .notShowModal {
            display: none; /* Hidden by default */
        }

        /* Modal Content/Box */
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 50%;
            border-radius: 0px;
            /*height: 55%;*/
        }

        /* The Close Button */
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
                color: black;
                text-decoration: none;
                cursor: pointer;
        }

        .imageButton {
            width:20px; 
            height:20px;
        }

        .iataBlue {
            background-color: rgb(0, 66, 124);
        }

        .modalTitle {
            color: white;
            font-weight: bold;
        }

    </style>
    <!--WMO358 End-->

<script>
  $(document).ready( function () {
    collapseAll();

    // init pagination
    $('.table-pagination').dataTable({
      "language": {
              "lengthMenu": "{!$Label.ISSP_Display_Records_per_page}",
              "zeroRecords": "{!$Label.ISSP_Nothing_found}",
              "info": "{!$Label.ISSP_Showing_page}",
              "infoEmpty": "{!$Label.ISSP_No_records_available}",
              "infoFiltered": "{!$Label.ISSP_filtered_from_total_records}",
              "search": "{!$Label.ISSP_Search}",
              "paginate": {
                "next": "{!$Label.ISSP_Next}",
                "previous": "{!$Label.ISSP_Previous}"
              }
          }
    });

    // collpase detail tables
    $('#maintable .accordion-toggle').on('click', function () {
      var dataTarget = $(this).attr('data-target');
      var targetId = dataTarget.replace('#','');
      collapseAll(targetId);
      // set plus and minus signs visibility
      if($(dataTarget).hasClass('in')) {
        $(this).find('.plus-sign').addClass('in');
        $(this).find('.minus-sign').removeClass('in');
      } else {
        $(this).find('.plus-sign').removeClass('in');
        $(this).find('.minus-sign').addClass('in');
      }
    });

    // filter by currency
    $('#currencyFilter').on('change', function () {
      filterCurrency($(this).val());
    });
  });

  function collapseAll(currentId) {
    $(".plus-sign").each(function() {
      $(this).addClass("in");
    });
    $(".minus-sign").each(function() {
      $(this).removeClass("in");
    });
    $(".accordion-body").each(function() {
      if ($(this).attr('id')!=currentId) {
        $(this).removeClass("in");
      }
    });
  }

  function filterCurrency(filter) {
    collapseAll();
    $(".accordion-toggle").each(function() {
      var value = $(this).attr('data-filter');
      if (filter==''||filter==value) {
        $(this).addClass('in');
      } else {
        $(this).removeClass('in');
      }
    });
  }
//WMO 358 Start 2018/11/02

    function startLoading(){

    }

    function refreshList(){
        callrefreshList();
    }

    function attFuntion(objectId, fileName, amazonRecordTypeId, accountStatementPeriod, amazonFileStartName, amazonFileNameIdentifier)
    {
         console.log('start call' + objectId);

         let amazonFileModel = {
            RecordTypeId: amazonRecordTypeId,
            Name: fileName,
            Remittance_Period__c: accountStatementPeriod,
            Category__c: amazonFileStartName,
            File_Identifier_picklist__c: amazonFileNameIdentifier};

        runClickAction(objectId, "{!credentialName}", amazonFileModel, false);
        console.log('after call');

    }

    function onStart(){
        startLoading();
    }

    function onStop(){
        //stopLoading();
    }

    function onAfterUpload(amazonfileid) {
        //alert(amazonfileid);
        //closeModal();
        //stopLoading();
        callrefreshList();
    }




    //WMO 358 End
</script>

    <apex:variable var="currencyTreeValuesList" value="[{!''}{!treePlacesCurrency}" />

    <c:Loading />

    <div class="container">
        <c:ISSP_CustomNavigation />
        <apex:pageMessages />

       <!--WMO358 Start 2018/11/02-->
        <!-- Modal popuo to allow the user to add attachments-->
        <apex:outputPanel id="myModal" >
            <apex:outputPanel rendered="{!showPopUp}">
                <apex:form >
                    <c:UploadFileToAmazonButton />
                    <apex:actionFunction name="callrefreshList" action="{!refreshList}"  rerender="myModal"  status="loading" oncomplete="stopLoading();"/>
                    <apex:actionFunction name="closeModal" action="{!saveAttachment}"  rerender="myModal" />
                    <div class="{!IF(showPopUp==true, 'modal showModal', 'modal notShowModal')}">
                        <div class="{!IF(showPopUp==true, 'modal-content', 'notShowModal modal-content')}" >
                             <div class="modal-header iataBlue">
                                <span class="close" onclick="closeModal(); return false;">&times;</span>
                                <h4 class="modal-title modalTitle">{!$Label.Account} {!accountSelectedName}</h4>
                                <h5 class="modal-title modalTitle">{!$Label.Period} {!accountStatementPeriod}</h5>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="row" >
                                            <apex:pageBlock > <!--rendered="{!listAttachments.empty}"-->
                                                <h4 >{!$Label.Add_an_attachment}</h4>

                                                <apex:variable var="cnt" value="{!0}" />

                                                <button onclick="attFuntion('{!accountSelectedId}','{!amazonFileName}','{!amazonRecordTypeId}','{!accountStatementPeriod}','{!amazonFileStartName}','{!amazonFileNameIdentifier}'); return false;" >{!$Label.Add_attachment_Action}</button>

                                            </apex:pageBlock>
                                        </div>
                                        <br/>
                                        <div class="row">
                                            <apex:pageBlock rendered="{!listAttachments.size>0}">
                                                <div class="table">
                                                    <table id="tableAttachments" class="table table-hover table-condensed">
                                                        <thead>
                                                        <tr>
                                                            <th colspan="3">{!$Label.Documents_POP}</th>
                                                        </tr>
                                                        <tr>
                                                            <th></th>
                                                            <th>{!$Label.File_Name}</th>
                                                            <th>{!$Label.Created_Date}</th>
                                                        </tr>
                                                        </thead>

                                                        <tbody>
                                                        <apex:repeat value="{!listAttachments}" var="attach">
                                                            <tr>
                                                                <td>{!attach.name}</td>
                                                                <td>{!attach.Full_Name_Unique__c}</td>
                                                                <td>{!attach.createdDate}</td>
                                                            </tr>
                                                        </apex:repeat>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </apex:pageBlock>
                                        </div>
                                    </div>
                                </div>
                            </div>
                             <div class="modal-footer">
                                  <div class="row">
                                     <div class="col-md-6">
                                            <apex:commandButton value="{!$Label.Done}" styleclass="btn btn-blue btn-sm" action="{!saveAttachment}" reRender="myModal" status="loading" oncomplete="stopLoading();" rendered="{!listAttachments.size>0}"/>
                                            <apex:commandButton value="{!$Label.Cancel}" styleclass="btn btn-sm" action="{!saveAttachment}" reRender="myModal" status="loading" oncomplete="stopLoading();" rendered="{!listAttachments.empty}"/>
                                     </div>
                                  </div>
                            </div>
                        </div>
                    </div>
                </apex:form>
            </apex:outputPanel>
        </apex:outputPanel>
            <!-- WMO 358 End-->
  <apex:form id="mainForm" styleclass="form-inline">
    <apex:actionFunction name="updateAppRight" action="{!updateAppRight}" rerender="notificationsSwitch"/>

    <div class="alert alert-danger" style="display:{!if(listMessages.size==0,'none','')}">
      <apex:repeat value="{!listMessages}" var="er" id="theRepeat">
        <p><apex:outputText value="{!er}" escape="false" /></p>
      </apex:repeat>
    </div>

    <!-- PAGE BLOCK for Account Statements when Terms And Conditions are accepted -->
    <apex:pageBlock rendered="{!listMessages.size==0}">
        <div class="jumbotron main-title">
          <apex:image value="{!URLFOR($Resource.ISSP_AccountStatements,'img/AccStatementsIcon.png')}" />
          <span>{!$Label.ISSP_Account_Statements_Title}</span>
        </div>
        <div class="undertitle">
          <div class="undertitleLeft">
            <!--<apex:outputLink styleclass="link" value="/faq_home?q=ICE">FAQ</apex:outputLink>-->
            <apex:outputLink styleclass="link" value="{!instance}/sfc/servlet.shepherd/version/download/{!faq.id}" target="_document" rendered="{!faq!=null}">
              FAQ
            </apex:outputLink>
            <!--<apex:outputLink styleclass="link" value="/ISSP_ContentPage">{!$Label.ISSP_Documents}</apex:outputLink>-->
            <apex:outputLink styleclass="link" value="{!instance}/sfc/servlet.shepherd/version/download/{!document.id}" target="_document" rendered="{!document!=null}">
              {!$Label.ISSP_Documents}
            </apex:outputLink>
          </div>
          <div class="undertitleRight">
            <apex:outputText styleclass="label normal" value="{!$Label.ISSP_Agency_Head_Office_code}"/>
            <apex:outputText styleclass="label strong" value="{!headofficeAccount.IATACode__c}"/>
            <apex:outputText styleclass="label normal" value="{!$Label.ISSP_Last_Updated_on}"/>
            <apex:outputText styleclass="label strong" value="{0,date,dd MMM yyyy HH:mm z}">
              <apex:param value="{!lastUpdatedOn}" />
            </apex:outputText>
          </div>
        </div>

			<div class="row">
				<div class="col-xs-12">
          <div styleclass="main-filters">
            <div class="form-group form-group-sm">
              <apex:outputPanel rendered="{!listCurrency.size>1}">
                  <label class="control-label" for="currencyFilter">{!$Label.ISSP_Currency_filter}</label>
                  <select class="form-control" id="currencyFilter">
                    <option></option>
                    <apex:repeat var="currency" value="{!listCurrency}">
                      <option>{!currency}</option>
                    </apex:repeat>
                  </select>
              </apex:outputPanel>
            </div>
            <apex:outputPanel id="notificationsSwitch" layout="block" style="float:right;">
                <script>$('.toggle').bootstrapToggle();</script>
                <label class="control-label">{!$Label.ISSP_Account_Statement_Notifications_Button}&nbsp;</label>
                <apex:inputfield styleclass="toggle" value="{!appRight.Enable_Notifications__c}" html-data-toggle="toggle" html-data-onstyle="blue" html-data-offstyle="default" html-data-size="small" onchange="updateAppRight();"/>
            </apex:outputPanel>
        </div>

          <div class="table">
          <table id="maintable" class="table table-hover table-condensed">
            <thead>
              <tr>
                <th></th>
                <th>{!$ObjectType.Account_Statement__c.fields.Period__c.label}</th>
                <th>{!$ObjectType.Account_Statement__c.fields.Remittance_Date__c.label}</th>
                <th class="text-width">{!$Label.ISSP_Account_Statement_Location}</th>
                <th class="hidden-xs hidden-sm currency-width">{!$ObjectType.Account_Statement__c.fields.Billing_Amount__c.label}</th>
                <th class="hidden-xs hidden-sm currency-width">{!$ObjectType.Account_Statement__c.fields.Billing_Adjustment__c.label}</th>
                <th class="currency-width">{!$ObjectType.Account_Statement__c.fields.Amount_to_be_Paid__c.label}</th>
                <th class="hidden-xs hidden-sm currency-width">{!$ObjectType.Account_Statement__c.fields.Paid__c.label}</th>
                <th class="currency-width">{!$ObjectType.Account_Statement__c.fields.Balance__c.label}</th>
                <th class="hidden-xs"></th>
                <th>{!$ObjectType.Account_Statement__c.fields.Status__c.label}</th>
		<th><!--Payment--></th> <!--WMO358 2018/11/02-->
              </tr>
            </thead>
            <tbody>
						<apex:repeat var="wrapper" value="{!listWrapper}">
              <tr class="{!IF(wrapper.showSeparation,'','hidden')}">
                <td colspan="12" class="separation-row"><div>{!$Label.ISSP_Past_Periods}</div></td>
              </tr>
              <tr class="accordion-toggle collapse in" data-toggle="collapse" data-target="#{!wrapper.parent.Period__c}-{!wrapper.parent.CurrencyISOCode}-period" data-filter="{!wrapper.parent.CurrencyIsoCode}">
                <td class="hidden-xs">
                  <apex:image styleClass="plus-sign collapse" value="{!URLFOR($Resource.ISSP_AccountStatements,'img/plus_sign.png')}" width="13" height="13"/>
                  <apex:image styleClass="minus-sign collapse" value="{!URLFOR($Resource.ISSP_AccountStatements,'img/minus_sign.png')}" width="13" height="13"/>
                </td>
                <td>
                  <apex:outputField value="{!wrapper.parent.Period__c}"/>
                </td>
                <td>
                  <apex:outputText value="{0,date,dd MMM yyyy}">
                    <apex:param value="{!wrapper.parent.Remittance_Date__c}" />
                  </apex:outputText>
                </td>
                <td>
                  <apex:outputText value="{!$Label.ISSP_Consolidated}" />
                </td>
                <td class="hidden-xs hidden-sm">
                                                <apex:outputText value="{!wrapper.parent.CurrencyIsoCode} {!IF(CONTAINS(currencyTreeValuesList,wrapper.parent.CurrencyIsoCode), '{0, number, ###,##0.000}', '{0, number, ###,##0.00}')}">
                  <apex:param value="{!wrapper.parent.Billing_Amount__c}"/>
                </apex:outputText>
              </td>
                <td class="hidden-xs hidden-sm">
                                                <apex:outputText value="{!wrapper.parent.CurrencyIsoCode} {!IF(CONTAINS(currencyTreeValuesList,wrapper.parent.CurrencyIsoCode), '{0, number, ###,##0.000}', '{0, number, ###,##0.00}')}">
                    <apex:param value="{!wrapper.ParentBillingAdjustment}"/>
                  </apex:outputText>
                </td>
                <td class="">
                                                <apex:outputText value="{!wrapper.parent.CurrencyIsoCode} {!IF(CONTAINS(currencyTreeValuesList,wrapper.parent.CurrencyIsoCode), '{0, number, ###,##0.000}', '{0, number, ###,##0.00}')}">
                    <apex:param value="{!wrapper.parent.Amount_to_be_Paid__c}"/>
                  </apex:outputText>
                </td>
                <td class="hidden-xs hidden-sm">
                                                <apex:outputText value="{!wrapper.parent.CurrencyIsoCode} {!IF(CONTAINS(currencyTreeValuesList,wrapper.parent.CurrencyIsoCode), '{0, number, ###,##0.000}', '{0, number, ###,##0.00}')}">
                    <apex:param value="{!wrapper.parent.Paid__c}"/>
                  </apex:outputText>
                </td>
                <td>
                                                <apex:outputText value="{!wrapper.parent.CurrencyIsoCode} {!IF(CONTAINS(currencyTreeValuesList,wrapper.parent.CurrencyIsoCode), '{0, number, ###,##0.000}', '{0, number, ###,##0.00}')}">
                    <apex:param value="{!wrapper.parent.Balance__c}"/>
                  </apex:outputText>
                </td>
                <td class="hidden-xs">
                  <apex:image value="{!URLFOR($Resource.ISSP_AccountStatements,'img/clock.png')}" title="{!$Label.ISSP_Last_updated_statement}" width="16" height="16" rendered="{!wrapper.lastUpdatedMark}"/>
                </td>
                <td class="{!IF(wrapper.ParentStatus==$Label.ISSP_Fullpayment,'success','')}{!IF(wrapper.ParentStatus==$Label.ISSP_Excess,'warning','')}{!IF(wrapper.ParentStatus==$Label.ISSP_Pending,'danger','')}">
                  <apex:outputText value="{!wrapper.ParentStatus}"/>
                </td>
                                            <!-- WMO358 Start 2018/11/02-->
                                            <td class="hidden-xs" >
                                                <!--Add proof of payment image from: "www.iconmonstr.com/paperclip-8-png/" -->
                                                <div >
                                                    <apex:commandbutton action="{!addAttachment}"
                                                                        image="{!URLFOR($Resource.AttachmentIcon)}"
                                                                        id="addAttachement"
                                                                        reRender="myModal"
                                                                        disabled="{!NOT(wrapper.ParentPaymentProof)}"
                                                                        rendered="{!wrapper.ParentPaymentProof}"
                                                                        onmouseup="startLoading(); return false;"
                                                                        oncomplete="stopLoading(); return false;"
                                                                        title="{!$Label.Add_an_attachment}">
                                                                            <apex:param name="account" value="{!wrapper.parent.Account__c}" assignTo="{!accountSelectedId}"/>
                                                                            <apex:param name="accountStatement" value="{!wrapper.accountSatementId}" assignTo="{!accountStatementSelectedId}"/>
                                                                            <apex:param name="accountName" value="{!wrapper.accountName}" assignTo="{!accountSelectedName}"/>
                                                                            <apex:param name="accountStatementPeriod" value="{!wrapper.parent.Period__c}" assignTo="{!accountStatementPeriod}"/>
                                                                            <apex:param name="accountStatementBillingAmount" value="{!wrapper.parent.Billing_Amount__c}" assignTo="{!billingAmount}"/>
                                                    </apex:commandbutton>
                                               </div>
                                            </td>
                                            <!--WMO358 End-->
              </tr>
              <!-- DETAIL TABLE-->
              <tr class="accordion-body collapse" id="{!wrapper.parent.Period__c}-{!wrapper.parent.CurrencyISOCode}-period">
                <td colspan="1" class="hidden-xs"></td>
                <td colspan="2"></td>
                <td colspan="6">
                  <apex:outputPanel rendered="{!wrapper.listStatements.size>0}">
                    <div>
                      <apex:pageBlockTable value="{!wrapper.listStatements}" var="statement" styleClass="table table-condensed table-pagination" headerClass="hidden">
                        <apex:column styleclass="text-width-xs">
                          <apex:outputField value="{!statement.Account__r.Site}"/>
                        </apex:column>

                        <apex:column styleclass="hidden-xs currency-width">
                                                        <apex:outputText value="{!statement.CurrencyIsoCode} {!IF(CONTAINS(currencyTreeValuesList,statement.CurrencyIsoCode), '{0, number, ###,##0.000}', '{0, number, ###,##0.00}')}">
                            <apex:param value="{!statement.Billing_Amount__c}"/>
                          </apex:outputText>
                        </apex:column>

                        <apex:column styleclass="hidden-xs currency-width">
                                                        <apex:outputText value="{!statement.CurrencyIsoCode} {!IF(CONTAINS(currencyTreeValuesList,statement.CurrencyIsoCode), '{0, number, ###,##0.000}', '{0, number, ###,##0.00}')}">
                            <apex:param value="{!statement.Billing_Amount__c-statement.Amount_to_be_Paid__c}"/>
                          </apex:outputText>
                        </apex:column>

                        <apex:column styleclass="hidden-xs currency-width">
                                                        <apex:outputText value="{!statement.CurrencyIsoCode} {!IF(CONTAINS(currencyTreeValuesList,statement.CurrencyIsoCode), '{0, number, ###,##0.000}', '{0, number, ###,##0.00}')}">
                            <apex:param value="{!statement.Amount_to_be_Paid__c}"/>
                          </apex:outputText>
                        </apex:column>

                        <apex:column styleclass="hidden-xs currency-width">
                                                        <apex:outputText value="{!statement.CurrencyIsoCode} {!IF(CONTAINS(currencyTreeValuesList,statement.CurrencyIsoCode), '{0, number, ###,##0.000}', '{0, number, ###,##0.00}')}">
                            <apex:param value="{!statement.Paid__c}"/>
                          </apex:outputText>
                        </apex:column>

                        <apex:column styleclass="currency-width">
                                                        <apex:outputText value="{!statement.CurrencyIsoCode} {!IF(CONTAINS(currencyTreeValuesList,statement.CurrencyIsoCode), '{0, number, ###,##0.000}', '{0, number, ###,##0.00}')}">
                            <apex:param value="{!statement.Balance__c}"/>
                          </apex:outputText>
                        </apex:column>
                      </apex:pageBlockTable>

                    </div>
                    <td colspan="1" class="hidden-xs"></td>
                    <td colspan="1"></td>
                  </apex:outputPanel>
                </td>
              </tr>
              <!-- END DETAIL TABLE -->
            </apex:repeat>
          </tbody>
          </table>
          </div>

          <apex:variable value="{!AND(account.Country_ISO_Code__c=='CN',account.Sector__c = 'Travel Agent')}" var="ChinaDisclaimer" />
          <div class="col-xs-12 small text-left">
            <p><apex:outputText value="{!$Label.ISSP_Account_Statements_Disclaimer}"></apex:outputText></p>
          </div>
          <div class="col-xs-12 small text-left">
            <p><apex:outputText value="{!$Label.ISSP_Account_Statements_Disclaimer_China_TravelAgent}" rendered="{!ChinaDisclaimer}"></apex:outputText></p>
          </div>

				</div>
			</div>

		</apex:pageBlock>

  </apex:form>

  <c:ISSP_CustomFooter />
</div>
</apex:page>